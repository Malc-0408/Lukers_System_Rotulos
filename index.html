<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lukers - Sistema de R√≥tulos v2.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e88e5 0%, #42a5f5 100%);
            min-height: 100vh;
            padding: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 30px rgba(0,0,0,0.3);
        }

        /* ============================================
           NUEVO HEADER COMPACTO
        ============================================ */
        .header-compact {
            background: linear-gradient(135deg, #1e88e5 0%, #42a5f5 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            position: relative;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-title {
            font-size: 1.4em;
            font-weight: bold;
        }

        .version-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75em;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-compact {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #dc3545;
        }

        .status-dot.connected {
            background: #28a745;
            box-shadow: 0 0 8px #28a745;
        }

        .user-menu-container {
            position: relative;
        }

        .user-menu-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .user-menu-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .user-menu-btn .arrow {
            transition: transform 0.3s;
        }

        .user-menu-btn.active .arrow {
            transform: rotate(180deg);
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            min-width: 320px;
            display: none;
            z-index: 1000;
            animation: slideDown 0.3s ease-out;
        }

        .dropdown-menu.active {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dropdown-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .dropdown-header h4 {
            color: #333;
            margin-bottom: 8px;
            font-size: 1em;
        }

        .dropdown-info {
            color: #666;
            font-size: 0.85em;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .dropdown-body {
            padding: 10px;
        }

        .dropdown-item {
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #333;
            text-decoration: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9em;
        }

        .dropdown-item:hover {
            background: #f0f0f0;
        }

        .dropdown-item.danger:hover {
            background: #fee;
            color: #dc3545;
        }

        .dropdown-divider {
            height: 1px;
            background: #eee;
            margin: 5px 0;
        }

        .admin-warning-small {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.8em;
            margin: 10px;
        }

        /* ============================================
           MODALES
        ============================================ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: fadeIn 0.3s;
        }

        .modal-overlay.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #1e88e5 0%, #42a5f5 100%);
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.2);
        }

        .modal-body {
            padding: 25px;
        }

        .security-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .config-section {
            padding: 0;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
            font-size: 0.9em;
        }

        .form-input, .form-select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            background: white;
            transition: border-color 0.3s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #1e88e5;
        }

        .form-input.error {
            border-color: #dc3545;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9em;
        }

        .btn-primary {
            background: #1e88e5;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #1565c0;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #5a6268;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-block {
            width: 100%;
        }

        .auth-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 5px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            margin-bottom: 15px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
        }

        .status-indicator.connected {
            background: #28a745;
            box-shadow: 0 0 5px #28a745;
        }

        /* ============================================
           CONTENIDO PRINCIPAL
        ============================================ */
        .main-content {
            padding: 30px;
            display: none;
        }

        .search-filter-section {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .search-controls {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 15px;
            align-items: end;
        }

        .search-input {
            padding: 12px;
            border: 2px solid #1e88e5;
            border-radius: 5px;
            font-size: 1em;
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: all 0.3s;
            color: #666;
        }

        .tab.active {
            background: #1e88e5;
            color: white;
        }

        .tab:hover:not(.active) {
            background: #e3f2fd;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .mode-selector {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .mode-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }

        .mode-btn {
            padding: 10px 20px;
            border: 2px solid #1e88e5;
            border-radius: 5px;
            background: white;
            color: #1e88e5;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .mode-btn.active {
            background: #1e88e5;
            color: white;
        }

        .proveedor-section {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .proveedor-label {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .proveedor-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1.1em;
            color: #333;
            background: white;
        }

        .selection-options {
            display: none;
            margin-top: 20px;
        }

        .option-tabs {
            display: flex;
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .option-tab {
            flex: 1;
            padding: 12px 10px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
            text-align: center;
            transition: all 0.3s;
            color: #666;
        }

        .option-tab.active {
            background: #1e88e5;
            color: white;
        }

        .option-content {
            display: none;
            background: #f9f9f9;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            min-height: 200px;
        }

        .option-content.active {
            display: block;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .checkbox-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }

        .checkbox-item {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            transition: background-color 0.2s;
        }

        .checkbox-item:hover {
            background-color: #f0f0f0;
        }

        .checkbox-item:last-child {
            border-bottom: none;
        }

        .checkbox-item input {
            margin-right: 10px;
            transform: scale(1.2);
            accent-color: #1e88e5;
        }

        .checkbox-item label {
            cursor: pointer;
            flex: 1;
        }

        .selection-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 5px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            flex-wrap: wrap;
        }

        .status-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .status-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1e88e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .spinner-overlay.active {
            display: flex;
        }

        .spinner-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
        }

        .rotulos-container {
            margin-top: 30px;
            display: none;
        }

        .rotulo-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
            transition: transform 0.2s;
        }

        .rotulo-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .rotulo-header {
            background: #1e88e5;
            color: white;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rotulo-actions {
            display: flex;
            gap: 10px;
        }

        .rotulo-content {
            padding: 20px;
        }

        .rotulo {
            max-width: 210mm;
            margin: 0 auto;
            background: white;
            border: 2px solid #333;
            font-family: Arial, sans-serif;
            color: black;
            padding: 3pt 12pt;
        }

        .rotulo-titulo {
            text-align: center;
            font-size: 14pt;
            font-weight: bold;
            padding: 0;
            margin: 0;
            background: white;
            color: black;
            border-bottom: none;
        }

        .rotulo-info-table {
            width: 571pt;
            margin: 0 auto;
            border-collapse: collapse;
            font-size: 9pt;
        }

        .rotulo-info-table td {
            border: 1pt solid #333333;
            padding: 2pt 5pt;
            vertical-align: middle;
            height: 20pt;
        }

        .rotulo-info-header {
            background: #4472C4;
            color: white;
            font-weight: bold;
            text-align: center;
            font-size: 11pt;
            width: 285pt;
        }

        .rotulo-ubicacion-header {
            background: #E74C3C;
            color: white;
            font-weight: bold;
            text-align: center;
            font-size: 11pt;
            width: 286pt;
        }

        .rotulo-data-table {
            width: 571pt;
            margin: 0 auto;
            border-collapse: collapse;
            font-size: 9pt;
        }

        .rotulo-data-table td {
            border: 0.5pt solid #666666;
            padding: 2pt 5pt;
            vertical-align: middle;
            height: 18pt;
        }

        .rotulo-data-col1 {
            width: 285pt;
        }

        .rotulo-data-col2 {
            width: 286pt;
            background: #FFFFFF;
        }

        .rotulo-section-title {
            text-align: center;
            font-size: 11pt;
            font-weight: bold;
            padding: 3pt 0;
            margin: 3pt 0;
        }

        .rotulo-producto-title {
            text-align: center;
            font-size: 10pt;
            font-weight: bold;
            padding: 2pt 0 1pt 0;
            margin: 0;
        }

        .rotulo-codigo-table {
            width: 571pt;
            margin: 0 auto;
            border-collapse: collapse;
            font-size: 9pt;
        }

        .rotulo-codigo-table td {
            padding: 2pt;
            vertical-align: middle;
            border: none;
        }

        .rotulo-codigo-col1 {
            width: 285pt;
        }

        .rotulo-codigo-col2 {
            width: 286pt;
            text-align: right;
        }

        .rotulo-tallas-table {
            width: 568pt;
            margin: 5pt auto;
            border-collapse: collapse;
            border: 1pt solid #333;
            font-size: 9pt;
        }

        .rotulo-tallas-table th {
            background: #F0F0F0;
            border: 1pt solid #333;
            padding: 1pt;
            text-align: center;
            font-size: 9pt;
            font-weight: bold;
            height: 20pt;
        }

        .rotulo-tallas-table .th-t1 {
            width: 45pt;
        }

        .rotulo-tallas-table .th-t2 {
            width: 45pt;
        }

        .rotulo-tallas-table .th-cant {
            width: 44pt;
        }

        .rotulo-tallas-table .th-sticker {
            width: 150pt;
        }

        .rotulo-tallas-table td {
            border: 1pt solid #333;
            padding: 1pt;
            text-align: center;
            height: 70pt;
            vertical-align: middle;
            font-size: 12pt;
        }

        .rotulo-sticker-col {
            background: #FFFFFF;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #1e88e5;
            text-align: center;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #1e88e5;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .history-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .history-item {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #1e88e5;
        }

        .history-info {
            flex: 1;
        }

        .history-timestamp {
            font-size: 0.8em;
            color: #666;
        }

        .export-section {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            
            .print-area, .print-area * {
                visibility: visible;
            }
            
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
            }
            
            .rotulo-header, .action-buttons {
                display: none !important;
            }
        }

        @media (max-width: 768px) {
            .header-compact {
                flex-direction: column;
                gap: 10px;
                padding: 10px 15px;
            }

            .header-right {
                width: 100%;
                justify-content: space-between;
            }

            .config-grid {
                grid-template-columns: 1fr;
            }
            
            .two-column {
                grid-template-columns: 1fr;
            }
            
            .tabs, .option-tabs {
                flex-direction: column;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .mode-buttons {
                flex-direction: column;
            }

            .search-controls {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .dropdown-menu {
                right: auto;
                left: 0;
                width: 100%;
                min-width: auto;
            }
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 10000;
            animation: slideUp 0.3s ease-out;
            display: none;
        }

        .toast.active {
            display: block;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .filter-badge {
            display: inline-block;
            background: #1e88e5;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            margin: 5px 5px 0 0;
        }

        .update-info {
            font-size: 0.85em;
            color: rgba(255,255,255,0.9);
        }
    </style>
</head>
<body>
    <div class="spinner-overlay" id="spinnerOverlay">
        <div class="spinner-content">
            <div class="loading" style="width: 60px; height: 60px; border-width: 6px;"></div>
            <p style="margin-top: 20px; font-weight: bold;">Procesando...</p>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <div class="container">
        <!-- ============================================
             NUEVO HEADER COMPACTO
        ============================================ -->
        <div class="header-compact">
            <div class="header-left">
                <div>
                    <div class="header-title">üì¶ SISTEMA DE R√ìTULOS LUKERS</div>
                    <div class="version-badge">v2.0 - Optimizado</div>
                </div>
            </div>
            <div class="header-right">
                <div class="status-compact">
                    <div id="statusDotCompact" class="status-dot"></div>
                    <span id="statusTextCompact">Sin autenticar</span>
                </div>
                <div class="update-info" id="updateInfoCompact" style="display: none;">
                    √ölt. act: <strong id="updateTimestampCompact">-</strong>
                </div>
                <div class="user-menu-container">
                    <button class="user-menu-btn" id="userMenuBtn" onclick="App.UI.toggleUserMenu()">
                        <span>‚öôÔ∏è MEN√ö</span>
                        <span class="arrow">‚ñº</span>
                    </button>
                    <div class="dropdown-menu" id="userDropdown">
                        <div class="admin-warning-small">
                            <strong>‚ÑπÔ∏è Aviso:</strong> Solo el administrador puede configurar credenciales.
                        </div>
                        <div class="dropdown-header">
                            <h4 id="dropdownTitle">Estado del Sistema</h4>
                            <div class="dropdown-info">
                                <div id="dropdownAuthStatus">üî¥ No autenticado</div>
                                <div id="dropdownLastUpdate" style="display: none;">√öltima actualizaci√≥n: <strong id="dropdownTimestamp">-</strong></div>
                            </div>
                        </div>
                        <div class="dropdown-body">
                            <div id="dropdownUserActions" style="display: none;">
                                <div class="dropdown-item" onclick="App.Data.refreshData()">
                                    üîÑ Refrescar Datos
                                </div>
                                <div class="dropdown-divider"></div>
                                <div class="dropdown-item danger" onclick="App.Auth.signOut()">
                                    üî¥ Cerrar Sesi√≥n
                                </div>
                            </div>
                            <div id="dropdownGuestActions">
                                <div class="dropdown-item" id="dropdownSignInBtn" onclick="App.Auth.signIn()">
                                    üü¢ Iniciar Sesi√≥n con Google
                                </div>
                                <div class="dropdown-divider"></div>
                                <div class="dropdown-item" onclick="App.Auth.showAdminLoginModal()">
                                    üîê Acceso Administrador
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================
             MODAL DE LOGIN ADMINISTRADOR
        ============================================ -->
        <div class="modal-overlay" id="adminLoginModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>üîê Acceso Administrador</h3>
                    <button class="modal-close" onclick="App.UI.closeModal('adminLoginModal')">√ó</button>
                </div>
                <div class="modal-body">
                    <p style="color: #666; margin-bottom: 20px;">Se requiere acceso administrativo para configurar las credenciales del sistema</p>
                    <div class="form-group">
                        <label class="form-label" for="adminUser">Usuario Administrador:</label>
                        <input type="text" id="adminUser" class="form-input" placeholder="Usuario admin" autocomplete="username">
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label class="form-label" for="adminPass">Contrase√±a:</label>
                        <input type="password" id="adminPass" class="form-input" placeholder="Contrase√±a" autocomplete="current-password">
                    </div>
                    <button class="btn btn-primary btn-block" onclick="App.Auth.adminLogin()" style="margin-top: 20px;">ACCEDER</button>
                </div>
            </div>
        </div>

        <!-- ============================================
             MODAL DE CONFIGURACI√ìN
        ============================================ -->
        <div class="modal-overlay" id="configModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>‚öôÔ∏è Configuraci√≥n del Sistema</h3>
                    <button class="modal-close" onclick="App.UI.closeModal('configModal')">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="security-warning">
                        <strong>‚ö†Ô∏è Advertencia de Seguridad:</strong> Estas credenciales se guardar√°n en el navegador del usuario. Solo config√∫relas si conf√≠a en este dispositivo.
                    </div>
                    
                    <div class="config-section">
                        <h4 style="margin-bottom: 15px; color: #333;">Credenciales de Google Sheets</h4>
                        <div class="config-grid">
                            <div class="form-group">
                                <label class="form-label" for="clientId">Google OAuth Client ID:</label>
                                <input type="text" id="clientId" class="form-input" placeholder="xxxxxx.apps.googleusercontent.com" maxlength="200" aria-required="true">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="spreadsheetId">ID de la Hoja de C√°lculo:</label>
                                <input type="text" id="spreadsheetId" class="form-input" placeholder="ID del Google Sheets" maxlength="100" aria-required="true">
                            </div>
                        </div>
                        <button class="btn btn-success btn-block" onclick="App.Auth.saveConfig()">üíæ GUARDAR CONFIGURACI√ìN</button>

                        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd;">
                            <h4 style="margin-bottom: 15px; color: #333;">Estado de Autenticaci√≥n</h4>
                            <div class="auth-status" role="status" aria-live="polite">
                                <div id="statusIndicatorAdmin" class="status-indicator disconnected" aria-hidden="true"></div>
                                <span id="authStatusAdmin">No autenticado</span>
                            </div>
                            <button id="signInBtnAdmin" class="btn btn-primary btn-block" onclick="App.Auth.signInAdmin()" disabled aria-label="Iniciar sesi√≥n con Google">INICIAR SESI√ìN CON GOOGLE</button>
                            <button id="signOutBtnAdmin" class="btn btn-danger btn-block" onclick="App.Auth.signOutAdmin()" style="display: none;" aria-label="Cerrar sesi√≥n">CERRAR SESI√ìN</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================
             CONTENIDO PRINCIPAL
        ============================================ -->
        <div id="mainContent" class="main-content">
            <div class="mode-selector" style="margin-top: 0;">
                <h3 style="margin: 0 0 10px 0;">Tipo de R√≥tulo</h3>
                <div class="mode-buttons">
                    <button class="mode-btn active" data-mode="original" aria-pressed="true">R√ìTULO ORIGINAL</button>
                    <button class="mode-btn" data-mode="concodigo" aria-pressed="false">R√ìTULO CON C√ìDIGO + COLOR</button>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="App.UI.switchTab(event, 'generator')" role="tab" aria-selected="true">GENERADOR DE R√ìTULOS</button>
                <button class="tab" onclick="App.UI.switchTab(event, 'analysis')" role="tab" aria-selected="false">AN√ÅLISIS</button>
                <button class="tab" onclick="App.UI.switchTab(event, 'history')" role="tab" aria-selected="false">HISTORIAL</button>
            </div>

            <div id="generatorTab" class="tab-content active" role="tabpanel">
                <div class="proveedor-section">
                    <div class="proveedor-label">SELECCIONAR PROVEEDOR</div>
                    <select class="proveedor-select" id="proveedorSelect" aria-label="Seleccionar proveedor">
                        <option value="">-- Selecciona un proveedor --</option>
                    </select>
                </div>

                <div id="selectionOptions" class="selection-options">
                    <div class="option-tabs" role="tablist">
                        <button class="option-tab active" onclick="App.UI.switchOption(1)" role="tab" aria-selected="true">SELECCI√ìN DIRECTA</button>
                        <button class="option-tab" onclick="App.UI.switchOption(2)" role="tab" aria-selected="false">POR INTERVALO</button>
                        <button class="option-tab" onclick="App.UI.switchOption(3)" role="tab" aria-selected="false">LISTA M√öLTIPLE</button>
                    </div>

                    <div class="option-content active" id="option1" role="tabpanel">
                        <div class="two-column">
                            <div class="form-group">
                                <label class="form-label" for="parihuela1">Parihuela:</label>
                                <select class="form-select" id="parihuela1" aria-label="Seleccionar parihuela">
                                    <option value="">-- Selecciona parihuela --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="caja1">Caja:</label>
                                <select class="form-select" id="caja1" aria-label="Seleccionar caja">
                                    <option value="">-- Selecciona caja --</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="option-content" id="option2" role="tabpanel">
                        <div class="form-group">
                            <label class="form-label" for="parihuela2">Parihuela:</label>
                            <select class="form-select" id="parihuela2" aria-label="Seleccionar parihuela">
                                <option value="">-- Selecciona parihuela --</option>
                            </select>
                        </div>
                        <div class="two-column">
                            <div class="form-group">
                                <label class="form-label" for="cajaDesde">Caja Desde:</label>
                                <select class="form-select" id="cajaDesde" aria-label="Caja inicial">
                                    <option value="">-- Caja inicial --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="cajaHasta">Caja Hasta:</label>
                                <select class="form-select" id="cajaHasta" aria-label="Caja final">
                                    <option value="">-- Caja final --</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="option-content" id="option3" role="tabpanel">
                        <div class="form-group">
                            <label class="form-label">Selecciona las combinaciones:</label>
                            <div class="selection-controls">
                                <div>
                                    <button type="button" class="btn btn-primary" onclick="App.UI.selectAll()">SELECCIONAR TODOS</button>
                                    <button type="button" class="btn btn-secondary" onclick="App.UI.selectNone()">DESELECCIONAR</button>
                                </div>
                                <div id="selectionCounter" role="status" aria-live="polite">0 elementos seleccionados</div>
                            </div>
                            <div class="checkbox-list" id="checkboxList" role="group" aria-label="Lista de combinaciones"></div>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button id="generateBtn" class="btn btn-success" onclick="App.generateLabels()">GENERAR VISTA PREVIA</button>
                        <button id="clearBtn" class="btn btn-secondary" onclick="App.clearLabels()">LIMPIAR VISTA</button>
                        <button id="exportAllPdfBtn" class="btn btn-primary" onclick="App.Export.exportAllToPDF()" style="display: none;">EXPORTAR TODO A PDF</button>
                        <button id="printAllBtn" class="btn btn-primary" onclick="App.printAll()" style="display: none;">IMPRIMIR TODOS</button>
                    </div>
                </div>

                <div id="statusMessage" class="status-message" role="alert"></div>

                <div id="rotulosContainer" class="rotulos-container">
                    <h3>R√≥tulos Generados (<span id="labelCount">0</span>)</h3>
                    <div id="rotulosList"></div>
                </div>
            </div>

            <div id="analysisTab" class="tab-content" role="tabpanel">
                <h3>An√°lisis de Datos</h3>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="App.Analysis.analyze()">ANALIZAR CLASIFICACI√ìN</button>
                    <button class="btn btn-secondary" onclick="App.Analysis.exportAnalysis()">EXPORTAR AN√ÅLISIS</button>
                </div>
                <div id="analysisResults"></div>
            </div>

            <div id="historyTab" class="tab-content" role="tabpanel">
                <h3>Historial de R√≥tulos Generados</h3>
                <div class="action-buttons">
                    <button class="btn btn-danger" onclick="App.History.clear()">LIMPIAR HISTORIAL</button>
                </div>
                <div class="history-section" id="historyList"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        const App = (function() {
            const state = {
                gapiInited: false,
                gisInited: false,
                tokenClient: null,
                spreadsheetId: '',
                clientId: '',
                data: null,
                activeOption: 1,
                activeMode: 'original',
                generatedLabels: [],
                dataIndex: null,
                lastUpdate: null,
                isAdminLogged: false
            };

            const Config = {
                DISCOVERY_DOC: 'https://sheets.googleapis.com/$discovery/rest?version=v4',
                SCOPES: 'https://www.googleapis.com/auth/spreadsheets.readonly',
                RANGE: 'Clasificaci√≥n!A:Z',
                ADMIN_USER: 'mluzquinos',
                ADMIN_PASS: 'Malc-0408'
            };

            window.gapiLoaded = function() {
                console.log('GAPI loaded');
                gapi.load('client', Auth.initializeGapiClient);
            };

            window.gisLoaded = function() {
                console.log('GIS loaded');
                state.gisInited = true;
                maybeEnableButtons();
            };

            function maybeEnableButtons() {
                if (state.gapiInited && state.gisInited) {
                    const dropdownSignInBtn = document.getElementById('dropdownSignInBtn');
                    if (dropdownSignInBtn) {
                        dropdownSignInBtn.style.pointerEvents = 'auto';
                        dropdownSignInBtn.style.opacity = '1';
                    }
                }
            }

            const Auth = {
                async initializeGapiClient() {
                    try {
                        await gapi.client.init({
                            discoveryDocs: [Config.DISCOVERY_DOC],
                        });
                        state.gapiInited = true;
                        maybeEnableButtons();
                        Auth.checkSavedConfig();
                    } catch (error) {
                        UI.showStatus('Error inicializando Google API', 'error');
                        console.error(error);
                    }
                },

                checkSavedConfig() {
                    try {
                        const savedClientId = localStorage.getItem('lukers_client_id');
                        const savedSpreadsheetId = localStorage.getItem('lukers_spreadsheet_id');
                        
                        if (savedClientId && savedSpreadsheetId) {
                            state.clientId = atob(savedClientId);
                            state.spreadsheetId = atob(savedSpreadsheetId);
                            UI.updateCompactStatus(false, 'Sistema configurado');
                        } else {
                            UI.updateCompactStatus(false, 'Sin configurar');
                        }
                    } catch (e) {
                        console.warn('Error verificando configuraci√≥n:', e);
                        UI.updateCompactStatus(false, 'Sin configurar');
                    }
                },

                showAdminLoginModal() {
                    UI.openModal('adminLoginModal');
                    UI.closeUserMenu();
                },

                adminLogin() {
                    const user = document.getElementById('adminUser').value.trim().toLowerCase();
                    const pass = document.getElementById('adminPass').value;

                    if (user === Config.ADMIN_USER && pass === Config.ADMIN_PASS) {
                        state.isAdminLogged = true;
                        
                        UI.closeModal('adminLoginModal');
                        Auth.loadConfigToFields();
                        UI.openModal('configModal');
                        
                        UI.showToast('‚úì Acceso administrativo concedido');
                    } else {
                        UI.showStatus('Usuario o contrase√±a incorrectos', 'error');
                        document.getElementById('adminPass').value = '';
                    }
                },

                loadConfigToFields() {
                    try {
                        const savedClientId = localStorage.getItem('lukers_client_id');
                        const savedSpreadsheetId = localStorage.getItem('lukers_spreadsheet_id');
                        
                        if (savedClientId && savedSpreadsheetId) {
                            document.getElementById('clientId').value = atob(savedClientId);
                            document.getElementById('spreadsheetId').value = atob(savedSpreadsheetId);
                        }
                    } catch (e) {
                        console.warn('Error cargando configuraci√≥n:', e);
                    }
                },

                saveConfig() {
                    const clientId = document.getElementById('clientId').value.trim();
                    const spreadsheetId = document.getElementById('spreadsheetId').value.trim();

                    if (!Validation.validateClientId(clientId) || !Validation.validateSpreadsheetId(spreadsheetId)) {
                        UI.showStatus('Por favor completa los campos correctamente', 'error');
                        return;
                    }

                    try {
                        localStorage.setItem('lukers_client_id', btoa(clientId));
                        localStorage.setItem('lukers_spreadsheet_id', btoa(spreadsheetId));
                        
                        state.clientId = clientId;
                        state.spreadsheetId = spreadsheetId;
                        
                        UI.showStatus('Configuraci√≥n guardada correctamente', 'success');
                        UI.showToast('‚úì Credenciales guardadas exitosamente');
                        
                        setTimeout(() => {
                            UI.closeModal('configModal');
                            UI.updateCompactStatus(false, 'Configurado - Inicie sesi√≥n');
                        }, 1500);
                        
                    } catch (e) {
                        UI.showStatus('Error guardando configuraci√≥n: ' + e.message, 'error');
                    }
                },

                signIn() {
                    const clientId = state.clientId;
                    const spreadsheetId = state.spreadsheetId;

                    if (!clientId || !spreadsheetId) {
                        UI.showStatus('Error: No hay credenciales configuradas', 'error');
                        UI.showToast('‚ö†Ô∏è Configure primero las credenciales');
                        return;
                    }

                    try {
                        state.tokenClient = google.accounts.oauth2.initTokenClient({
                            client_id: clientId,
                            scope: Config.SCOPES,
                            callback: Auth.handleAuthSuccess,
                            error_callback: Auth.handleAuthError
                        });

                        state.tokenClient.requestAccessToken({ prompt: 'consent' });
                    } catch (error) {
                        UI.showStatus('Error configurando autenticaci√≥n: ' + error.message, 'error');
                    }
                },

                signInAdmin() {
                    const clientId = document.getElementById('clientId').value.trim();
                    const spreadsheetId = document.getElementById('spreadsheetId').value.trim();

                    if (!Validation.validateClientId(clientId)) {
                        UI.showStatus('Por favor ingresa un Client ID v√°lido', 'error');
                        return;
                    }

                    if (!Validation.validateSpreadsheetId(spreadsheetId)) {
                        UI.showStatus('Por favor ingresa un ID de hoja v√°lido', 'error');
                        return;
                    }

                    state.spreadsheetId = spreadsheetId;

                    try {
                        state.tokenClient = google.accounts.oauth2.initTokenClient({
                            client_id: clientId,
                            scope: Config.SCOPES,
                            callback: Auth.handleAuthSuccessAdmin,
                            error_callback: Auth.handleAuthError
                        });

                        state.tokenClient.requestAccessToken({ prompt: 'consent' });
                    } catch (error) {
                        UI.showStatus('Error configurando autenticaci√≥n: ' + error.message, 'error');
                    }
                },

                handleAuthSuccess(resp) {
                    if (resp.error !== undefined) {
                        UI.showStatus('Error de autenticaci√≥n: ' + resp.error, 'error');
                        return;
                    }

                    UI.updateAuthStatus(true, false);
                    UI.updateCompactStatus(true, 'Autenticado');
                    UI.showStatus('Autenticaci√≥n exitosa', 'success');
                    UI.showToast('‚úì Conectado a Google Sheets');
                    UI.closeUserMenu();
                    document.getElementById('mainContent').style.display = 'block';
                    Data.loadProviders();
                },

                handleAuthSuccessAdmin(resp) {
                    if (resp.error !== undefined) {
                        UI.showStatus('Error de autenticaci√≥n: ' + resp.error, 'error');
                        return;
                    }

                    UI.updateAuthStatus(true, true);
                    UI.updateCompactStatus(true, 'Autenticado (Admin)');
                    UI.showStatus('Autenticaci√≥n exitosa (Admin)', 'success');
                    UI.showToast('‚úì Conectado a Google Sheets (Admin)');
                    document.getElementById('mainContent').style.display = 'block';
                    Data.loadProviders();
                },

                handleAuthError(error) {
                    let userMessage = 'Error de autenticaci√≥n: ';
                    
                    switch(error.type) {
                        case 'popup_closed':
                            userMessage += 'Ventana cerrada por el usuario';
                            break;
                        case 'popup_blocked':
                            userMessage += 'Popup bloqueado. Habilita popups para este sitio';
                            break;
                        case 'access_denied':
                            userMessage += 'Acceso denegado. Acepta los permisos requeridos';
                            break;
                        default:
                            userMessage += error.message || 'Error desconocido';
                    }
                    
                    UI.showStatus(userMessage, 'error');
                },

                signOut() {
                    const token = gapi.client.getToken();
                    if (token !== null) {
                        google.accounts.oauth2.revoke(token.access_token);
                        gapi.client.setToken('');
                    }
                    UI.updateAuthStatus(false, false);
                    UI.updateCompactStatus(false, 'Sesi√≥n cerrada');
                    UI.showStatus('Sesi√≥n cerrada', 'success');
                    UI.showToast('Sesi√≥n cerrada correctamente');
                    UI.closeUserMenu();
                    document.getElementById('mainContent').style.display = 'none';
                    state.data = null;
                    state.dataIndex = null;
                },

                signOutAdmin() {
                    const token = gapi.client.getToken();
                    if (token !== null) {
                        google.accounts.oauth2.revoke(token.access_token);
                        gapi.client.setToken('');
                    }
                    UI.updateAuthStatus(false, true);
                    UI.showStatus('Sesi√≥n cerrada', 'success');
                    document.getElementById('mainContent').style.display = 'none';
                    state.data = null;
                    state.dataIndex = null;
                }
            };

            const Validation = {
                validateClientId(clientId) {
                    return clientId && clientId.includes('.apps.googleusercontent.com');
                },

                validateSpreadsheetId(spreadsheetId) {
                    return spreadsheetId && spreadsheetId.length > 10;
                },

                validateRange(desde, hasta) {
                    return parseInt(desde) <= parseInt(hasta);
                }
            };

            const Data = {
                async loadProviders() {
                    try {
                        UI.showSpinner(true);
                        UI.showStatus('Cargando datos...', 'success');

                        const response = await gapi.client.sheets.spreadsheets.values.get({
                            spreadsheetId: state.spreadsheetId,
                            range: Config.RANGE
                        });

                        const values = response.result.values;
                        if (!values || values.length <= 1) {
                            UI.showStatus('No hay datos en la hoja', 'warning');
                            return;
                        }

                        const processedData = Data.processData(values);
                        state.data = processedData;
                        state.dataIndex = Data.createIndex(processedData);

                        const now = new Date();
                        state.lastUpdate = now.toISOString();
                        const timeStr = now.toLocaleString('es-ES');
                        
                        document.getElementById('updateTimestampCompact').textContent = timeStr;
                        document.getElementById('updateInfoCompact').style.display = 'block';
                        document.getElementById('dropdownTimestamp').textContent = timeStr;
                        document.getElementById('dropdownLastUpdate').style.display = 'block';

                        UI.populateProviders(processedData.providers);
                        UI.showStatus(`Datos cargados: ${processedData.providers.length} proveedores`, 'success');
                        UI.showToast('‚úì Datos cargados correctamente');

                    } catch (error) {
                        console.error('Error cargando datos:', error);
                        UI.showStatus('Error: ' + error.message, 'error');
                    } finally {
                        UI.showSpinner(false);
                    }
                },

                async refreshData() {
                    if (confirm('¬øDeseas recargar los datos desde Google Sheets? Se perder√°n las selecciones actuales.')) {
                        document.getElementById('proveedorSelect').value = '';
                        document.getElementById('selectionOptions').style.display = 'none';
                        
                        await Data.loadProviders();
                        UI.showToast('‚úì Datos actualizados');
                        UI.closeUserMenu();
                    }
                },

                processData(values) {
                    const headers = values[0];
                    const cols = {};
                    headers.forEach((header, index) => {
                        cols[header] = index;
                    });

                    const requiredCols = ['PARIHUELA', 'CAJA', 'ID Proveedor', 'GENERO'];
                    for (const col of requiredCols) {
                        if (cols[col] === undefined) {
                            throw new Error(`Columna requerida "${col}" no encontrada`);
                        }
                    }

                    const providers = new Set();
                    const generos = new Set();
                    const combinationsByProvider = {};

                    for (let i = 1; i < values.length; i++) {
                        const row = values[i];
                        const provider = String(row[cols['ID Proveedor']] || '').trim();
                        const parihuela = String(row[cols['PARIHUELA']] || '').trim();
                        const caja = String(row[cols['CAJA']] || '').trim();
                        const genero = String(row[cols['GENERO']] || '').trim();

                        if (provider && parihuela && caja) {
                            providers.add(provider);
                            if (genero) generos.add(genero);

                            if (!combinationsByProvider[provider]) {
                                combinationsByProvider[provider] = new Set();
                            }
                            combinationsByProvider[provider].add(`${parihuela}|${caja}`);
                        }
                    }

                    const processedCombinations = {};
                    for (const [provider, combos] of Object.entries(combinationsByProvider)) {
                        processedCombinations[provider] = Array.from(combos)
                            .map(combo => {
                                const [parihuela, caja] = combo.split('|');
                                return { parihuela, caja };
                            })
                            .sort((a, b) => {
                                const diffP = parseInt(a.parihuela) - parseInt(b.parihuela);
                                return diffP !== 0 ? diffP : parseInt(a.caja) - parseInt(b.caja);
                            });
                    }

                    return {
                        values,
                        cols,
                        providers: Array.from(providers).sort(),
                        generos: Array.from(generos).sort(),
                        combinationsByProvider: processedCombinations
                    };
                },

                createIndex(data) {
                    const index = {
                        byProvider: {},
                        byGenero: {},
                        byDescripcion: {}
                    };

                    for (let i = 1; i < data.values.length; i++) {
                        const row = data.values[i];
                        const provider = String(row[data.cols['ID Proveedor']] || '').trim();
                        const genero = String(row[data.cols['GENERO']] || '').trim();
                        const descripcion = String(row[data.cols['DESCRIPCI√ìN']] || '').trim();

                        if (!index.byProvider[provider]) index.byProvider[provider] = [];
                        index.byProvider[provider].push(i);

                        if (genero) {
                            if (!index.byGenero[genero]) index.byGenero[genero] = [];
                            index.byGenero[genero].push(i);
                        }

                        if (descripcion) {
                            const key = descripcion.toLowerCase();
                            if (!index.byDescripcion[key]) index.byDescripcion[key] = [];
                            index.byDescripcion[key].push(i);
                        }
                    }

                    return index;
                },

                filterData(selection) {
                    const filtered = [];
                    const rows = state.dataIndex.byProvider[selection.proveedor] || [];

                    for (const rowIndex of rows) {
                        const row = state.data.values[rowIndex];
                        const parihuela = String(row[state.data.cols['PARIHUELA']] || '').trim();
                        const caja = String(row[state.data.cols['CAJA']] || '').trim();

                        if (parihuela === selection.parihuela && caja === selection.caja) {
                            filtered.push(row);
                        }
                    }

                    return filtered;
                }
            };

            const LabelGenerator = {
                async generate(selections) {
                    state.generatedLabels = [];
                    const container = document.getElementById('rotulosList');
                    container.innerHTML = '';

                    let count = 0;

                    for (const selection of selections) {
                        try {
                            const label = await LabelGenerator.generateSingle(selection);
                            if (label) {
                                state.generatedLabels.push({
                                    selection,
                                    html: label.html,
                                    timestamp: new Date().toISOString()
                                });
                                container.appendChild(label.element);
                                count++;
                            }
                        } catch (error) {
                            console.error('Error generando r√≥tulo:', error);
                        }
                    }

                    History.addBatch(state.generatedLabels);
                    return count;
                },

                async generateSingle(selection) {
                    const filtered = Data.filterData(selection);
                    
                    if (filtered.length === 0) {
                        throw new Error('No hay datos para esta selecci√≥n');
                    }

                    const groups = LabelGenerator.groupData(filtered);
                    
                    if (Object.keys(groups).length === 0) {
                        throw new Error('No se pudieron agrupar los datos');
                    }

                    return LabelGenerator.buildLabelHTML(selection, groups);
                },

                groupData(rows) {
                    const groups = {};
                    const cols = state.data.cols;
                    
                    for (const row of rows) {
                        const keyParts = [
                            String(row[cols['DESCRIPCI√ìN']] || '').trim(),
                            String(row[cols['MUNDO']] || '').trim(),
                            String(row[cols['MARCA']] || '').trim(),
                            String(row[cols['GENERO']] || '').trim(),
                            String(row[cols['PARIHUELA']] || '').trim(),
                            String(row[cols['CAJA']] || '').trim()
                        ];

                        if (state.activeMode === 'concodigo') {
                            keyParts.push(
                                String(row[cols['CODIGO']] || '').trim(),
                                String(row[cols['COLOR']] || '').trim()
                            );
                        }

                        const key = keyParts.join('|');
                        
                        if (!groups[key]) {
                            groups[key] = {
                                info: {
                                    proveedor: row[cols['ID Proveedor']] || '',
                                    marca: row[cols['MARCA']] || '',
                                    genero: row[cols['GENERO']] || '',
                                    descripcion: row[cols['DESCRIPCI√ìN']] || '',
                                    mundo: row[cols['MUNDO']] || '',
                                    parihuela: row[cols['PARIHUELA']] || '',
                                    caja: row[cols['CAJA']] || '',
                                    codigo: row[cols['CODIGO']] || '',
                                    color: row[cols['COLOR']] || '',
                                    validador: row[cols['VALIDADOR']] || ''
                                },
                                tallas: []
                            };
                        }
                        
                        const talla1 = String(row[cols['TALLA 1']] || '').trim();
                        const talla2 = String(row[cols['TALLA 2']] || '').trim();
                        const cantidad = String(row[cols['CANTIDAD']] || '').trim();
                        
                        if (talla1 || talla2 || cantidad) {
                            const existing = groups[key].tallas.find(t =>
                                String(t.talla1).trim() === talla1 && 
                                String(t.talla2).trim() === talla2
                            );
                            
                            if (existing) {
                                existing.cantidad = (parseFloat(existing.cantidad) || 0) + (parseFloat(cantidad) || 0);
                            } else {
                                groups[key].tallas.push({ talla1, talla2, cantidad });
                            }
                        }
                    }
                    
                    return groups;
                },

                buildLabelHTML(selection, groups) {
                    const card = document.createElement('div');
                    card.className = 'rotulo-card';

                    const tipoTexto = state.activeMode === 'original' ? 'Original' : 'Con C√≥digo + Color';
                    
                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'rotulo-header';
                    headerDiv.innerHTML = `
                        <h4>R√≥tulo ${tipoTexto} - P${selection.parihuela} C${selection.caja} (${selection.proveedor})</h4>
                        <div class="rotulo-actions">
                            <button class="btn btn-primary" onclick="App.printSingle(this)" aria-label="Imprimir r√≥tulo">IMPRIMIR</button>
                            <button class="btn btn-success" onclick="App.Export.exportSingleToPDF(this)" aria-label="Exportar a PDF">PDF</button>
                        </div>
                    `;

                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'rotulo-content print-area';
                    contentDiv.innerHTML = LabelGenerator.buildContent(selection, groups);

                    card.appendChild(headerDiv);
                    card.appendChild(contentDiv);

                    return {
                        element: card,
                        html: card.outerHTML
                    };
                },

                buildContent(selection, groups) {
                    const totalStock = LabelGenerator.calculateTotalStock(groups);
                    const fecha = new Date().toLocaleDateString('es-ES', { month: '2-digit', year: 'numeric' });
                    const validador = LabelGenerator.getValidator(groups);

                    let html = `
                        <div class="rotulo">
                            <div class="rotulo-titulo">üì¶ R√ìTULO DE CAJA - ALMAC√âN RD50 üì¶</div>
                            <table class="rotulo-info-table">
                                <tr>
                                    <td class="rotulo-info-header">INFORMACI√ìN DE LA CAJA</td>
                                    <td class="rotulo-ubicacion-header">UBICACI√ìN DEL PRODUCTO</td>
                                </tr>
                            </table>
                            <table class="rotulo-data-table">
                                <tr>
                                    <td class="rotulo-data-col1">Proveedor: ${Utils.escapeHtml(selection.proveedor)}</td>
                                    <td class="rotulo-data-col2">Parihuela: ${Utils.escapeHtml(selection.parihuela)}</td>
                                </tr>
                                <tr>
                                    <td class="rotulo-data-col1">Validador: ${Utils.escapeHtml(validador)}</td>
                                    <td class="rotulo-data-col2">Caja: ${Utils.escapeHtml(selection.caja)}</td>
                                </tr>
                                <tr>
                                    <td class="rotulo-data-col1">Fecha: ${fecha}</td>
                                    <td class="rotulo-data-col2">Total Stock: ${totalStock}</td>
                                </tr>
                            </table>
                    `;

                    const byGenero = LabelGenerator.groupByGenero(groups);

                    for (const [genero, items] of Object.entries(byGenero)) {
                        html += `<div class="rotulo-section-title">=== ${Utils.escapeHtml(genero)} ===</div>`;

                        const uniqueProducts = LabelGenerator.groupUniqueProducts(items);

                        for (const product of Object.values(uniqueProducts)) {
                            html += `<div class="rotulo-producto-title">‚ñ∏ ${Utils.escapeHtml(product.descripcion)} | ${Utils.escapeHtml(product.mundo)} | ${Utils.escapeHtml(product.marca)}</div>`;

                            if (state.activeMode === 'concodigo' && (product.codigo || product.color)) {
                                html += `
                                    <table class="rotulo-codigo-table">
                                        <tr>
                                            <td class="rotulo-codigo-col1">C√ìDIGO: ${Utils.escapeHtml(product.codigo || 'N/A')}</td>
                                            <td class="rotulo-codigo-col2">COLOR: ${Utils.escapeHtml(product.color || 'N/A')}</td>
                                        </tr>
                                    </table>
                                `;
                            }

                            html += LabelGenerator.buildSizesTable(product.tallas);
                        }
                    }

                    html += '</div>';
                    return html;
                },

                buildSizesTable(tallas) {
                    let html = `
                        <table class="rotulo-tallas-table">
                            <tr>
                                <th class="th-t1">T-1</th>
                                <th class="th-t2">T-2</th>
                                <th class="th-cant">CANT</th>
                                <th class="th-sticker">Sticker</th>
                                <th class="th-t1">T-1</th>
                                <th class="th-t2">T-2</th>
                                <th class="th-cant">CANT</th>
                                <th class="th-sticker">Sticker</th>
                            </tr>
                    `;

                    if (tallas.length === 0) {
                        html += '<tr><td>-</td><td>-</td><td>-</td><td class="rotulo-sticker-col"> </td><td>-</td><td>-</td><td>-</td><td class="rotulo-sticker-col"> </td></tr>';
                    } else {
                        for (let i = 0; i < tallas.length; i += 2) {
                            const t1 = tallas[i];
                            const t2 = i + 1 < tallas.length ? tallas[i + 1] : null;

                            html += '<tr>';
                            html += `<td>${Utils.escapeHtml(t1.talla1 || '-')}</td>`;
                            html += `<td>${Utils.escapeHtml(t1.talla2 || '-')}</td>`;
                            html += `<td>${Utils.escapeHtml(t1.cantidad || '0')}</td>`;
                            html += '<td class="rotulo-sticker-col"> </td>';
                            
                            if (t2) {
                                html += `<td>${Utils.escapeHtml(t2.talla1 || '-')}</td>`;
                                html += `<td>${Utils.escapeHtml(t2.talla2 || '-')}</td>`;
                                html += `<td>${Utils.escapeHtml(t2.cantidad || '0')}</td>`;
                                html += '<td class="rotulo-sticker-col"> </td>';
                            } else {
                                html += '<td> </td><td> </td><td> </td><td class="rotulo-sticker-col"> </td>';
                            }
                            
                            html += '</tr>';
                        }
                    }

                    html += '</table>';
                    return html;
                },

                groupByGenero(groups) {
                    const byGenero = {};
                    
                    for (const group of Object.values(groups)) {
                        const genero = group.info.genero || 'SIN G√âNERO';
                        if (!byGenero[genero]) byGenero[genero] = [];
                        byGenero[genero].push(group);
                    }
                    
                    return byGenero;
                },

                groupUniqueProducts(items) {
                    const unique = {};
                    
                    for (const item of items) {
                        const keyParts = [
                            item.info.descripcion,
                            item.info.mundo,
                            item.info.marca
                        ];

                        if (state.activeMode === 'concodigo') {
                            keyParts.push(item.info.codigo, item.info.color);
                        }

                        const key = keyParts.join('|');
                        
                        if (!unique[key]) {
                            unique[key] = {
                                descripcion: item.info.descripcion,
                                mundo: item.info.mundo,
                                marca: item.info.marca,
                                codigo: item.info.codigo,
                                color: item.info.color,
                                tallas: []
                            };
                        }
                        
                        unique[key].tallas.push(...item.tallas);
                    }
                    
                    return unique;
                },

                calculateTotalStock(groups) {
                    let total = 0;
                    for (const group of Object.values(groups)) {
                        for (const talla of group.tallas) {
                            total += parseFloat(talla.cantidad) || 0;
                        }
                    }
                    return total;
                },

                getValidator(groups) {
                    const validators = Object.values(groups)
                        .map(g => g.info.validador)
                        .filter(v => v);
                    return validators[0] || 'N/A';
                }
            };

            const Export = {
                async exportSingleToPDF(button) {
                    try {
                        UI.showSpinner(true);
                        const card = button.closest('.rotulo-card');
                        
                        const rotuloDiv = card.querySelector('.rotulo');
                        const proveedor = rotuloDiv.querySelector('.rotulo-data-col1').textContent.replace('Proveedor: ', '').trim();
                        const parihuela = rotuloDiv.querySelector('.rotulo-data-col2').textContent.replace('Parihuela: ', '').trim();
                        
                        const selection = state.generatedLabels.find(l => 
                            l.selection.proveedor === proveedor && 
                            l.selection.parihuela === parihuela
                        );
                        
                        if (!selection) {
                            throw new Error('No se encontraron los datos del r√≥tulo');
                        }
                        
                        const pdf = await Export.generateDirectPDF(selection.selection);
                        pdf.save(`rotulo-P${parihuela}-${Date.now()}.pdf`);
                        
                        UI.showToast('‚úì PDF exportado correctamente');
                    } catch (error) {
                        console.error('Error exportando PDF:', error);
                        UI.showStatus('Error al exportar PDF: ' + error.message, 'error');
                    } finally {
                        UI.showSpinner(false);
                    }
                },

                async exportAllToPDF() {
                    if (state.generatedLabels.length === 0) {
                        UI.showStatus('No hay r√≥tulos para exportar', 'warning');
                        return;
                    }

                    try {
                        UI.showSpinner(true);
                        const { jsPDF } = window.jspdf;
                        const pdf = new jsPDF('p', 'pt', 'a4');
                        
                        for (let i = 0; i < state.generatedLabels.length; i++) {
                            if (i > 0) pdf.addPage();
                            await Export.drawPDFContent(pdf, state.generatedLabels[i].selection);
                        }
                        
                        pdf.save(`rotulos-lukers-${Date.now()}.pdf`);
                        UI.showToast(`‚úì ${state.generatedLabels.length} r√≥tulos exportados a PDF`);
                    } catch (error) {
                        console.error('Error:', error);
                        UI.showStatus('Error exportando PDFs: ' + error.message, 'error');
                    } finally {
                        UI.showSpinner(false);
                    }
                },

                async generateDirectPDF(selection) {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'pt', 'a4');
                    await Export.drawPDFContent(pdf, selection);
                    return pdf;
                },

                async drawPDFContent(pdf, selection) {
                    const filtered = Data.filterData(selection);
                    const groups = LabelGenerator.groupData(filtered);
                    
                    const marginTop = 3;
                    const marginLeft = 12;
                    const marginRight = 12;
                    
                    let yPos = marginTop;
                    
                    pdf.setFontSize(14);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('ROTULO DE CAJA - ALMACEN RD50', 297.5, yPos + 15, { align: 'center' });
                    yPos += 20;
                    
                    pdf.setDrawColor(51, 51, 51);
                    pdf.setLineWidth(1);
                    
                    pdf.setFillColor(68, 114, 196);
                    pdf.rect(marginLeft, yPos, 285, 20, 'FD');
                    pdf.setFillColor(231, 76, 60);
                    pdf.rect(marginLeft + 285, yPos, 286, 20, 'FD');
                    
                    pdf.setFontSize(11);
                    pdf.setTextColor(255, 255, 255);
                    pdf.text('INFORMACI√ìN DE LA CAJA', marginLeft + 142.5, yPos + 13, { align: 'center' });
                    pdf.text('UBICACI√ìN DEL PRODUCTO', marginLeft + 285 + 143, yPos + 13, { align: 'center' });
                    yPos += 20;
                    
                    pdf.setTextColor(0, 0, 0);
                    pdf.setFontSize(9);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setDrawColor(102, 102, 102);
                    pdf.setLineWidth(0.5);
                    
                    const totalStock = LabelGenerator.calculateTotalStock(groups);
                    const fecha = new Date().toLocaleDateString('es-ES', { month: '2-digit', year: 'numeric' });
                    const validador = LabelGenerator.getValidator(groups);
                    
                    pdf.rect(marginLeft, yPos, 285, 18);
                    pdf.rect(marginLeft + 285, yPos, 286, 18);
                    pdf.text(`Proveedor: ${selection.proveedor}`, marginLeft + 5, yPos + 12);
                    pdf.text(`Parihuela: ${selection.parihuela}`, marginLeft + 285 + 5, yPos + 12);
                    yPos += 18;
                    
                    pdf.rect(marginLeft, yPos, 285, 18);
                    pdf.rect(marginLeft + 285, yPos, 286, 18);
                    pdf.text(`Validador: ${validador}`, marginLeft + 5, yPos + 12);
                    pdf.text(`Caja: ${selection.caja}`, marginLeft + 285 + 5, yPos + 12);
                    yPos += 18;
                    
                    pdf.rect(marginLeft, yPos, 285, 18);
                    pdf.rect(marginLeft + 285, yPos, 286, 18);
                    pdf.text(`Fecha: ${fecha}`, marginLeft + 5, yPos + 12);
                    pdf.text(`Total Stock: ${totalStock}`, marginLeft + 285 + 5, yPos + 12);
                    yPos += 25;
                    
                    const byGenero = LabelGenerator.groupByGenero(groups);
                    
                    for (const [genero, items] of Object.entries(byGenero)) {
                        yPos += 5;
                        pdf.setFontSize(11);
                        pdf.setFont('helvetica', 'bold');
                        pdf.setTextColor(0, 0, 0);
                        pdf.text(`=== ${genero} ===`, 297.5, yPos, { align: 'center' });
                        yPos += 10;
                        
                        const uniqueProducts = LabelGenerator.groupUniqueProducts(items);
                        
                        for (const product of Object.values(uniqueProducts)) {
                            pdf.setFontSize(10);
                            pdf.setFont('helvetica', 'bold');
                            pdf.setTextColor(0, 0, 0);
                            pdf.text(`${product.descripcion} | ${product.mundo} | ${product.marca}`, 297.5, yPos, { align: 'center' });
                            yPos += 8;
                            
                            if (state.activeMode === 'concodigo' && (product.codigo || product.color)) {
                                pdf.setFontSize(9);
                                pdf.setFont('helvetica', 'normal');
                                const codigoText = `CODIGO: ${product.codigo || 'N/A'}`;
                                const colorText = `COLOR: ${product.color || 'N/A'}`;
                                
                                pdf.text(codigoText, marginLeft, yPos);
                                pdf.text(colorText, marginLeft + 571, yPos, { align: 'right' });
                                yPos += 10;
                                
                                pdf.setFont('helvetica', 'bold');
                            }
                            
                            yPos = Export.drawSizesTable(pdf, product.tallas, marginLeft, yPos);
                            yPos += 8;
                        }
                    }
                },

                drawSizesTable(pdf, tallas, x, y) {
                    pdf.setDrawColor(51, 51, 51);
                    pdf.setLineWidth(1);
                    pdf.setTextColor(0, 0, 0);
                    
                    const colWidths = [45, 45, 44, 150, 45, 45, 44, 150];
                    const rowHeight = 70;
                    const headerHeight = 20;
                    
                    pdf.setFontSize(9);
                    pdf.setFont('helvetica', 'bold');
                    
                    const headers = ['T-1', 'T-2', 'CANT', 'Sticker', 'T-1', 'T-2', 'CANT', 'Sticker'];
                    let xPos = x;
                    
                    for (let i = 0; i < headers.length; i++) {
                        pdf.setFillColor(255, 255, 255);
                        pdf.rect(xPos, y, colWidths[i], headerHeight, 'FD');
                        pdf.text(headers[i], xPos + colWidths[i]/2, y + 13, { align: 'center' });
                        xPos += colWidths[i];
                    }
                    y += headerHeight;
                    
                    pdf.setFont('helvetica', 'normal');
                    pdf.setFontSize(12);
                    
                    if (tallas.length === 0) {
                        xPos = x;
                        for (let i = 0; i < 8; i++) {
                            pdf.setFillColor(255, 255, 255);
                            pdf.rect(xPos, y, colWidths[i], rowHeight, 'FD');
                            if (i !== 3 && i !== 7) {
                                pdf.text('-', xPos + colWidths[i]/2, y + rowHeight/2 + 4, { align: 'center' });
                            }
                            xPos += colWidths[i];
                        }
                        y += rowHeight;
                    } else {
                        for (let i = 0; i < tallas.length; i += 2) {
                            const t1 = tallas[i];
                            const t2 = i + 1 < tallas.length ? tallas[i + 1] : null;
                            
                            xPos = x;
                            
                            pdf.setFillColor(255, 255, 255);
                            pdf.rect(xPos, y, colWidths[0], rowHeight, 'FD');
                            pdf.text(t1.talla1 || '-', xPos + colWidths[0]/2, y + rowHeight/2 + 4, { align: 'center' });
                            xPos += colWidths[0];
                            
                            pdf.setFillColor(255, 255, 255);
                            pdf.rect(xPos, y, colWidths[1], rowHeight, 'FD');
                            pdf.text(t1.talla2 || '-', xPos + colWidths[1]/2, y + rowHeight/2 + 4, { align: 'center' });
                            xPos += colWidths[1];
                            
                            pdf.setFillColor(255, 255, 255);
                            pdf.rect(xPos, y, colWidths[2], rowHeight, 'FD');
                            pdf.text(String(t1.cantidad || '0'), xPos + colWidths[2]/2, y + rowHeight/2 + 4, { align: 'center' });
                            xPos += colWidths[2];
                            
                            pdf.setFillColor(255, 255, 255);
                            pdf.rect(xPos, y, colWidths[3], rowHeight, 'FD');
                            xPos += colWidths[3];
                            
                            if (t2) {
                                pdf.setFillColor(255, 255, 255);
                                pdf.rect(xPos, y, colWidths[4], rowHeight, 'FD');
                                pdf.text(t2.talla1 || '-', xPos + colWidths[4]/2, y + rowHeight/2 + 4, { align: 'center' });
                                xPos += colWidths[4];
                                
                                pdf.setFillColor(255, 255, 255);
                                pdf.rect(xPos, y, colWidths[5], rowHeight, 'FD');
                                pdf.text(t2.talla2 || '-', xPos + colWidths[5]/2, y + rowHeight/2 + 4, { align: 'center' });
                                xPos += colWidths[5];
                                
                                pdf.setFillColor(255, 255, 255);
                                pdf.rect(xPos, y, colWidths[6], rowHeight, 'FD');
                                pdf.text(String(t2.cantidad || '0'), xPos + colWidths[6]/2, y + rowHeight/2 + 4, { align: 'center' });
                                xPos += colWidths[6];
                                
                                pdf.setFillColor(255, 255, 255);
                                pdf.rect(xPos, y, colWidths[7], rowHeight, 'FD');
                            } else {
                                pdf.setFillColor(255, 255, 255);
                                pdf.rect(xPos, y, colWidths[4], rowHeight, 'FD');
                                xPos += colWidths[4];
                                
                                pdf.setFillColor(255, 255, 255);
                                pdf.rect(xPos, y, colWidths[5], rowHeight, 'FD');
                                xPos += colWidths[5];
                                
                                pdf.setFillColor(255, 255, 255);
                                pdf.rect(xPos, y, colWidths[6], rowHeight, 'FD');
                                xPos += colWidths[6];
                                
                                pdf.setFillColor(255, 255, 255);
                                pdf.rect(xPos, y, colWidths[7], rowHeight, 'FD');
                            }
                            
                            y += rowHeight;
                        }
                    }
                    
                    return y;
                }
            };

            const Analysis = {
                analyze() {
                    if (!state.data) {
                        UI.showStatus('Primero carga los datos', 'warning');
                        return;
                    }

                    const values = state.data.values;
                    const cols = state.data.cols;
                    
                    const totalRecords = values.length - 1;
                    const groups = {};

                    for (let i = 1; i < values.length; i++) {
                        const row = values[i];
                        const key = [
                            row[cols['DESCRIPCI√ìN']],
                            row[cols['MUNDO']],
                            row[cols['MARCA']],
                            row[cols['GENERO']],
                            row[cols['PARIHUELA']],
                            row[cols['CAJA']]
                        ].join('|');
                        
                        groups[key] = (groups[key] || 0) + 1;
                    }

                    const totalGroupsconst totalGroups = Object.keys(groups).length;
                    const maxSizes = Math.max(...Object.values(groups));
                    const largeGroups = Object.values(groups).filter(c => c > 20).length;
                    const avgSizes = (totalRecords / totalGroups).toFixed(1);

                    const resultsDiv = document.getElementById('analysisResults');
                    resultsDiv.innerHTML = `
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px;">
                            <h4 style="color: #1e88e5; margin-bottom: 15px;">An√°lisis de Clasificaci√≥n</h4>
                            <div class="stats-grid">
                                <div class="stat-card" style="border-left-color: #28a745;">
                                    <div class="stat-value">${totalRecords.toLocaleString()}</div>
                                    <div class="stat-label">Total Registros</div>
                                </div>
                                <div class="stat-card" style="border-left-color: #1e88e5;">
                                    <div class="stat-value">${totalGroups.toLocaleString()}</div>
                                    <div class="stat-label">Grupos √önicos</div>
                                </div>
                                <div class="stat-card" style="border-left-color: #ffc107;">
                                    <div class="stat-value">${state.data.providers.length}</div>
                                    <div class="stat-label">Proveedores</div>
                                </div>
                                <div class="stat-card" style="border-left-color: #dc3545;">
                                    <div class="stat-value">${maxSizes}</div>
                                    <div class="stat-label">M√°x Tallas/Grupo</div>
                                </div>
                                <div class="stat-card" style="border-left-color: #17a2b8;">
                                    <div class="stat-value">${avgSizes}</div>
                                    <div class="stat-label">Promedio Tallas</div>
                                </div>
                                <div class="stat-card" style="border-left-color: #6f42c1;">
                                    <div class="stat-value">${state.data.generos.length}</div>
                                    <div class="stat-label">G√©neros</div>
                                </div>
                            </div>
                            ${largeGroups > 0 ? `
                                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; padding: 15px; margin-top: 15px;">
                                    <strong style="color: #856404;">‚ö†Ô∏è Atenci√≥n:</strong> 
                                    ${largeGroups} grupos tienen m√°s de 20 tallas
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    UI.showStatus('An√°lisis completado', 'success');
                },

                exportAnalysis() {
                    const results = document.getElementById('analysisResults');
                    if (!results.innerHTML) {
                        UI.showStatus('Primero ejecuta el an√°lisis', 'warning');
                        return;
                    }

                    const text = results.innerText;
                    const blob = new Blob([text], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `analisis-lukers-${Date.now()}.txt`;
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    UI.showToast('‚úì An√°lisis exportado');
                }
            };

            const History = {
                addBatch(labels) {
                    const history = History.load();
                    const batch = {
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        count: labels.length,
                        labels: labels.map(l => ({
                            proveedor: l.selection.proveedor,
                            parihuela: l.selection.parihuela,
                            caja: l.selection.caja
                        }))
                    };
                    history.unshift(batch);
                    
                    if (history.length > 50) history.length = 50;
                    
                    History.save(history);
                    History.render();
                },

                load() {
                    try {
                        const data = sessionStorage.getItem('lukers_history');
                        return data ? JSON.parse(data) : [];
                    } catch {
                        return [];
                    }
                },

                save(history) {
                    try {
                        sessionStorage.setItem('lukers_history', JSON.stringify(history));
                    } catch (e) {
                        console.warn('No se pudo guardar el historial:', e);
                    }
                },

                render() {
                    const history = History.load();
                    const container = document.getElementById('historyList');
                    
                    if (history.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No hay historial de r√≥tulos generados</p>';
                        return;
                    }

                    container.innerHTML = history.map(batch => {
                        const date = new Date(batch.timestamp);
                        const timeStr = date.toLocaleString('es-ES');
                        
                        return `
                            <div class="history-item">
                                <div class="history-info">
                                    <strong>${batch.count} r√≥tulo${batch.count !== 1 ? 's' : ''}</strong>
                                    <div class="history-timestamp">${timeStr}</div>
                                    <small>${batch.labels.map(l => `P${l.parihuela}-C${l.caja}`).join(', ')}</small>
                                </div>
                            </div>
                        `;
                    }).join('');
                },

                clear() {
                    if (confirm('¬øEst√°s seguro de que deseas limpiar todo el historial?')) {
                        History.save([]);
                        History.render();
                        UI.showToast('‚úì Historial limpiado');
                    }
                }
            };

            const UI = {
                toggleUserMenu() {
                    const dropdown = document.getElementById('userDropdown');
                    const btn = document.getElementById('userMenuBtn');
                    
                    dropdown.classList.toggle('active');
                    btn.classList.toggle('active');
                },

                closeUserMenu() {
                    const dropdown = document.getElementById('userDropdown');
                    const btn = document.getElementById('userMenuBtn');
                    
                    dropdown.classList.remove('active');
                    btn.classList.remove('active');
                },

                openModal(modalId) {
                    document.getElementById(modalId).classList.add('active');
                },

                closeModal(modalId) {
                    document.getElementById(modalId).classList.remove('active');
                },

                updateCompactStatus(isConnected, statusText) {
                    const dot = document.getElementById('statusDotCompact');
                    const text = document.getElementById('statusTextCompact');
                    
                    if (isConnected) {
                        dot.classList.add('connected');
                        text.textContent = statusText || 'Autenticado';
                    } else {
                        dot.classList.remove('connected');
                        text.textContent = statusText || 'Sin autenticar';
                    }

                    // Actualizar dropdown tambi√©n
                    const dropdownStatus = document.getElementById('dropdownAuthStatus');
                    if (isConnected) {
                        dropdownStatus.textContent = 'üü¢ ' + (statusText || 'Autenticado');
                        document.getElementById('dropdownUserActions').style.display = 'block';
                        document.getElementById('dropdownGuestActions').style.display = 'none';
                    } else {
                        dropdownStatus.textContent = 'üî¥ ' + (statusText || 'No autenticado');
                        document.getElementById('dropdownUserActions').style.display = 'none';
                        document.getElementById('dropdownGuestActions').style.display = 'block';
                    }
                },

                updateAuthStatus(isSignedIn, isAdmin = false) {
                    if (isAdmin) {
                        const indicator = document.getElementById('statusIndicatorAdmin');
                        const status = document.getElementById('authStatusAdmin');
                        const signInBtn = document.getElementById('signInBtnAdmin');
                        const signOutBtn = document.getElementById('signOutBtnAdmin');

                        if (isSignedIn) {
                            indicator.className = 'status-indicator connected';
                            status.textContent = 'Autenticado (Admin)';
                            signInBtn.style.display = 'none';
                            signOutBtn.style.display = 'inline-block';
                        } else {
                            indicator.className = 'status-indicator disconnected';
                            status.textContent = 'No autenticado';
                            signInBtn.style.display = 'inline-block';
                            signOutBtn.style.display = 'none';
                        }
                    }
                },

                showStatus(message, type) {
                    const statusDiv = document.getElementById('statusMessage');
                    statusDiv.className = `status-message status-${type}`;
                    statusDiv.textContent = message;
                    statusDiv.style.display = 'block';

                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 5000);
                },

                showToast(message) {
                    const toast = document.getElementById('toast');
                    toast.textContent = message;
                    toast.classList.add('active');

                    setTimeout(() => {
                        toast.classList.remove('active');
                    }, 3000);
                },

                showSpinner(show) {
                    document.getElementById('spinnerOverlay').classList.toggle('active', show);
                },

                switchTab(event, tabName) {
                    document.querySelectorAll('.tab').forEach(tab => {
                        tab.classList.remove('active');
                        tab.setAttribute('aria-selected', 'false');
                    });
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    event.target.classList.add('active');
                    event.target.setAttribute('aria-selected', 'true');
                    document.getElementById(tabName + 'Tab').classList.add('active');

                    if (tabName === 'history') {
                        History.render();
                    }
                },

                switchOption(optionNum) {
                    state.activeOption = optionNum;
                    
                    document.querySelectorAll('.option-tab').forEach((tab, index) => {
                        const isActive = index + 1 === optionNum;
                        tab.classList.toggle('active', isActive);
                        tab.setAttribute('aria-selected', isActive.toString());
                    });
                    
                    document.querySelectorAll('.option-content').forEach((content, index) => {
                        content.classList.toggle('active', index + 1 === optionNum);
                    });
                },

                populateProviders(providers) {
                    const select = document.getElementById('proveedorSelect');
                    select.innerHTML = '<option value="">-- Selecciona un proveedor --</option>';
                    
                    providers.forEach(provider => {
                        const option = document.createElement('option');
                        option.value = provider;
                        option.textContent = provider;
                        select.appendChild(option);
                    });
                },

                loadCombinations(provider) {
                    const combinations = state.data.combinationsByProvider[provider] || [];

                    const parihuelas = [...new Set(combinations.map(c => c.parihuela))];
                    const cajas = [...new Set(combinations.map(c => c.caja))];
                    
                    UI.populateSelect('parihuela1', parihuelas);
                    UI.populateSelect('caja1', cajas);
                    UI.populateSelect('parihuela2', parihuelas);
                    UI.populateSelect('cajaDesde', cajas);
                    UI.populateSelect('cajaHasta', cajas);
                    
                    UI.loadMultipleList(combinations);
                },

                populateSelect(id, options) {
                    const select = document.getElementById(id);
                    const firstOption = select.options[0].text;
                    select.innerHTML = `<option value="">${firstOption}</option>`;
                    
                    options.forEach(option => {
                        const opt = document.createElement('option');
                        opt.value = option;
                        opt.textContent = option;
                        select.appendChild(opt);
                    });
                },

                loadMultipleList(combinations) {
                    const lista = document.getElementById('checkboxList');
                    lista.innerHTML = '';
                    
                    combinations.forEach((combo, index) => {
                        const item = document.createElement('div');
                        item.className = 'checkbox-item';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = `combo_${index}`;
                        checkbox.value = `${combo.parihuela}|${combo.caja}`;
                        checkbox.addEventListener('change', UI.updateCounter);
                        
                        const label = document.createElement('label');
                        label.htmlFor = `combo_${index}`;
                        label.textContent = `Parihuela: ${combo.parihuela} - Caja: ${combo.caja}`;
                        
                        item.appendChild(checkbox);
                        item.appendChild(label);
                        lista.appendChild(item);
                    });
                    
                    UI.updateCounter();
                },

                selectAll() {
                    document.querySelectorAll('#checkboxList input[type="checkbox"]').forEach(cb => {
                        cb.checked = true;
                    });
                    UI.updateCounter();
                },

                selectNone() {
                    document.querySelectorAll('#checkboxList input[type="checkbox"]').forEach(cb => {
                        cb.checked = false;
                    });
                    UI.updateCounter();
                },

                updateCounter() {
                    const count = document.querySelectorAll('#checkboxList input[type="checkbox"]:checked').length;
                    document.getElementById('selectionCounter').textContent = 
                        `${count} elemento${count !== 1 ? 's' : ''} seleccionado${count !== 1 ? 's' : ''}`;
                }
            };

            const Utils = {
                escapeHtml(text) {
                    const map = {
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        '"': '&quot;',
                        "'": '&#039;'
                    };
                    return String(text).replace(/[&<>"']/g, m => map[m]);
                }
            };

            function getSelections() {
                const provider = document.getElementById('proveedorSelect').value;
                const selections = [];

                if (state.activeOption === 1) {
                    const parihuela = document.getElementById('parihuela1').value;
                    const caja = document.getElementById('caja1').value;
                    if (parihuela && caja) {
                        selections.push({ proveedor: provider, parihuela, caja });
                    }
                } else if (state.activeOption === 2) {
                    const parihuela = document.getElementById('parihuela2').value;
                    const desde = document.getElementById('cajaDesde').value;
                    const hasta = document.getElementById('cajaHasta').value;
                    
                    if (parihuela && desde && hasta) {
                        if (!Validation.validateRange(desde, hasta)) {
                            UI.showStatus('Rango inv√°lido: "Desde" debe ser menor o igual a "Hasta"', 'error');
                            return [];
                        }

                        const combinations = state.data.combinationsByProvider[provider];
                        const inRange = combinations
                            .filter(c => c.parihuela === parihuela)
                            .filter(c => parseInt(c.caja) >= parseInt(desde) && parseInt(c.caja) <= parseInt(hasta));
                        
                        inRange.forEach(c => {
                            selections.push({ proveedor: provider, parihuela, caja: c.caja });
                        });
                    }
                } else if (state.activeOption === 3) {
                    const checkboxes = document.querySelectorAll('#checkboxList input[type="checkbox"]:checked');
                    checkboxes.forEach(cb => {
                        const [parihuela, caja] = cb.value.split('|');
                        selections.push({ proveedor: provider, parihuela, caja });
                    });
                }

                return selections;
            }

            return {
                Auth,
                Data,
                LabelGenerator,
                Export,
                Analysis,
                History,
                UI,
                Utils,
                state,

                async generateLabels() {
                    const provider = document.getElementById('proveedorSelect').value;
                    if (!provider) {
                        UI.showStatus('Selecciona un proveedor', 'error');
                        return;
                    }

                    const selections = getSelections();
                    if (selections.length === 0) {
                        UI.showStatus('No hay selecciones v√°lidas', 'warning');
                        return;
                    }

                    console.log('Modo activo:', state.activeMode);
                    console.log('Columnas disponibles:', Object.keys(state.data.cols));

                    try {
                        UI.showSpinner(true);
                        const count = await LabelGenerator.generate(selections);
                        
                        if (count > 0) {
                            const modoTexto = state.activeMode === 'concodigo' ? ' (CON C√ìDIGO Y COLOR)' : ' (ORIGINAL)';
                            UI.showStatus(`${count} r√≥tulos generados${modoTexto}`, 'success');
                            document.getElementById('rotulosContainer').style.display = 'block';
                            document.getElementById('labelCount').textContent = count;
                            document.getElementById('exportAllPdfBtn').style.display = 'inline-block';
                            document.getElementById('printAllBtn').style.display = 'inline-block';
                        } else {
                            UI.showStatus('No se pudieron generar r√≥tulos', 'error');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        UI.showStatus('Error: ' + error.message, 'error');
                    } finally {
                        UI.showSpinner(false);
                    }
                },

                clearLabels() {
                    document.getElementById('rotulosList').innerHTML = '';
                    document.getElementById('rotulosContainer').style.display = 'none';
                    document.getElementById('exportAllPdfBtn').style.display = 'none';
                    document.getElementById('printAllBtn').style.display = 'none';
                    state.generatedLabels = [];
                    UI.showToast('‚úì Vista limpiada');
                },

                printSingle(button) {
                    const card = button.closest('.rotulo-card');
                    const printArea = card.querySelector('.print-area');
                    
                    const printWindow = window.open('', '_blank');
                    const printStyles = `
                        @page { margin: 3pt 12pt; }
                        body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
                        .rotulo { max-width: 210mm; margin: 0 auto; background: white; border: 2pt solid #333; padding: 3pt 12pt; }
                        .rotulo-titulo { text-align: center; font-size: 14pt; font-weight: bold; padding: 0; margin: 0; }
                        .rotulo-info-table { width: 571pt; margin: 0 auto; border-collapse: collapse; font-size: 9pt; }
                        .rotulo-info-table td { border: 1pt solid #333333; padding: 2pt 5pt; height: 20pt; }
                        .rotulo-info-header { background: #4472C4; color: #000000; font-weight: bold; text-align: center; font-size: 11pt; width: 285pt; }
                        .rotulo-ubicacion-header { background: #E74C3C; color: #000000; font-weight: bold; text-align: center; font-size: 11pt; width: 286pt; }
                        .rotulo-data-table { width: 571pt; margin: 0 auto; border-collapse: collapse; font-size: 9pt; }
                        .rotulo-data-table td { border: 0.5pt solid #666666; padding: 2pt 5pt; height: 18pt; }
                        .rotulo-data-col1 { width: 285pt; }
                        .rotulo-data-col2 { width: 286pt; background: #FFFFFF; }
                        .rotulo-section-title { text-align: center; font-size: 11pt; font-weight: bold; padding: 3pt 0; margin: 3pt 0; }
                        .rotulo-producto-title { text-align: center; font-size: 10pt; font-weight: bold; padding: 2pt 0 1pt 0; }
                        .rotulo-codigo-table { width: 571pt; margin: 0 auto; border-collapse: collapse; font-size: 9pt; }
                        .rotulo-codigo-table td { padding: 2pt; border: none; }
                        .rotulo-codigo-col1 { width: 285pt; }
                        .rotulo-codigo-col2 { width: 286pt; text-align: right; }
                        .rotulo-tallas-table { width: 568pt; margin: 5pt auto; border-collapse: collapse; border: 1pt solid #333; font-size: 9pt; }
                        .rotulo-tallas-table th { background: #F0F0F0; border: 1pt solid #333; padding: 1pt; text-align: center; font-weight: bold; height: 20pt; }
                        .rotulo-tallas-table .th-t1 { width: 45pt; }
                        .rotulo-tallas-table .th-t2 { width: 45pt; }
                        .rotulo-tallas-table .th-cant { width: 44pt; }
                        .rotulo-tallas-table .th-sticker { width: 150pt; }
                        .rotulo-tallas-table td { border: 1pt solid #333; padding: 1pt; text-align: center; height: 70pt; vertical-align: middle; font-size: 12pt; }
                        .rotulo-sticker-col { background: #FFFFFF; }
                    `;
                    
                    printWindow.document.write('<!DOCTYPE html>');
                    printWindow.document.write('<html><head>');
                    printWindow.document.write('<meta charset="UTF-8">');
                    printWindow.document.write('<title>Rotulo Lukers</title>');
                    printWindow.document.write('<style>' + printStyles + '</style>');
                    printWindow.document.write('</head><body>');
                    printWindow.document.write(printArea.innerHTML);
                    printWindow.document.write('<scr' + 'ipt>');
                    printWindow.document.write('window.onload = function() { setTimeout(function() { window.print(); }, 100); };');
                    printWindow.document.write('window.onafterprint = function() { window.close(); };');
                    printWindow.document.write('</scr' + 'ipt>');
                    printWindow.document.write('</body></html>');
                    printWindow.document.close();
                },

                printAll() {
                    if (state.generatedLabels.length === 0) {
                        UI.showStatus('No hay r√≥tulos para imprimir', 'warning');
                        return;
                    }

                    const printWindow = window.open('', '_blank');
                    const printStyles = `
                        @page { margin: 3pt 12pt; }
                        body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
                        .rotulo { max-width: 210mm; margin: 0 auto 20pt auto; background: white; border: 2pt solid #333; padding: 3pt 12pt; page-break-after: always; }
                        .rotulo:last-child { page-break-after: auto; }
                        .rotulo-titulo { text-align: center; font-size: 14pt; font-weight: bold; padding: 0; margin: 0; }
                        .rotulo-info-table { width: 571pt; margin: 0 auto; border-collapse: collapse; font-size: 9pt; }
                        .rotulo-info-table td { border: 1pt solid #333333; padding: 2pt 5pt; height: 20pt; }
                        .rotulo-info-header { background: #4472C4; color: #000000; font-weight: bold; text-align: center; font-size: 11pt; width: 285pt; }
                        .rotulo-ubicacion-header { background: #E74C3C; color: #000000; font-weight: bold; text-align: center; font-size: 11pt; width: 286pt; }
                        .rotulo-data-table { width: 571pt; margin: 0 auto; border-collapse: collapse; font-size: 9pt; }
                        .rotulo-data-table td { border: 0.5pt solid #666666; padding: 2pt 5pt; height: 18pt; }
                        .rotulo-data-col1 { width: 285pt; }
                        .rotulo-data-col2 { width: 286pt; background: #FFFFFF; }
                        .rotulo-section-title { text-align: center; font-size: 11pt; font-weight: bold; padding: 3pt 0; margin: 3pt 0; }
                        .rotulo-producto-title { text-align: center; font-size: 10pt; font-weight: bold; padding: 2pt 0 1pt 0; }
                        .rotulo-codigo-table { width: 571pt; margin: 0 auto; border-collapse: collapse; font-size: 9pt; }
                        .rotulo-codigo-table td { padding: 2pt; border: none; }
                        .rotulo-codigo-col1 { width: 285pt; }
                        .rotulo-codigo-col2 { width: 286pt; text-align: right; }
                        .rotulo-tallas-table { width: 568pt; margin: 5pt auto; border-collapse: collapse; border: 1pt solid #333; font-size: 9pt; }
                        .rotulo-tallas-table th { background: #F0F0F0; border: 1pt solid #333; padding: 1pt; text-align: center; font-weight: bold; height: 20pt; }
                        .rotulo-tallas-table .th-t1 { width: 45pt; }
                        .rotulo-tallas-table .th-t2 { width: 45pt; }
                        .rotulo-tallas-table .th-cant { width: 44pt; }
                        .rotulo-tallas-table .th-sticker { width: 150pt; }
                        .rotulo-tallas-table td { border: 1pt solid #333; padding: 1pt; text-align: center; height: 70pt; vertical-align: middle; font-size: 12pt; }
                        .rotulo-sticker-col { background: #FFFFFF; }
                    `;
                    
                    printWindow.document.write('<!DOCTYPE html>');
                    printWindow.document.write('<html><head>');
                    printWindow.document.write('<meta charset="UTF-8">');
                    printWindow.document.write('<title>Rotulos Lukers - Impresi√≥n M√∫ltiple</title>');
                    printWindow.document.write('<style>' + printStyles + '</style>');
                    printWindow.document.write('</head><body>');
                    
                    const cards = document.querySelectorAll('.rotulo-card .rotulo-content');
                    cards.forEach(card => {
                        printWindow.document.write(card.innerHTML);
                    });
                    
                    printWindow.document.write('<scr' + 'ipt>');
                    printWindow.document.write('window.onload = function() { setTimeout(function() { window.print(); }, 200); };');
                    printWindow.document.write('window.onafterprint = function() { window.close(); };');
                    printWindow.document.write('</scr' + 'ipt>');
                    printWindow.document.write('</body></html>');
                    printWindow.document.close();
                },
            };
        })();

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Cerrar men√∫ al hacer click fuera
            document.addEventListener('click', (e) => {
                const userMenu = document.getElementById('userMenuBtn');
                const dropdown = document.getElementById('userDropdown');
                
                if (userMenu && dropdown && 
                    !userMenu.contains(e.target) && 
                    !dropdown.contains(e.target)) {
                    App.UI.closeUserMenu();
                }
            });

            // Cerrar modales al hacer click fuera
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });

            // Login admin con Enter
            const adminPass = document.getElementById('adminPass');
            if (adminPass) {
                adminPass.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        App.Auth.adminLogin();
                    }
                });
            }
            
            // Selector de proveedor
            document.getElementById('proveedorSelect').addEventListener('change', (e) => {
                const provider = e.target.value;
                const options = document.getElementById('selectionOptions');
                
                if (provider && App.Data) {
                    options.style.display = 'block';
                    App.UI.loadCombinations(provider);
                } else {
                    options.style.display = 'none';
                }
            });

            // Botones de modo
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.mode-btn').forEach(b => {
                        b.classList.remove('active');
                        b.setAttribute('aria-pressed', 'false');
                    });
                    this.classList.add('active');
                    this.setAttribute('aria-pressed', 'true');
                    App.state.activeMode = this.dataset.mode;
                    App.UI.showToast('Modo: ' + this.textContent);
                });
            });
        });
    </script>
    
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
