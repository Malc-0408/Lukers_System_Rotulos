<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lukers - Sistema de R贸tulos v2.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e88e5 0%, #42a5f5 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e88e5 0%, #42a5f5 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.8em;
        }

        .version-badge {
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8em;
        }

        .config-section {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
        }

        .security-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 15px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
            font-size: 0.9em;
        }

        .form-input, .form-select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            background: white;
            transition: border-color 0.3s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #1e88e5;
        }

        .form-input.error {
            border-color: #dc3545;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9em;
        }

        .btn-primary {
            background: #1e88e5;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #1565c0;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #5a6268;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .auth-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 5px;
            background: #fff;
            border: 1px solid #ddd;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .connected {
            background: #28a745;
            box-shadow: 0 0 5px #28a745;
        }

        .disconnected {
            background: #dc3545;
        }

        .main-content {
            padding: 30px;
            display: none;
        }

        .search-filter-section {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .search-controls {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 15px;
            align-items: end;
        }

        .search-input {
            padding: 12px;
            border: 2px solid #1e88e5;
            border-radius: 5px;
            font-size: 1em;
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: all 0.3s;
            color: #666;
        }

        .tab.active {
            background: #1e88e5;
            color: white;
        }

        .tab:hover:not(.active) {
            background: #e3f2fd;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .mode-selector {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .mode-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }

        .mode-btn {
            padding: 10px 20px;
            border: 2px solid #1e88e5;
            border-radius: 5px;
            background: white;
            color: #1e88e5;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .mode-btn.active {
            background: #1e88e5;
            color: white;
        }

        .proveedor-section {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .proveedor-label {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .proveedor-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1.1em;
            color: #333;
            background: white;
        }

        .selection-options {
            display: none;
            margin-top: 20px;
        }

        .option-tabs {
            display: flex;
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .option-tab {
            flex: 1;
            padding: 12px 10px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
            text-align: center;
            transition: all 0.3s;
            color: #666;
        }

        .option-tab.active {
            background: #1e88e5;
            color: white;
        }

        .option-content {
            display: none;
            background: #f9f9f9;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            min-height: 200px;
        }

        .option-content.active {
            display: block;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .checkbox-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }

        .checkbox-item {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            transition: background-color 0.2s;
        }

        .checkbox-item:hover {
            background-color: #f0f0f0;
        }

        .checkbox-item:last-child {
            border-bottom: none;
        }

        .checkbox-item input {
            margin-right: 10px;
            transform: scale(1.2);
            accent-color: #1e88e5;
        }

        .checkbox-item label {
            cursor: pointer;
            flex: 1;
        }

        .selection-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 5px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            flex-wrap: wrap;
        }

        .status-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .status-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1e88e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .spinner-overlay.active {
            display: flex;
        }

        .spinner-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
        }

        .rotulos-container {
            margin-top: 30px;
            display: none;
        }

        .rotulo-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
            transition: transform 0.2s;
        }

        .rotulo-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .rotulo-header {
            background: #1e88e5;
            color: white;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rotulo-actions {
            display: flex;
            gap: 10px;
        }

        .rotulo-content {
            padding: 20px;
        }

        .rotulo {
            max-width: 210mm;
            margin: 0 auto;
            background: white;
            border: 2px solid #333;
            font-family: Arial, sans-serif;
            color: black;
            padding: 3pt 12pt;
        }

        .rotulo-titulo {
            text-align: center;
            font-size: 14pt;
            font-weight: bold;
            padding: 0;
            margin: 0;
            background: white;
            color: black;
            border-bottom: none;
        }

        .rotulo-info-table {
            width: 571pt;
            margin: 0 auto;
            border-collapse: collapse;
            font-size: 9pt;
        }

        .rotulo-info-table td {
            border: 1pt solid #333333;
            padding: 2pt 5pt;
            vertical-align: middle;
            height: 20pt;
        }

        .rotulo-info-header {
            background: #4472C4;
            color: white;
            font-weight: bold;
            text-align: center;
            font-size: 11pt;
            width: 285pt;
        }

        .rotulo-ubicacion-header {
            background: #E74C3C;
            color: white;
            font-weight: bold;
            text-align: center;
            font-size: 11pt;
            width: 286pt;
        }

        .rotulo-data-table {
            width: 571pt;
            margin: 0 auto;
            border-collapse: collapse;
            font-size: 9pt;
        }

        .rotulo-data-table td {
            border: 0.5pt solid #666666;
            padding: 2pt 5pt;
            vertical-align: middle;
            height: 18pt;
        }

        .rotulo-data-col1 {
            width: 285pt;
        }

        .rotulo-data-col2 {
            width: 286pt;
            background: #FFFFFF;
        }

        .rotulo-section-title {
            text-align: center;
            font-size: 11pt;
            font-weight: bold;
            padding: 3pt 0;
            margin: 3pt 0;
        }

        .rotulo-producto-title {
            text-align: center;
            font-size: 10pt;
            font-weight: bold;
            padding: 2pt 0 1pt 0;
            margin: 0;
        }

        .rotulo-codigo-table {
            width: 571pt;
            margin: 0 auto;
            border-collapse: collapse;
            font-size: 9pt;
        }

        .rotulo-codigo-table td {
            padding: 2pt;
            vertical-align: middle;
            border: none;
        }

        .rotulo-codigo-col1 {
            width: 285pt;
        }

        .rotulo-codigo-col2 {
            width: 286pt;
            text-align: right;
        }

        .rotulo-tallas-table {
            width: 568pt;
            margin: 5pt auto;
            border-collapse: collapse;
            border: 1pt solid #333;
            font-size: 9pt;
        }

        .rotulo-tallas-table th {
            background: #F0F0F0;
            border: 1pt solid #333;
            padding: 1pt;
            text-align: center;
            font-size: 9pt;
            font-weight: bold;
            height: 20pt;
        }

        .rotulo-tallas-table .th-t1 {
            width: 45pt;
        }

        .rotulo-tallas-table .th-t2 {
            width: 45pt;
        }

        .rotulo-tallas-table .th-cant {
            width: 44pt;
        }

        .rotulo-tallas-table .th-sticker {
            width: 150pt;
        }

        .rotulo-tallas-table td {
            border: 1pt solid #333;
            padding: 1pt;
            text-align: center;
            height: 70pt;
            vertical-align: middle;
            font-size: 12pt;
        }

        .rotulo-sticker-col {
            background: #FFFFFF;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #1e88e5;
            text-align: center;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #1e88e5;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .history-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .history-item {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #1e88e5;
        }

        .history-info {
            flex: 1;
        }

        .history-timestamp {
            font-size: 0.8em;
            color: #666;
        }

        .export-section {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            
            .print-area, .print-area * {
                visibility: visible;
            }
            
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
            }
            
            .rotulo-header, .action-buttons {
                display: none !important;
            }
        }

        @media (max-width: 768px) {
            .config-grid {
                grid-template-columns: 1fr;
            }
            
            .two-column {
                grid-template-columns: 1fr;
            }
            
            .tabs, .option-tabs {
                flex-direction: column;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .mode-buttons {
                flex-direction: column;
            }

            .search-controls {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 10000;
            animation: slideUp 0.3s ease-out;
            display: none;
        }

        .toast.active {
            display: block;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .filter-badge {
            display: inline-block;
            background: #1e88e5;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            margin: 5px 5px 0 0;
        }
    </style>
</head>
<body>
    <div class="spinner-overlay" id="spinnerOverlay">
        <div class="spinner-content">
            <div class="loading" style="width: 60px; height: 60px; border-width: 6px;"></div>
            <p style="margin-top: 20px; font-weight: bold;">Procesando...</p>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <div class="container">
        <div class="header">
            <div>
                <h1>SISTEMA DE RTULOS LUKERS</h1>
                <div class="version-badge">v2.0 - Optimizado</div>
            </div>
        </div>

        <div class="config-section">
            <div class="security-warning" role="alert">
                <strong>Aviso de Seguridad:</strong> Solo usa este sistema en entornos seguros. No compartas tus credenciales de Google.
            </div>
            <div class="config-grid">
                <div class="form-group">
                    <label class="form-label" for="clientId">Google OAuth Client ID:</label>
                    <input type="text" id="clientId" class="form-input" placeholder="xxxxxx.apps.googleusercontent.com" maxlength="200" aria-required="true">
                </div>
                <div class="form-group">
                    <label class="form-label" for="spreadsheetId">ID de la Hoja de C谩lculo:</label>
                    <input type="text" id="spreadsheetId" class="form-input" placeholder="ID del Google Sheets" maxlength="100" aria-required="true">
                </div>
                <div>
                    <div class="auth-status" role="status" aria-live="polite">
                        <div id="statusIndicator" class="status-indicator disconnected" aria-hidden="true"></div>
                        <span id="authStatus">No autenticado</span>
                    </div>
                    <div style="margin-top: 10px;">
                        <button id="signInBtn" class="btn btn-primary" disabled aria-label="Iniciar sesi贸n con Google">INICIAR SESIN</button>
                        <button id="signOutBtn" class="btn btn-danger" style="display: none;" aria-label="Cerrar sesi贸n">CERRAR SESIN</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="mainContent" class="main-content">
            <div class="mode-selector" style="margin-top: 0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div>
                        <h3 style="margin: 0;">Tipo de R贸tulo</h3>
                        <div id="lastUpdate" style="font-size: 0.85em; color: #666; margin-top: 5px;">
                            ltima actualizaci贸n: <strong id="updateTimestamp">No cargado</strong>
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="App.Data.refreshData()" id="refreshBtn" style="display: none;">
                         REFRESCAR DATOS
                    </button>
                </div>
                <div class="mode-buttons">
                    <button class="mode-btn active" data-mode="original" aria-pressed="true">RTULO ORIGINAL</button>
                    <button class="mode-btn" data-mode="concodigo" aria-pressed="false">RTULO CON CDIGO + COLOR</button>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="App.UI.switchTab(event, 'generator')" role="tab" aria-selected="true">GENERADOR DE RTULOS</button>
                <button class="tab" onclick="App.UI.switchTab(event, 'analysis')" role="tab" aria-selected="false">ANLISIS</button>
                <button class="tab" onclick="App.UI.switchTab(event, 'history')" role="tab" aria-selected="false">HISTORIAL</button>
            </div>

            <div id="generatorTab" class="tab-content active" role="tabpanel">
                <div class="proveedor-section">
                    <div class="proveedor-label">SELECCIONAR PROVEEDOR</div>
                    <select class="proveedor-select" id="proveedorSelect" aria-label="Seleccionar proveedor">
                        <option value="">-- Selecciona un proveedor --</option>
                    </select>
                </div>

                <div id="selectionOptions" class="selection-options">
                    <div class="option-tabs" role="tablist">
                        <button class="option-tab active" onclick="App.UI.switchOption(1)" role="tab" aria-selected="true">SELECCIN DIRECTA</button>
                        <button class="option-tab" onclick="App.UI.switchOption(2)" role="tab" aria-selected="false">POR INTERVALO</button>
                        <button class="option-tab" onclick="App.UI.switchOption(3)" role="tab" aria-selected="false">LISTA MLTIPLE</button>
                    </div>

                    <div class="option-content active" id="option1" role="tabpanel">
                        <div class="two-column">
                            <div class="form-group">
                                <label class="form-label" for="parihuela1">Parihuela:</label>
                                <select class="form-select" id="parihuela1" aria-label="Seleccionar parihuela">
                                    <option value="">-- Selecciona parihuela --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="caja1">Caja:</label>
                                <select class="form-select" id="caja1" aria-label="Seleccionar caja">
                                    <option value="">-- Selecciona caja --</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="option-content" id="option2" role="tabpanel">
                        <div class="form-group">
                            <label class="form-label" for="parihuela2">Parihuela:</label>
                            <select class="form-select" id="parihuela2" aria-label="Seleccionar parihuela">
                                <option value="">-- Selecciona parihuela --</option>
                            </select>
                        </div>
                        <div class="two-column">
                            <div class="form-group">
                                <label class="form-label" for="cajaDesde">Caja Desde:</label>
                                <select class="form-select" id="cajaDesde" aria-label="Caja inicial">
                                    <option value="">-- Caja inicial --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="cajaHasta">Caja Hasta:</label>
                                <select class="form-select" id="cajaHasta" aria-label="Caja final">
                                    <option value="">-- Caja final --</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="option-content" id="option3" role="tabpanel">
                        <div class="form-group">
                            <label class="form-label">Selecciona las combinaciones:</label>
                            <div class="selection-controls">
                                <div>
                                    <button type="button" class="btn btn-primary" onclick="App.UI.selectAll()">SELECCIONAR TODOS</button>
                                    <button type="button" class="btn btn-secondary" onclick="App.UI.selectNone()">DESELECCIONAR</button>
                                </div>
                                <div id="selectionCounter" role="status" aria-live="polite">0 elementos seleccionados</div>
                            </div>
                            <div class="checkbox-list" id="checkboxList" role="group" aria-label="Lista de combinaciones"></div>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button id="generateBtn" class="btn btn-success" onclick="App.generateLabels()">GENERAR VISTA PREVIA</button>
                        <button id="clearBtn" class="btn btn-secondary" onclick="App.clearLabels()">LIMPIAR VISTA</button>
                        <button id="exportAllPdfBtn" class="btn btn-primary" onclick="App.Export.exportAllToPDF()" style="display: none;">EXPORTAR TODO A PDF</button>
                        <button id="printAllBtn" class="btn btn-primary" onclick="App.printAll()" style="display: none;">IMPRIMIR TODOS</button>
                    </div>
                </div>

                <div id="statusMessage" class="status-message" role="alert"></div>

                <div id="rotulosContainer" class="rotulos-container">
                    <h3>R贸tulos Generados (<span id="labelCount">0</span>)</h3>
                    <div id="rotulosList"></div>
                </div>
            </div>

            <div id="analysisTab" class="tab-content" role="tabpanel">
                <h3>An谩lisis de Datos</h3>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="App.Analysis.analyze()">ANALIZAR CLASIFICACIN</button>
                    <button class="btn btn-secondary" onclick="App.Analysis.exportAnalysis()">EXPORTAR ANLISIS</button>
                </div>
                <div id="analysisResults"></div>
            </div>

            <div id="historyTab" class="tab-content" role="tabpanel">
                <h3>Historial de R贸tulos Generados</h3>
                <div class="action-buttons">
                    <button class="btn btn-danger" onclick="App.History.clear()">LIMPIAR HISTORIAL</button>
                </div>
                <div class="history-section" id="historyList"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        const App = (function() {
            const state = {
                gapiInited: false,
                gisInited: false,
                tokenClient: null,
                spreadsheetId: '',
                data: null,
                activeOption: 1,
                activeMode: 'original',
                generatedLabels: [],
                dataIndex: null,
                lastUpdate: null
            };

            const Config = {
                DISCOVERY_DOC: 'https://sheets.googleapis.com/$discovery/rest?version=v4',
                SCOPES: 'https://www.googleapis.com/auth/spreadsheets.readonly',
                RANGE: 'Clasificaci贸n!A:Z'
            };

            window.gapiLoaded = function() {
                console.log('GAPI loaded');
                gapi.load('client', Auth.initializeGapiClient);
            };

            window.gisLoaded = function() {
                console.log('GIS loaded');
                state.gisInited = true;
                maybeEnableButtons();
            };

            function maybeEnableButtons() {
                if (state.gapiInited && state.gisInited) {
                    document.getElementById('signInBtn').disabled = false;
                }
            }

            const Auth = {
                async initializeGapiClient() {
                    try {
                        await gapi.client.init({
                            discoveryDocs: [Config.DISCOVERY_DOC],
                        });
                        state.gapiInited = true;
                        maybeEnableButtons();
                    } catch (error) {
                        UI.showStatus('Error inicializando Google API', 'error');
                        console.error(error);
                    }
                },

                signIn() {
                    const clientId = document.getElementById('clientId').value.trim();
                    const spreadsheetId = document.getElementById('spreadsheetId').value.trim();

                    if (!Validation.validateClientId(clientId)) {
                        UI.showStatus('Por favor ingresa un Client ID v谩lido', 'error');
                        document.getElementById('clientId').classList.add('error');
                        return;
                    }

                    if (!Validation.validateSpreadsheetId(spreadsheetId)) {
                        UI.showStatus('Por favor ingresa un ID de hoja v谩lido', 'error');
                        document.getElementById('spreadsheetId').classList.add('error');
                        return;
                    }

                    document.getElementById('clientId').classList.remove('error');
                    document.getElementById('spreadsheetId').classList.remove('error');

                    state.spreadsheetId = spreadsheetId;

                    try {
                        state.tokenClient = google.accounts.oauth2.initTokenClient({
                            client_id: clientId,
                            scope: Config.SCOPES,
                            callback: Auth.handleAuthSuccess,
                            error_callback: Auth.handleAuthError
                        });

                        state.tokenClient.requestAccessToken({ prompt: 'consent' });
                    } catch (error) {
                        UI.showStatus('Error configurando autenticaci贸n: ' + error.message, 'error');
                    }
                },

                handleAuthSuccess(resp) {
                    if (resp.error !== undefined) {
                        UI.showStatus('Error de autenticaci贸n: ' + resp.error, 'error');
                        return;
                    }

                    UI.updateAuthStatus(true);
                    UI.showStatus('Autenticaci贸n exitosa', 'success');
                    UI.showToast('Conectado a Google Sheets');
                    document.getElementById('mainContent').style.display = 'block';
                    Data.loadProviders();
                },

                handleAuthError(error) {
                    let userMessage = 'Error de autenticaci贸n: ';
                    
                    switch(error.type) {
                        case 'popup_closed':
                            userMessage += 'Ventana cerrada por el usuario';
                            break;
                        case 'popup_blocked':
                            userMessage += 'Popup bloqueado. Habilita popups para este sitio';
                            break;
                        case 'access_denied':
                            userMessage += 'Acceso denegado. Acepta los permisos requeridos';
                            break;
                        default:
                            userMessage += error.message || 'Error desconocido';
                    }
                    
                    UI.showStatus(userMessage, 'error');
                    UI.updateAuthStatus(false);
                },

                signOut() {
                    const token = gapi.client.getToken();
                    if (token !== null) {
                        google.accounts.oauth2.revoke(token.access_token);
                        gapi.client.setToken('');
                    }
                    UI.updateAuthStatus(false);
                    UI.showStatus('Sesi贸n cerrada', 'success');
                    document.getElementById('mainContent').style.display = 'none';
                    state.data = null;
                    state.dataIndex = null;
                }
            };

            const Validation = {
                validateClientId(clientId) {
                    return clientId && clientId.includes('.apps.googleusercontent.com');
                },

                validateSpreadsheetId(spreadsheetId) {
                    return spreadsheetId && spreadsheetId.length > 10;
                },

                validateRange(desde, hasta) {
                    return parseInt(desde) <= parseInt(hasta);
                }
            };

            const Data = {
                async loadProviders() {
                    try {
                        UI.showSpinner(true);
                        UI.showStatus('Cargando datos...', 'success');

                        const response = await gapi.client.sheets.spreadsheets.values.get({
                            spreadsheetId: state.spreadsheetId,
                            range: Config.RANGE
                        });

                        const values = response.result.values;
                        if (!values || values.length <= 1) {
                            UI.showStatus('No hay datos en la hoja', 'warning');
                            return;
                        }

                        const processedData = Data.processData(values);
                        state.data = processedData;
                        state.dataIndex = Data.createIndex(processedData);

                        // Guardar timestamp de actualizaci贸n
                        const now = new Date();
                        state.lastUpdate = now.toISOString();
                        document.getElementById('updateTimestamp').textContent = now.toLocaleString('es-ES');
                        document.getElementById('refreshBtn').style.display = 'inline-block';

                        UI.populateProviders(processedData.providers);
                        UI.showStatus(`Datos cargados: ${processedData.providers.length} proveedores`, 'success');
                        UI.showToast('Datos cargados correctamente');

                    } catch (error) {
                        console.error('Error cargando datos:', error);
                        UI.showStatus('Error: ' + error.message, 'error');
                    } finally {
                        UI.showSpinner(false);
                    }
                },

                async refreshData() {
                    if (confirm('驴Deseas recargar los datos desde Google Sheets? Se perder谩n las selecciones actuales.')) {
                        // Limpiar selecciones
                        document.getElementById('proveedorSelect').value = '';
                        document.getElementById('selectionOptions').style.display = 'none';
                        
                        // Recargar datos
                        await Data.loadProviders();
                        UI.showToast('Datos actualizados desde Google Sheets');
                    }
                },

                processData(values) {
                    const headers = values[0];
                    const cols = {};
                    headers.forEach((header, index) => {
                        cols[header] = index;
                    });

                    const requiredCols = ['PARIHUELA', 'CAJA', 'ID Proveedor', 'GENERO'];
                    for (const col of requiredCols) {
                        if (cols[col] === undefined) {
                            throw new Error(`Columna requerida "${col}" no encontrada`);
                        }
                    }

                    const providers = new Set();
                    const generos = new Set();
                    const combinationsByProvider = {};

                    for (let i = 1; i < values.length; i++) {
                        const row = values[i];
                        const provider = String(row[cols['ID Proveedor']] || '').trim();
                        const parihuela = String(row[cols['PARIHUELA']] || '').trim();
                        const caja = String(row[cols['CAJA']] || '').trim();
                        const genero = String(row[cols['GENERO']] || '').trim();

                        if (provider && parihuela && caja) {
                            providers.add(provider);
                            if (genero) generos.add(genero);

                            if (!combinationsByProvider[provider]) {
                                combinationsByProvider[provider] = new Set();
                            }
                            combinationsByProvider[provider].add(`${parihuela}|${caja}`);
                        }
                    }

                    const processedCombinations = {};
                    for (const [provider, combos] of Object.entries(combinationsByProvider)) {
                        processedCombinations[provider] = Array.from(combos)
                            .map(combo => {
                                const [parihuela, caja] = combo.split('|');
                                return { parihuela, caja };
                            })
                            .sort((a, b) => {
                                const diffP = parseInt(a.parihuela) - parseInt(b.parihuela);
                                return diffP !== 0 ? diffP : parseInt(a.caja) - parseInt(b.caja);
                            });
                    }

                    return {
                        values,
                        cols,
                        providers: Array.from(providers).sort(),
                        generos: Array.from(generos).sort(),
                        combinationsByProvider: processedCombinations
                    };
                },

                createIndex(data) {
                    const index = {
                        byProvider: {},
                        byGenero: {},
                        byDescripcion: {}
                    };

                    for (let i = 1; i < data.values.length; i++) {
                        const row = data.values[i];
                        const provider = String(row[data.cols['ID Proveedor']] || '').trim();
                        const genero = String(row[data.cols['GENERO']] || '').trim();
                        const descripcion = String(row[data.cols['DESCRIPCIN']] || '').trim();

                        if (!index.byProvider[provider]) index.byProvider[provider] = [];
                        index.byProvider[provider].push(i);

                        if (genero) {
                            if (!index.byGenero[genero]) index.byGenero[genero] = [];
                            index.byGenero[genero].push(i);
                        }

                        if (descripcion) {
                            const key = descripcion.toLowerCase();
                            if (!index.byDescripcion[key]) index.byDescripcion[key] = [];
                            index.byDescripcion[key].push(i);
                        }
                    }

                    return index;
                },

                filterData(selection) {
                    const filtered = [];
                    const rows = state.dataIndex.byProvider[selection.proveedor] || [];

                    for (const rowIndex of rows) {
                        const row = state.data.values[rowIndex];
                        const parihuela = String(row[state.data.cols['PARIHUELA']] || '').trim();
                        const caja = String(row[state.data.cols['CAJA']] || '').trim();

                        if (parihuela === selection.parihuela && caja === selection.caja) {
                            filtered.push(row);
                        }
                    }

                    return filtered;
                }
            };

            const LabelGenerator = {
                async generate(selections) {
                    state.generatedLabels = [];
                    const container = document.getElementById('rotulosList');
                    container.innerHTML = '';

                    let count = 0;

                    for (const selection of selections) {
                        try {
                            const label = await LabelGenerator.generateSingle(selection);
                            if (label) {
                                state.generatedLabels.push({
                                    selection,
                                    html: label.html,
                                    timestamp: new Date().toISOString()
                                });
                                container.appendChild(label.element);
                                count++;
                            }
                        } catch (error) {
                            console.error('Error generando r贸tulo:', error);
                        }
                    }

                    History.addBatch(state.generatedLabels);
                    return count;
                },

                async generateSingle(selection) {
                    const filtered = Data.filterData(selection);
                    
                    if (filtered.length === 0) {
                        throw new Error('No hay datos para esta selecci贸n');
                    }

                    const groups = LabelGenerator.groupData(filtered);
                    
                    if (Object.keys(groups).length === 0) {
                        throw new Error('No se pudieron agrupar los datos');
                    }

                    return LabelGenerator.buildLabelHTML(selection, groups);
                },

                groupData(rows) {
                    const groups = {};
                    const cols = state.data.cols;
                    
                    for (const row of rows) {
                        const keyParts = [
                            String(row[cols['DESCRIPCIN']] || '').trim(),
                            String(row[cols['MUNDO']] || '').trim(),
                            String(row[cols['MARCA']] || '').trim(),
                            String(row[cols['GENERO']] || '').trim(),
                            String(row[cols['PARIHUELA']] || '').trim(),
                            String(row[cols['CAJA']] || '').trim()
                        ];

                        if (state.activeMode === 'concodigo') {
                            keyParts.push(
                                String(row[cols['CODIGO']] || '').trim(),
                                String(row[cols['COLOR']] || '').trim()
                            );
                        }

                        const key = keyParts.join('|');
                        
                        if (!groups[key]) {
                            groups[key] = {
                                info: {
                                    proveedor: row[cols['ID Proveedor']] || '',
                                    marca: row[cols['MARCA']] || '',
                                    genero: row[cols['GENERO']] || '',
                                    descripcion: row[cols['DESCRIPCIN']] || '',
                                    mundo: row[cols['MUNDO']] || '',
                                    parihuela: row[cols['PARIHUELA']] || '',
                                    caja: row[cols['CAJA']] || '',
                                    codigo: row[cols['CODIGO']] || '',
                                    color: row[cols['COLOR']] || '',
                                    validador: row[cols['VALIDADOR']] || ''
                                },
                                tallas: []
                            };
                        }
                        
                        const talla1 = String(row[cols['TALLA 1']] || '').trim();
                        const talla2 = String(row[cols['TALLA 2']] || '').trim();
                        const cantidad = String(row[cols['CANTIDAD']] || '').trim();
                        
                        if (talla1 || talla2 || cantidad) {
                            const existing = groups[key].tallas.find(t =>
                                String(t.talla1).trim() === talla1 && 
                                String(t.talla2).trim() === talla2
                            );
                            
                            if (existing) {
                                existing.cantidad = (parseFloat(existing.cantidad) || 0) + (parseFloat(cantidad) || 0);
                            } else {
                                groups[key].tallas.push({ talla1, talla2, cantidad });
                            }
                        }
                    }
                    
                    return groups;
                },

                buildLabelHTML(selection, groups) {
                    const card = document.createElement('div');
                    card.className = 'rotulo-card';

                    const tipoTexto = state.activeMode === 'original' ? 'Original' : 'Con C贸digo + Color';
                    
                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'rotulo-header';
                    headerDiv.innerHTML = `
                        <h4>R贸tulo ${tipoTexto} - P${selection.parihuela} C${selection.caja} (${selection.proveedor})</h4>
                        <div class="rotulo-actions">
                            <button class="btn btn-primary" onclick="App.printSingle(this)" aria-label="Imprimir r贸tulo">IMPRIMIR</button>
                            <button class="btn btn-success" onclick="App.Export.exportSingleToPDF(this)" aria-label="Exportar a PDF">PDF</button>
                        </div>
                    `;

                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'rotulo-content print-area';
                    contentDiv.innerHTML = LabelGenerator.buildContent(selection, groups);

                    card.appendChild(headerDiv);
                    card.appendChild(contentDiv);

                    return {
                        element: card,
                        html: card.outerHTML
                    };
                },

                buildContent(selection, groups) {
                    const totalStock = LabelGenerator.calculateTotalStock(groups);
                    const fecha = new Date().toLocaleDateString('es-ES', { month: '2-digit', year: 'numeric' });
                    const validador = LabelGenerator.getValidator(groups);

                    let html = `
                        <div class="rotulo">
                            <div class="rotulo-titulo"> RTULO DE CAJA - ALMACN RD50 </div>
                            <table class="rotulo-info-table">
                                <tr>
                                    <td class="rotulo-info-header">INFORMACIN DE LA CAJA</td>
                                    <td class="rotulo-ubicacion-header">UBICACIN DEL PRODUCTO</td>
                                </tr>
                            </table>
                            <table class="rotulo-data-table">
                                <tr>
                                    <td class="rotulo-data-col1">Proveedor: ${Utils.escapeHtml(selection.proveedor)}</td>
                                    <td class="rotulo-data-col2">Parihuela: ${Utils.escapeHtml(selection.parihuela)}</td>
                                </tr>
                                <tr>
                                    <td class="rotulo-data-col1">Validador: ${Utils.escapeHtml(validador)}</td>
                                    <td class="rotulo-data-col2">Caja: ${Utils.escapeHtml(selection.caja)}</td>
                                </tr>
                                <tr>
                                    <td class="rotulo-data-col1">Fecha: ${fecha}</td>
                                    <td class="rotulo-data-col2">Total Stock: ${totalStock}</td>
                                </tr>
                            </table>
                    `;

                    const byGenero = LabelGenerator.groupByGenero(groups);

                    for (const [genero, items] of Object.entries(byGenero)) {
                        html += `<div class="rotulo-section-title">=== ${Utils.escapeHtml(genero)} ===</div>`;

                        const uniqueProducts = LabelGenerator.groupUniqueProducts(items);

                        for (const product of Object.values(uniqueProducts)) {
                            html += `<div class="rotulo-producto-title"> ${Utils.escapeHtml(product.descripcion)} | ${Utils.escapeHtml(product.mundo)} | ${Utils.escapeHtml(product.marca)}</div>`;

                            if (state.activeMode === 'concodigo' && (product.codigo || product.color)) {
                                html += `
                                    <table class="rotulo-codigo-table">
                                        <tr>
                                            <td class="rotulo-codigo-col1">CDIGO: ${Utils.escapeHtml(product.codigo || 'N/A')}</td>
                                            <td class="rotulo-codigo-col2">COLOR: ${Utils.escapeHtml(product.color || 'N/A')}</td>
                                        </tr>
                                    </table>
                                `;
                            }

                            html += LabelGenerator.buildSizesTable(product.tallas);
                        }
                    }

                    html += '</div>';
                    return html;
                },

                buildSizesTable(tallas) {
                    let html = `
                        <table class="rotulo-tallas-table">
                            <tr>
                                <th class="th-t1">T-1</th>
                                <th class="th-t2">T-2</th>
                                <th class="th-cant">CANT</th>
                                <th class="th-sticker">Sticker</th>
                                <th class="th-t1">T-1</th>
                                <th class="th-t2">T-2</th>
                                <th class="th-cant">CANT</th>
                                <th class="th-sticker">Sticker</th>
                            </tr>
                    `;

                    if (tallas.length === 0) {
                        html += '<tr><td>-</td><td>-</td><td>-</td><td class="rotulo-sticker-col"> </td><td>-</td><td>-</td><td>-</td><td class="rotulo-sticker-col"> </td></tr>';
                    } else {
                        for (let i = 0; i < tallas.length; i += 2) {
                            const t1 = tallas[i];
                            const t2 = i + 1 < tallas.length ? tallas[i + 1] : null;

                            html += '<tr>';
                            html += `<td>${Utils.escapeHtml(t1.talla1 || '-')}</td>`;
                            html += `<td>${Utils.escapeHtml(t1.talla2 || '-')}</td>`;
                            html += `<td>${Utils.escapeHtml(t1.cantidad || '0')}</td>`;
                            html += '<td class="rotulo-sticker-col"> </td>';
                            
                            if (t2) {
                                html += `<td>${Utils.escapeHtml(t2.talla1 || '-')}</td>`;
                                html += `<td>${Utils.escapeHtml(t2.talla2 || '-')}</td>`;
                                html += `<td>${Utils.escapeHtml(t2.cantidad || '0')}</td>`;
                                html += '<td class="rotulo-sticker-col"> </td>';
                            } else {
                                html += '<td> </td><td> </td><td> </td><td class="rotulo-sticker-col"> </td>';
                            }
                            
                            html += '</tr>';
                        }
                    }

                    html += '</table>';
                    return html;
                },

                groupByGenero(groups) {
                    const byGenero = {};
                    
                    for (const group of Object.values(groups)) {
                        const genero = group.info.genero || 'SIN GNERO';
                        if (!byGenero[genero]) byGenero[genero] = [];
                        byGenero[genero].push(group);
                    }
                    
                    return byGenero;
                },

                groupUniqueProducts(items) {
                    const unique = {};
                    
                    for (const item of items) {
                        const keyParts = [
                            item.info.descripcion,
                            item.info.mundo,
                            item.info.marca
                        ];

                        if (state.activeMode === 'concodigo') {
                            keyParts.push(item.info.codigo, item.info.color);
                        }

                        const key = keyParts.join('|');
                        
                        if (!unique[key]) {
                            unique[key] = {
                                descripcion: item.info.descripcion,
                                mundo: item.info.mundo,
                                marca: item.info.marca,
                                codigo: item.info.codigo,
                                color: item.info.color,
                                tallas: []
                            };
                        }
                        
                        unique[key].tallas.push(...item.tallas);
                    }
                    
                    return unique;
                },

                calculateTotalStock(groups) {
                    let total = 0;
                    for (const group of Object.values(groups)) {
                        for (const talla of group.tallas) {
                            total += parseFloat(talla.cantidad) || 0;
                        }
                    }
                    return total;
                },

                getValidator(groups) {
                    const validators = Object.values(groups)
                        .map(g => g.info.validador)
                        .filter(v => v);
                    return validators[0] || 'N/A';
                }
            };

            const Export = {
                async exportSingleToPDF(button) {
                    try {
                        UI.showSpinner(true);
                        const card = button.closest('.rotulo-card');
                        const content = card.querySelector('.rotulo-content');
                        
                        const canvas = await html2canvas(content, {
                            scale: 2,
                            useCORS: true,
                            logging: false
                        });

                        const { jsPDF } = window.jspdf;
                        const pdf = new jsPDF('p', 'mm', 'a4');
                        
                        const imgData = canvas.toDataURL('image/png');
                        const imgWidth = 210;
                        const imgHeight = (canvas.height * imgWidth) / canvas.width;
                        
                        pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                        pdf.save(`rotulo-${Date.now()}.pdf`);
                        
                        UI.showToast('PDF exportado correctamente');
                    } catch (error) {
                        console.error('Error exportando PDF:', error);
                        UI.showStatus('Error al exportar PDF', 'error');
                    } finally {
                        UI.showSpinner(false);
                    }
                },

                async exportAllToPDF() {
                    if (state.generatedLabels.length === 0) {
                        UI.showStatus('No hay r贸tulos para exportar', 'warning');
                        return;
                    }

                    try {
                        UI.showSpinner(true);
                        const { jsPDF } = window.jspdf;
                        const pdf = new jsPDF('p', 'mm', 'a4');
                        
                        const cards = document.querySelectorAll('.rotulo-card .rotulo-content');
                        
                        for (let i = 0; i < cards.length; i++) {
                            if (i > 0) pdf.addPage();
                            
                            const canvas = await html2canvas(cards[i], {
                                scale: 2,
                                useCORS: true,
                                logging: false
                            });
                            
                            const imgData = canvas.toDataURL('image/png');
                            const imgWidth = 210;
                            const imgHeight = (canvas.height * imgWidth) / canvas.width;
                            
                            pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                        }
                        
                        pdf.save(`rotulos-lukers-${Date.now()}.pdf`);
                        UI.showToast(`${cards.length} r贸tulos exportados a PDF`);
                    } catch (error) {
                        console.error('Error:', error);
                        UI.showStatus('Error exportando PDFs', 'error');
                    } finally {
                        UI.showSpinner(false);
                    }
                }
            };

            const Analysis = {
                analyze() {
                    if (!state.data) {
                        UI.showStatus('Primero carga los datos', 'warning');
                        return;
                    }

                    const values = state.data.values;
                    const cols = state.data.cols;
                    
                    const totalRecords = values.length - 1;
                    const groups = {};

                    for (let i = 1; i < values.length; i++) {
                        const row = values[i];
                        const key = [
                            row[cols['DESCRIPCIN']],
                            row[cols['MUNDO']],
                            row[cols['MARCA']],
                            row[cols['GENERO']],
                            row[cols['PARIHUELA']],
                            row[cols['CAJA']]
                        ].join('|');
                        
                        groups[key] = (groups[key] || 0) + 1;
                    }

                    const totalGroups = Object.keys(groups).length;
                    const maxSizes = Math.max(...Object.values(groups));
                    const largeGroups = Object.values(groups).filter(c => c > 20).length;
                    const avgSizes = (totalRecords / totalGroups).toFixed(1);

                    const resultsDiv = document.getElementById('analysisResults');
                    resultsDiv.innerHTML = `
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px;">
                            <h4 style="color: #1e88e5; margin-bottom: 15px;">An谩lisis de Clasificaci贸n</h4>
                            <div class="stats-grid">
                                <div class="stat-card" style="border-left-color: #28a745;">
                                    <div class="stat-value">${totalRecords.toLocaleString()}</div>
                                    <div class="stat-label">Total Registros</div>
                                </div>
                                <div class="stat-card" style="border-left-color: #1e88e5;">
                                    <div class="stat-value">${totalGroups.toLocaleString()}</div>
                                    <div class="stat-label">Grupos nicos</div>
                                </div>
                                <div class="stat-card" style="border-left-color: #ffc107;">
                                    <div class="stat-value">${state.data.providers.length}</div>
                                    <div class="stat-label">Proveedores</div>
                                </div>
                                <div class="stat-card" style="border-left-color: #dc3545;">
                                    <div class="stat-value">${maxSizes}</div>
                                    <div class="stat-label">M谩x Tallas/Grupo</div>
                                </div>
                                <div class="stat-card" style="border-left-color: #17a2b8;">
                                    <div class="stat-value">${avgSizes}</div>
                                    <div class="stat-label">Promedio Tallas</div>
                                </div>
                                <div class="stat-card" style="border-left-color: #6f42c1;">
                                    <div class="stat-value">${state.data.generos.length}</div>
                                    <div class="stat-label">G茅neros</div>
                                </div>
                            </div>
                            ${largeGroups > 0 ? `
                                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; padding: 15px; margin-top: 15px;">
                                    <strong style="color: #856404;">锔 Atenci贸n:</strong> 
                                    ${largeGroups} grupos tienen m谩s de 20 tallas
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    UI.showStatus('An谩lisis completado', 'success');
                },

                exportAnalysis() {
                    const results = document.getElementById('analysisResults');
                    if (!results.innerHTML) {
                        UI.showStatus('Primero ejecuta el an谩lisis', 'warning');
                        return;
                    }

                    const text = results.innerText;
                    const blob = new Blob([text], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `analisis-lukers-${Date.now()}.txt`;
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    UI.showToast('An谩lisis exportado');
                }
            };

            const History = {
                addBatch(labels) {
                    const history = History.load();
                    const batch = {
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        count: labels.length,
                        labels: labels.map(l => ({
                            proveedor: l.selection.proveedor,
                            parihuela: l.selection.parihuela,
                            caja: l.selection.caja
                        }))
                    };
                    history.unshift(batch);
                    
                    if (history.length > 50) history.length = 50;
                    
                    History.save(history);
                    History.render();
                },

                load() {
                    try {
                        const data = sessionStorage.getItem('lukers_history');
                        return data ? JSON.parse(data) : [];
                    } catch {
                        return [];
                    }
                },

                save(history) {
                    try {
                        sessionStorage.setItem('lukers_history', JSON.stringify(history));
                    } catch (e) {
                        console.warn('No se pudo guardar el historial:', e);
                    }
                },

                render() {
                    const history = History.load();
                    const container = document.getElementById('historyList');
                    
                    if (history.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No hay historial de r贸tulos generados</p>';
                        return;
                    }

                    container.innerHTML = history.map(batch => {
                        const date = new Date(batch.timestamp);
                        const timeStr = date.toLocaleString('es-ES');
                        
                        return `
                            <div class="history-item">
                                <div class="history-info">
                                    <strong>${batch.count} r贸tulo${batch.count !== 1 ? 's' : ''}</strong>
                                    <div class="history-timestamp">${timeStr}</div>
                                    <small>${batch.labels.map(l => `P${l.parihuela}-C${l.caja}`).join(', ')}</small>
                                </div>
                            </div>
                        `;
                    }).join('');
                },

                clear() {
                    if (confirm('驴Est谩s seguro de que deseas limpiar todo el historial?')) {
                        History.save([]);
                        History.render();
                        UI.showToast('Historial limpiado');
                    }
                }
            };

            const Search = {
                // M贸dulo removido - B煤squeda y filtros eliminados
            };

            const UI = {
                updateAuthStatus(isSignedIn) {
                    const indicator = document.getElementById('statusIndicator');
                    const status = document.getElementById('authStatus');
                    const signInBtn = document.getElementById('signInBtn');
                    const signOutBtn = document.getElementById('signOutBtn');

                    if (isSignedIn) {
                        indicator.className = 'status-indicator connected';
                        status.textContent = 'Autenticado';
                        signInBtn.style.display = 'none';
                        signOutBtn.style.display = 'inline-block';
                    } else {
                        indicator.className = 'status-indicator disconnected';
                        status.textContent = 'No autenticado';
                        signInBtn.style.display = 'inline-block';
                        signOutBtn.style.display = 'none';
                    }
                },

                showStatus(message, type) {
                    const statusDiv = document.getElementById('statusMessage');
                    statusDiv.className = `status-message status-${type}`;
                    statusDiv.textContent = message;
                    statusDiv.style.display = 'block';

                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 5000);
                },

                showToast(message) {
                    const toast = document.getElementById('toast');
                    toast.textContent = message;
                    toast.classList.add('active');

                    setTimeout(() => {
                        toast.classList.remove('active');
                    }, 3000);
                },

                showSpinner(show) {
                    document.getElementById('spinnerOverlay').classList.toggle('active', show);
                },

                switchTab(event, tabName) {
                    document.querySelectorAll('.tab').forEach(tab => {
                        tab.classList.remove('active');
                        tab.setAttribute('aria-selected', 'false');
                    });
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    event.target.classList.add('active');
                    event.target.setAttribute('aria-selected', 'true');
                    document.getElementById(tabName + 'Tab').classList.add('active');

                    if (tabName === 'history') {
                        History.render();
                    }
                },

                switchOption(optionNum) {
                    state.activeOption = optionNum;
                    
                    document.querySelectorAll('.option-tab').forEach((tab, index) => {
                        const isActive = index + 1 === optionNum;
                        tab.classList.toggle('active', isActive);
                        tab.setAttribute('aria-selected', isActive.toString());
                    });
                    
                    document.querySelectorAll('.option-content').forEach((content, index) => {
                        content.classList.toggle('active', index + 1 === optionNum);
                    });
                },

                populateProviders(providers) {
                    const select = document.getElementById('proveedorSelect');
                    select.innerHTML = '<option value="">-- Selecciona un proveedor --</option>';
                    
                    providers.forEach(provider => {
                        const option = document.createElement('option');
                        option.value = provider;
                        option.textContent = provider;
                        select.appendChild(option);
                    });
                },

                loadCombinations(provider) {
                    const combinations = state.data.combinationsByProvider[provider] || [];

                    const parihuelas = [...new Set(combinations.map(c => c.parihuela))];
                    const cajas = [...new Set(combinations.map(c => c.caja))];
                    
                    UI.populateSelect('parihuela1', parihuelas);
                    UI.populateSelect('caja1', cajas);
                    UI.populateSelect('parihuela2', parihuelas);
                    UI.populateSelect('cajaDesde', cajas);
                    UI.populateSelect('cajaHasta', cajas);
                    
                    UI.loadMultipleList(combinations);
                },

                populateSelect(id, options) {
                    const select = document.getElementById(id);
                    const firstOption = select.options[0].text;
                    select.innerHTML = `<option value="">${firstOption}</option>`;
                    
                    options.forEach(option => {
                        const opt = document.createElement('option');
                        opt.value = option;
                        opt.textContent = option;
                        select.appendChild(opt);
                    });
                },

                loadMultipleList(combinations) {
                    const lista = document.getElementById('checkboxList');
                    lista.innerHTML = '';
                    
                    combinations.forEach((combo, index) => {
                        const item = document.createElement('div');
                        item.className = 'checkbox-item';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = `combo_${index}`;
                        checkbox.value = `${combo.parihuela}|${combo.caja}`;
                        checkbox.addEventListener('change', UI.updateCounter);
                        
                        const label = document.createElement('label');
                        label.htmlFor = `combo_${index}`;
                        label.textContent = `Parihuela: ${combo.parihuela} - Caja: ${combo.caja}`;
                        
                        item.appendChild(checkbox);
                        item.appendChild(label);
                        lista.appendChild(item);
                    });
                    
                    UI.updateCounter();
                },

                selectAll() {
                    document.querySelectorAll('#checkboxList input[type="checkbox"]').forEach(cb => {
                        cb.checked = true;
                    });
                    UI.updateCounter();
                },

                selectNone() {
                    document.querySelectorAll('#checkboxList input[type="checkbox"]').forEach(cb => {
                        cb.checked = false;
                    });
                    UI.updateCounter();
                },

                updateCounter() {
                    const count = document.querySelectorAll('#checkboxList input[type="checkbox"]:checked').length;
                    document.getElementById('selectionCounter').textContent = 
                        `${count} elemento${count !== 1 ? 's' : ''} seleccionado${count !== 1 ? 's' : ''}`;
                }
            };

            const Utils = {
                escapeHtml(text) {
                    const map = {
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        '"': '&quot;',
                        "'": '&#039;'
                    };
                    return String(text).replace(/[&<>"']/g, m => map[m]);
                }
            };

            function getSelections() {
                const provider = document.getElementById('proveedorSelect').value;
                const selections = [];

                if (state.activeOption === 1) {
                    const parihuela = document.getElementById('parihuela1').value;
                    const caja = document.getElementById('caja1').value;
                    if (parihuela && caja) {
                        selections.push({ proveedor: provider, parihuela, caja });
                    }
                } else if (state.activeOption === 2) {
                    const parihuela = document.getElementById('parihuela2').value;
                    const desde = document.getElementById('cajaDesde').value;
                    const hasta = document.getElementById('cajaHasta').value;
                    
                    if (parihuela && desde && hasta) {
                        if (!Validation.validateRange(desde, hasta)) {
                            UI.showStatus('Rango inv谩lido: "Desde" debe ser menor o igual a "Hasta"', 'error');
                            return [];
                        }

                        const combinations = state.data.combinationsByProvider[provider];
                        const inRange = combinations
                            .filter(c => c.parihuela === parihuela)
                            .filter(c => parseInt(c.caja) >= parseInt(desde) && parseInt(c.caja) <= parseInt(hasta));
                        
                        inRange.forEach(c => {
                            selections.push({ proveedor: provider, parihuela, caja: c.caja });
                        });
                    }
                } else if (state.activeOption === 3) {
                    const checkboxes = document.querySelectorAll('#checkboxList input[type="checkbox"]:checked');
                    checkboxes.forEach(cb => {
                        const [parihuela, caja] = cb.value.split('|');
                        selections.push({ proveedor: provider, parihuela, caja });
                    });
                }

                return selections;
            }

            return {
                Auth,
                Data,
                LabelGenerator,
                Export,
                Analysis,
                History,
                Search,
                UI,
                Utils,

                async generateLabels() {
                    const provider = document.getElementById('proveedorSelect').value;
                    if (!provider) {
                        UI.showStatus('Selecciona un proveedor', 'error');
                        return;
                    }

                    const selections = getSelections();
                    if (selections.length === 0) {
                        UI.showStatus('No hay selecciones v谩lidas', 'warning');
                        return;
                    }

                    try {
                        UI.showSpinner(true);
                        const count = await LabelGenerator.generate(selections);
                        
                        if (count > 0) {
                            UI.showStatus(`${count} r贸tulos generados`, 'success');
                            document.getElementById('rotulosContainer').style.display = 'block';
                            document.getElementById('labelCount').textContent = count;
                            document.getElementById('exportAllPdfBtn').style.display = 'inline-block';
                            document.getElementById('printAllBtn').style.display = 'inline-block';
                        } else {
                            UI.showStatus('No se pudieron generar r贸tulos', 'error');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        UI.showStatus('Error: ' + error.message, 'error');
                    } finally {
                        UI.showSpinner(false);
                    }
                },

                clearLabels() {
                    document.getElementById('rotulosList').innerHTML = '';
                    document.getElementById('rotulosContainer').style.display = 'none';
                    document.getElementById('exportAllPdfBtn').style.display = 'none';
                    document.getElementById('printAllBtn').style.display = 'none';
                    state.generatedLabels = [];
                    UI.showToast('Vista limpiada');
                },

                printSingle(button) {
                    const card = button.closest('.rotulo-card');
                    const printArea = card.querySelector('.print-area');
                    
                    const printWindow = window.open('', '_blank');
                    const printStyles = `
                        @page { margin: 3pt 12pt; }
                        body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
                        .rotulo { max-width: 210mm; margin: 0 auto; background: white; border: 2pt solid #333; padding: 3pt 12pt; }
                        .rotulo-titulo { text-align: center; font-size: 14pt; font-weight: bold; padding: 0; margin: 0; }
                        .rotulo-info-table { width: 571pt; margin: 0 auto; border-collapse: collapse; font-size: 9pt; }
                        .rotulo-info-table td { border: 1pt solid #333333; padding: 2pt 5pt; height: 20pt; }
                        .rotulo-info-header { background: #4472C4; color: white; font-weight: bold; text-align: center; font-size: 11pt; width: 285pt; }
                        .rotulo-ubicacion-header { background: #E74C3C; color: white; font-weight: bold; text-align: center; font-size: 11pt; width: 286pt; }
                        .rotulo-data-table { width: 571pt; margin: 0 auto; border-collapse: collapse; font-size: 9pt; }
                        .rotulo-data-table td { border: 0.5pt solid #666666; padding: 2pt 5pt; height: 18pt; }
                        .rotulo-data-col1 { width: 285pt; }
                        .rotulo-data-col2 { width: 286pt; background: #FFFFFF; }
                        .rotulo-section-title { text-align: center; font-size: 11pt; font-weight: bold; padding: 3pt 0; margin: 3pt 0; }
                        .rotulo-producto-title { text-align: center; font-size: 10pt; font-weight: bold; padding: 2pt 0 1pt 0; }
                        .rotulo-codigo-table { width: 571pt; margin: 0 auto; border-collapse: collapse; font-size: 9pt; }
                        .rotulo-codigo-table td { padding: 2pt; border: none; }
                        .rotulo-codigo-col1 { width: 285pt; }
                        .rotulo-codigo-col2 { width: 286pt; text-align: right; }
                        .rotulo-tallas-table { width: 568pt; margin: 5pt auto; border-collapse: collapse; border: 1pt solid #333; font-size: 9pt; }
                        .rotulo-tallas-table th { background: #F0F0F0; border: 1pt solid #333; padding: 1pt; text-align: center; font-weight: bold; height: 20pt; }
                        .rotulo-tallas-table .th-t1 { width: 45pt; }
                        .rotulo-tallas-table .th-t2 { width: 45pt; }
                        .rotulo-tallas-table .th-cant { width: 44pt; }
                        .rotulo-tallas-table .th-sticker { width: 150pt; }
                        .rotulo-tallas-table td { border: 1pt solid #333; padding: 1pt; text-align: center; height: 70pt; vertical-align: middle; font-size: 12pt; }
                        .rotulo-sticker-col { background: #FFFFFF; }
                    `;
                    
                    printWindow.document.write('<!DOCTYPE html>');
                    printWindow.document.write('<html><head>');
                    printWindow.document.write('<meta charset="UTF-8">');
                    printWindow.document.write('<title>Rotulo Lukers</title>');
                    printWindow.document.write('<style>' + printStyles + '</style>');
                    printWindow.document.write('</head><body>');
                    printWindow.document.write(printArea.innerHTML);
                    printWindow.document.write('<scr' + 'ipt>');
                    printWindow.document.write('window.onload = function() { setTimeout(function() { window.print(); }, 100); };');
                    printWindow.document.write('window.onafterprint = function() { window.close(); };');
                    printWindow.document.write('</scr' + 'ipt>');
                    printWindow.document.write('</body></html>');
                    printWindow.document.close();
                },

                printAll() {
                    window.print();
                }
            };
        })();

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('signInBtn').addEventListener('click', App.Auth.signIn);
            document.getElementById('signOutBtn').addEventListener('click', App.Auth.signOut);
            
            document.getElementById('proveedorSelect').addEventListener('change', (e) => {
                const provider = e.target.value;
                const options = document.getElementById('selectionOptions');
                
                if (provider && App.Data) {
                    options.style.display = 'block';
                    App.UI.loadCombinations(provider);
                } else {
                    options.style.display = 'none';
                }
            });

            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.mode-btn').forEach(b => {
                        b.classList.remove('active');
                        b.setAttribute('aria-pressed', 'false');
                    });
                    this.classList.add('active');
                    this.setAttribute('aria-pressed', 'true');
                    App.state.activeMode = this.dataset.mode;
                    App.UI.showToast('Modo: ' + this.textContent);
                });
            });
        });
    </script>
    
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
