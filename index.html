<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lukers - Sistema de R√≥tulos v2.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e88e5 0%, #42a5f5 100%);
            min-height: 100vh;
            padding: 0;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 30px rgba(0,0,0,0.3);
        }

        /* ============================================
           HEADER COMPACTO
        ============================================ */
        .header-compact {
            background: linear-gradient(135deg, #1e88e5 0%, #42a5f5 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            position: relative;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-title {
            font-size: 1.4em;
            font-weight: bold;
        }

        .version-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75em;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-compact {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #dc3545;
        }

        .status-dot.connected {
            background: #28a745;
            box-shadow: 0 0 8px #28a745;
        }

        .user-menu-container {
            position: relative;
        }

        .user-menu-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .user-menu-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .user-menu-btn .arrow {
            transition: transform 0.3s;
        }

        .user-menu-btn.active .arrow {
            transform: rotate(180deg);
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            min-width: 320px;
            display: none;
            z-index: 1000;
            animation: slideDown 0.3s ease-out;
        }

        .dropdown-menu.active {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dropdown-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .dropdown-header h4 {
            color: #333;
            margin-bottom: 8px;
            font-size: 1em;
        }

        .dropdown-info {
            color: #666;
            font-size: 0.85em;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .dropdown-body {
            padding: 10px;
        }

        .dropdown-item {
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #333;
            text-decoration: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9em;
        }

        .dropdown-item:hover {
            background: #f0f0f0;
        }

        .dropdown-item.danger:hover {
            background: #fee;
            color: #dc3545;
        }

        .dropdown-divider {
            height: 1px;
            background: #eee;
            margin: 5px 0;
        }

        .admin-warning-small {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.8em;
            margin: 10px;
        }

        /* ============================================
           MODALES
        ============================================ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: fadeIn 0.3s;
        }

        .modal-overlay.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #1e88e5 0%, #42a5f5 100%);
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.2);
        }

        .modal-body {
            padding: 25px;
        }

        .security-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .config-section {
            padding: 0;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
            font-size: 0.9em;
        }

        .form-input, .form-select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            background: white;
            transition: border-color 0.3s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #1e88e5;
        }

        .form-input.error {
            border-color: #dc3545;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9em;
        }

        .btn-primary {
            background: #1e88e5;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #1565c0;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #5a6268;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-block {
            width: 100%;
        }

        .auth-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 5px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            margin-bottom: 15px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
        }

        .status-indicator.connected {
            background: #28a745;
            box-shadow: 0 0 5px #28a745;
        }

        /* ============================================
           LAYOUT DOS COLUMNAS
        ============================================ */
        .main-content {
            display: none;
        }

        .two-column-layout {
            display: grid;
            grid-template-columns: 450px 1fr;
            height: calc(100vh - 60px);
        }

        /* COLUMNA IZQUIERDA - CONFIGURACI√ìN */
        .config-column {
            background: #f8f9fa;
            border-right: 2px solid #dee2e6;
            overflow-y: auto;
            padding: 25px;
        }

        .config-column h3 {
            color: #1e88e5;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mode-selector-compact {
            background: white;
            border: 2px solid #1e88e5;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 25px;
        }

        .mode-selector-compact h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .mode-buttons {
            display: flex;
            gap: 8px;
        }

        .mode-btn {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #1e88e5;
            border-radius: 5px;
            background: white;
            color: #1e88e5;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85em;
            transition: all 0.3s;
        }

        .mode-btn.active {
            background: #1e88e5;
            color: white;
        }

        .selection-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .selection-section h4 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .large-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1.05em;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .large-select:hover {
            border-color: #1e88e5;
        }

        .large-select:focus {
            outline: none;
            border-color: #1e88e5;
            box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.1);
        }

        .parihuela-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .parihuela-chip {
            padding: 12px 8px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 0.95em;
        }

        .parihuela-chip:hover {
            border-color: #1e88e5;
            background: #e3f2fd;
        }

        .parihuela-chip.selected {
            border-color: #1e88e5;
            background: #1e88e5;
            color: white;
        }

        .parihuela-chip.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .caja-count {
            font-size: 0.75em;
            color: #666;
            margin-top: 4px;
        }

        .parihuela-chip.selected .caja-count {
            color: rgba(255,255,255,0.9);
        }

        .method-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            background: #f0f0f0;
            padding: 5px;
            border-radius: 8px;
        }

        .method-tab {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            background: transparent;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85em;
            transition: all 0.3s;
            color: #666;
        }

        .method-tab.active {
            background: #1e88e5;
            color: white;
        }

        .method-content {
            display: none;
        }

        .method-content.active {
            display: block;
        }

        .caja-range {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-list-compact {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }

        .checkbox-item-compact {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            transition: background 0.2s;
        }

        .checkbox-item-compact:hover {
            background: #f0f0f0;
        }

        .checkbox-item-compact:last-child {
            border-bottom: none;
        }

        .checkbox-item-compact input {
            margin-right: 10px;
            transform: scale(1.2);
            accent-color: #1e88e5;
        }

        .checkbox-item-compact label {
            cursor: pointer;
            flex: 1;
            font-size: 0.9em;
        }

        .action-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .action-buttons-vertical {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* COLUMNA DERECHA - PREVIEW */
        .preview-column {
            background: white;
            overflow-y: auto;
            padding: 30px;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .preview-header h3 {
            color: #333;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .preview-actions {
            display: flex;
            gap: 10px;
        }

        .preview-empty {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .preview-empty-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .preview-empty h4 {
            color: #666;
            margin-bottom: 10px;
        }

        .preview-empty p {
            color: #999;
            font-size: 0.95em;
        }

        .preview-info {
            background: #e3f2fd;
            border-left: 4px solid #1e88e5;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 25px;
        }

        .preview-info-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 10px;
        }

        .preview-stat {
            text-align: center;
        }

        .preview-stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #1e88e5;
        }

        .preview-stat-label {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }

        .rotulo-preview {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .rotulo-preview:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        /* Estilos del r√≥tulo (mantener los originales) */
        .rotulo {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border: 2px solid #333;
            font-family: Arial, sans-serif;
            color: black;
            padding: 3pt 12pt;
        }

        .rotulo-titulo {
            text-align: center;
            font-size: 14pt;
            font-weight: bold;
            padding: 0;
            margin: 0;
            background: white;
            color: black;
        }

        .rotulo-info-table {
            width: 100%;
            margin: 0 auto;
            border-collapse: collapse;
            font-size: 9pt;
        }

        .rotulo-info-table td {
            border: 1pt solid #333333;
            padding: 2pt 5pt;
            vertical-align: middle;
            height: 20pt;
        }

        .rotulo-info-header {
            background: #4472C4;
            color: white;
            font-weight: bold;
            text-align: center;
            font-size: 11pt;
        }

        .rotulo-ubicacion-header {
            background: #E74C3C;
            color: white;
            font-weight: bold;
            text-align: center;
            font-size: 11pt;
        }

        .rotulo-data-table {
            width: 100%;
            margin: 0 auto;
            border-collapse: collapse;
            font-size: 9pt;
        }

        .rotulo-data-table td {
            border: 0.5pt solid #666666;
            padding: 2pt 5pt;
            vertical-align: middle;
            height: 18pt;
        }

        .rotulo-section-title {
            text-align: center;
            font-size: 11pt;
            font-weight: bold;
            padding: 3pt 0;
            margin: 3pt 0;
        }

        .rotulo-producto-title {
            text-align: center;
            font-size: 10pt;
            font-weight: bold;
            padding: 2pt 0 1pt 0;
            margin: 0;
        }

        .rotulo-codigo-table {
            width: 100%;
            margin: 0 auto;
            border-collapse: collapse;
            font-size: 9pt;
        }

        .rotulo-codigo-table td {
            padding: 2pt;
            vertical-align: middle;
            border: none;
        }

        .rotulo-codigo-col2 {
            text-align: right;
        }

        .rotulo-tallas-table {
            width: 100%;
            margin: 5pt auto;
            border-collapse: collapse;
            border: 1pt solid #333;
            font-size: 9pt;
        }

        .rotulo-tallas-table th {
            background: #F0F0F0;
            border: 1pt solid #333;
            padding: 1pt;
            text-align: center;
            font-size: 9pt;
            font-weight: bold;
            height: 20pt;
        }

        .rotulo-tallas-table td {
            border: 1pt solid #333;
            padding: 1pt;
            text-align: center;
            height: 70pt;
            vertical-align: middle;
            font-size: 12pt;
        }

        .rotulo-sticker-col {
            background: #FFFFFF;
        }

        .tabs {
            display: flex;
            background: #f0f0f0;
            border-radius: 8px;
            padding: 5px;
            margin-bottom: 25px;
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.95em;
            transition: all 0.3s;
            color: #666;
            border-radius: 5px;
        }

        .tab.active {
            background: #1e88e5;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* An√°lisis e Historial */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #1e88e5;
            text-align: center;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #1e88e5;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .history-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }

        .history-item {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            border-left: 4px solid #1e88e5;
        }

        .history-timestamp {
            font-size: 0.8em;
            color: #666;
        }

        .spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .spinner-overlay.active {
            display: flex;
        }

        .spinner-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
        }

        .loading {
            display: inline-block;
            width: 60px;
            height: 60px;
            border: 6px solid #f3f3f3;
            border-top: 6px solid #1e88e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 10000;
            display: none;
            animation: slideUpToast 0.3s ease-out;
        }

        .toast.active {
            display: block;
        }

        @keyframes slideUpToast {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .update-info {
            font-size: 0.85em;
            color: rgba(255,255,255,0.9);
        }

        .status-message {
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            display: none;
        }

        .status-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .status-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        @media (max-width: 1200px) {
            .two-column-layout {
                grid-template-columns: 400px 1fr;
            }
        }

        @media (max-width: 968px) {
            .two-column-layout {
                grid-template-columns: 1fr;
                height: auto;
            }

            .config-column {
                border-right: none;
                border-bottom: 2px solid #dee2e6;
            }

            .preview-column {
                padding: 20px;
            }
        }

        @media (max-width: 768px) {
            .header-compact {
                flex-direction: column;
                gap: 10px;
                padding: 10px 15px;
            }

            .header-right {
                width: 100%;
                justify-content: space-between;
            }

            .dropdown-menu {
                right: auto;
                left: 0;
                width: 100%;
                min-width: auto;
            }

            .parihuela-grid {
                grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            }

            .preview-info-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ============================================
           SECCI√ìN DE VERIFICACI√ìN
        ============================================ */
        .verification-section {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .verification-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0 30px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #6c757d;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .stat-card.success {
            border-left-color: #28a745;
        }

        .stat-card.warning {
            border-left-color: #ffc107;
        }

        .stat-card.danger {
            border-left-color: #dc3545;
        }

        .stat-label {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }

        .form-grid-verification {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 1em;
            transition: all 0.3s;
            background: white;
        }

        .form-select:focus {
            outline: none;
            border-color: #1e88e5;
            box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.1);
        }

        .action-buttons-verification {
            display: flex;
            gap: 15px;
            margin: 25px 0;
            flex-wrap: wrap;
        }

        .verification-table-container {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin: 20px 0;
        }

        .verification-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .verification-table thead {
            background: linear-gradient(135deg, #1e88e5 0%, #42a5f5 100%);
            color: white;
        }

        .verification-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .verification-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
            font-size: 0.95em;
        }

        .verification-table tbody tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-badge.success {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.danger {
            background: #f8d7da;
            color: #721c24;
        }

        .fields-different {
            font-size: 0.85em;
            color: #856404;
            font-style: italic;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 25px;
        }

        .pagination button {
            padding: 8px 15px;
            border: 2px solid #dee2e6;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pagination button:hover:not(:disabled) {
            border-color: #1e88e5;
            color: #1e88e5;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination span {
            color: #6c757d;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="spinner-overlay" id="spinnerOverlay">
        <div class="spinner-content">
            <div class="loading"></div>
            <p style="margin-top: 20px; font-weight: bold;">Procesando...</p>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <div class="container">
        <!-- HEADER COMPACTO -->
        <div class="header-compact">
            <div class="header-left">
                <div>
                    <div class="header-title">üì¶ SISTEMA DE R√ìTULOS LUKERS</div>
                    <div class="version-badge">v2.0 - Optimizado</div>
                </div>
            </div>
            <div class="header-right">
                <div class="status-compact">
                    <div id="statusDotCompact" class="status-dot"></div>
                    <span id="statusTextCompact">Sin autenticar</span>
                </div>
                <div class="update-info" id="updateInfoCompact" style="display: none;">
                    √ölt. act: <strong id="updateTimestampCompact">-</strong>
                </div>
                <div class="user-menu-container">
                    <button class="user-menu-btn" id="userMenuBtn" onclick="App.UI.toggleUserMenu()">
                        <span>‚öôÔ∏è MEN√ö</span>
                        <span class="arrow">‚ñº</span>
                    </button>
                    <div class="dropdown-menu" id="userDropdown">
                        <div class="admin-warning-small">
                            <strong>‚ÑπÔ∏è Aviso:</strong> Solo el administrador puede configurar credenciales.
                        </div>
                        <div class="dropdown-header">
                            <h4 id="dropdownTitle">Estado del Sistema</h4>
                            <div class="dropdown-info">
                                <div id="dropdownAuthStatus">üî¥ No autenticado</div>
                                <div id="dropdownLastUpdate" style="display: none;">√öltima actualizaci√≥n: <strong id="dropdownTimestamp">-</strong></div>
                            </div>
                        </div>
                        <div class="dropdown-body">
                            <div id="dropdownUserActions" style="display: none;">
                                <div class="dropdown-item" onclick="App.Data.refreshData()">
                                    üîÑ Refrescar Datos
                                </div>
                                <div class="dropdown-divider"></div>
                                <div class="dropdown-item danger" onclick="App.Auth.signOut()">
                                    üî¥ Cerrar Sesi√≥n
                                </div>
                            </div>
                            <div id="dropdownGuestActions">
                                <div class="dropdown-item" id="dropdownSignInBtn" onclick="App.Auth.signIn()">
                                    üü¢ Iniciar Sesi√≥n con Google
                                </div>
                                <div class="dropdown-divider"></div>
                                <div class="dropdown-item" onclick="App.Auth.showAdminLoginModal()">
                                    üîê Acceso Administrador
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL LOGIN ADMIN -->
        <div class="modal-overlay" id="adminLoginModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>üîê Acceso Administrador</h3>
                    <button class="modal-close" onclick="App.UI.closeModal('adminLoginModal')">√ó</button>
                </div>
                <div class="modal-body">
                    <p style="color: #666; margin-bottom: 20px;">Se requiere acceso administrativo para configurar las credenciales del sistema</p>
                    <div class="form-group">
                        <label class="form-label" for="adminUser">Usuario Administrador:</label>
                        <input type="text" id="adminUser" class="form-input" placeholder="Usuario admin" autocomplete="username">
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label class="form-label" for="adminPass">Contrase√±a:</label>
                        <input type="password" id="adminPass" class="form-input" placeholder="Contrase√±a" autocomplete="current-password">
                    </div>
                    <button class="btn btn-primary btn-block" onclick="App.Auth.adminLogin()" style="margin-top: 20px;">ACCEDER</button>
                </div>
            </div>
        </div>

        <!-- MODAL CONFIGURACI√ìN -->
        <div class="modal-overlay" id="configModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>‚öôÔ∏è Configuraci√≥n del Sistema</h3>
                    <button class="modal-close" onclick="App.UI.closeModal('configModal')">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="security-warning">
                        <strong>‚ö†Ô∏è Advertencia de Seguridad:</strong> Estas credenciales se guardar√°n en el navegador del usuario. Solo config√∫relas si conf√≠a en este dispositivo.
                    </div>
                    
                    <div class="config-section">
                        <h4 style="margin-bottom: 15px; color: #333;">Credenciales de Google Sheets</h4>
                        <div class="config-grid">
                            <div class="form-group">
                                <label class="form-label" for="clientId">Google OAuth Client ID:</label>
                                <input type="text" id="clientId" class="form-input" placeholder="xxxxxx.apps.googleusercontent.com" maxlength="200">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="spreadsheetId">ID de la Hoja de C√°lculo:</label>
                                <input type="text" id="spreadsheetId" class="form-input" placeholder="ID del Google Sheets" maxlength="100">
                            </div>
                        </div>
                        <button class="btn btn-success btn-block" onclick="App.Auth.saveConfig()">üíæ GUARDAR CONFIGURACI√ìN</button>

                        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd;">
                            <h4 style="margin-bottom: 15px; color: #333;">Estado de Autenticaci√≥n</h4>
                            <div class="auth-status">
                                <div id="statusIndicatorAdmin" class="status-indicator"></div>
                                <span id="authStatusAdmin">No autenticado</span>
                            </div>
                            <button id="signInBtnAdmin" class="btn btn-primary btn-block" onclick="App.Auth.signInAdmin()" disabled>INICIAR SESI√ìN CON GOOGLE</button>
                            <button id="signOutBtnAdmin" class="btn btn-danger btn-block" onclick="App.Auth.signOutAdmin()" style="display: none;">CERRAR SESI√ìN</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONTENIDO PRINCIPAL -->
        <div id="mainContent" class="main-content">
            <div class="tabs">
                <button class="tab active" onclick="App.UI.switchTab(event, 'generator')">GENERADOR DE R√ìTULOS</button>
                <button class="tab" onclick="App.UI.switchTab(event, 'analysis')">AN√ÅLISIS</button>
                <button class="tab" onclick="App.UI.switchTab(event, 'history')">HISTORIAL</button>
                <button class="tab" onclick="App.UI.switchTab(event, 'verification')">üîç VERIFICACI√ìN</button>
            </div>

            <!-- TAB GENERADOR -->
            <div id="generatorTab" class="tab-content active">
                <div class="two-column-layout">
                    <!-- COLUMNA IZQUIERDA - CONFIGURACI√ìN -->
                    <div class="config-column">
                        <h3>üìã CONFIGURACI√ìN</h3>

                        <!-- MODO -->
                        <div class="mode-selector-compact">
                            <h4>üè∑Ô∏è TIPO DE R√ìTULO</h4>
                            <div class="mode-buttons">
                                <button class="mode-btn active" data-mode="original">ORIGINAL</button>
                                <button class="mode-btn" data-mode="concodigo">CON C√ìDIGO</button>
                            </div>
                        </div>

                        <!-- PROVEEDOR -->
                        <div class="selection-section">
                            <h4>üè¢ PROVEEDOR</h4>
                            <select class="large-select" id="proveedorSelect">
                                <option value="">-- Selecciona un proveedor --</option>
                            </select>
                        </div>

                        <!-- PARIHUELA -->
                        <div class="selection-section" id="parihuselaSection" style="display: none;">
                            <h4>üì¶ PARIHUELA</h4>
                            <div class="parihuela-grid" id="parihulaGrid"></div>
                        </div>

                        <!-- M√âTODO Y CAJAS -->
                        <div class="selection-section" id="methodSection" style="display: none;">
                            <h4>üéØ M√âTODO DE SELECCI√ìN</h4>
                            <div class="method-tabs">
                                <button class="method-tab active" onclick="App.UI.switchMethod(1)">DIRECTA</button>
                                <button class="method-tab" onclick="App.UI.switchMethod(2)">RANGO</button>
                                <button class="method-tab" onclick="App.UI.switchMethod(3)">M√öLTIPLE</button>
                            </div>

                            <!-- M√©todo 1: Directa -->
                            <div class="method-content active" id="methodContent1">
                                <select class="large-select" id="cajaDirecta">
                                    <option value="">-- Selecciona una caja --</option>
                                </select>
                            </div>

                            <!-- M√©todo 2: Rango -->
                            <div class="method-content" id="methodContent2">
                                <div class="caja-range">
                                    <div>
                                        <label class="form-label">Desde:</label>
                                        <select class="large-select" id="cajaDesde">
                                            <option value="">Inicio</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="form-label">Hasta:</label>
                                        <select class="large-select" id="cajaHasta">
                                            <option value="">Fin</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- M√©todo 3: M√∫ltiple -->
                            <div class="method-content" id="methodContent3">
                                <div style="margin-bottom: 10px;">
                                    <button class="btn btn-secondary" onclick="App.UI.selectAll()" style="margin-right: 5px; font-size: 0.8em;">Todos</button>
                                    <button class="btn btn-secondary" onclick="App.UI.selectNone()" style="font-size: 0.8em;">Ninguno</button>
                                    <span id="selectionCounter" style="float: right; font-size: 0.85em; padding: 8px;">0 seleccionadas</span>
                                </div>
                                <div class="checkbox-list-compact" id="checkboxList"></div>
                            </div>
                        </div>

                        <!-- ACCIONES -->
                        <div class="action-section" id="actionSection" style="display: none;">
                            <div class="action-buttons-vertical">
                                <button class="btn btn-success btn-block" onclick="App.generateLabels()">
                                    ‚ú® GENERAR R√ìTULOS
                                </button>
                                <button class="btn btn-secondary btn-block" onclick="App.clearPreview()">
                                    üóëÔ∏è LIMPIAR VISTA
                                </button>
                            </div>
                            <div id="statusMessage" class="status-message"></div>
                        </div>
                    </div>

                    <!-- COLUMNA DERECHA - PREVIEW -->
                    <div class="preview-column">
                        <div class="preview-header">
                            <h3>üëÅÔ∏è VISTA PREVIA</h3>
                            <div class="preview-actions" id="previewActions" style="display: none;">
                                <button class="btn btn-primary" onclick="App.Export.exportAllToPDF()">üìÑ EXPORTAR PDF</button>
                                <button class="btn btn-primary" onclick="App.printAll()">üñ®Ô∏è IMPRIMIR</button>
                            </div>
                        </div>

                        <div id="previewEmpty" class="preview-empty">
                            <div class="preview-empty-icon">üìã</div>
                            <h4>Sin R√≥tulos Generados</h4>
                            <p>Selecciona un proveedor, parihuela y caja para comenzar</p>
                        </div>

                        <div id="previewContent" style="display: none;">
                            <div class="preview-info">
                                <strong>üìä Resumen de Generaci√≥n</strong>
                                <div class="preview-info-grid">
                                    <div class="preview-stat">
                                        <div class="preview-stat-value" id="previewCount">0</div>
                                        <div class="preview-stat-label">R√≥tulos</div>
                                    </div>
                                    <div class="preview-stat">
                                        <div class="preview-stat-value" id="previewProvider">-</div>
                                        <div class="preview-stat-label">Proveedor</div>
                                    </div>
                                    <div class="preview-stat">
                                        <div class="preview-stat-value" id="previewMode">-</div>
                                        <div class="preview-stat-label">Modo</div>
                                    </div>
                                </div>
                            </div>

                            <div id="rotulosList"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB AN√ÅLISIS -->
            <div id="analysisTab" class="tab-content">
                <div style="max-width: 1200px; margin: 0 auto; padding: 30px;">
                    <h3>üìä An√°lisis de Datos</h3>
                    <div style="margin: 20px 0;">
                        <button class="btn btn-primary" onclick="App.Analysis.analyze()">ANALIZAR CLASIFICACI√ìN</button>
                        <button class="btn btn-secondary" onclick="App.Analysis.exportAnalysis()">EXPORTAR AN√ÅLISIS</button>
                    </div>
                    <div id="analysisResults"></div>
                </div>
            </div>

            <!-- TAB HISTORIAL -->
            <div id="historyTab" class="tab-content">
                <div style="max-width: 1200px; margin: 0 auto; padding: 30px;">
                    <h3>üìú Historial de R√≥tulos Generados</h3>
                    <div style="margin: 20px 0;">
                        <button class="btn btn-danger" onclick="App.History.clear()">LIMPIAR HISTORIAL</button>
                    </div>
                    <div class="history-section" id="historyList"></div>
                </div>
            </div>

            <!-- TAB VERIFICACI√ìN -->
            <div id="verificationTab" class="tab-content">
                <div style="max-width: 1400px; margin: 0 auto; padding: 30px;">
                    <!-- Estad√≠sticas -->
                    <div id="statsSection" style="display: none;">
                        <h3>üìä Resumen de Comparaci√≥n</h3>
                        <div class="verification-stats">
                            <div class="stat-card success">
                                <div class="stat-label">‚úÖ Sincronizados</div>
                                <div class="stat-value" id="statSynced">0</div>
                            </div>
                            <div class="stat-card warning">
                                <div class="stat-label">‚ö†Ô∏è Con Diferencias</div>
                                <div class="stat-value" id="statDiff">0</div>
                            </div>
                            <div class="stat-card danger">
                                <div class="stat-label">‚ùå No Existen</div>
                                <div class="stat-value" id="statMissing">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">üìä Total Registros</div>
                                <div class="stat-value" id="statTotal">0</div>
                            </div>
                        </div>
                    </div>

                    <!-- Filtros -->
                    <div class="verification-section">
                        <h3>üîç Filtros de B√∫squeda</h3>
                        <div class="form-grid-verification">
                            <div class="form-group">
                                <label for="verProveedorSelect">üè¢ Proveedor</label>
                                <select id="verProveedorSelect" class="form-select" onchange="App.Verification.filterResults()">
                                    <option value="">Todos los proveedores</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="verStatusSelect">üìä Estado</label>
                                <select id="verStatusSelect" class="form-select" onchange="App.Verification.filterResults()">
                                    <option value="all">Todos los estados</option>
                                    <option value="synced">‚úÖ Sincronizados</option>
                                    <option value="diff">‚ö†Ô∏è Con Diferencias</option>
                                    <option value="missing">‚ùå No Existen en Clasificaci√≥n</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="verMarcaSelect">üè∑Ô∏è Marca</label>
                                <select id="verMarcaSelect" class="form-select" onchange="App.Verification.filterResults()">
                                    <option value="">Todas las marcas</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="verSearchInput">üîç Buscar por ID Detalle</label>
                                <select id="verSearchInput" class="form-select" onchange="App.Verification.filterResults()">
                                    <option value="">Todos los ID Detalle</option>
                                </select>
                            </div>
                        </div>

                        <div class="action-buttons-verification">
                            <button class="btn btn-primary" onclick="App.Verification.loadAndCompare()">
                                üîÑ Cargar y Comparar Datos
                            </button>
                            <button class="btn btn-secondary" onclick="App.Verification.exportToCSV()">
                                üì• Exportar a CSV
                            </button>
                            <button class="btn btn-secondary" onclick="App.Verification.clearFilters()">
                                üóëÔ∏è Limpiar Filtros
                            </button>
                        </div>
                        
                        <div id="verificationStatus"></div>
                    </div>

                    <!-- Tabla de Resultados -->
                    <div id="resultsSection" style="display: none;">
                        <h3>üìã Resultados de Verificaci√≥n</h3>
                        <div class="verification-table-container">
                            <table class="verification-table">
                                <thead>
                                    <tr>
                                        <th>ID Detalle</th>
                                        <th>ID Proveedor</th>
                                        <th>Marca</th>
                                        <th>Descripci√≥n</th>
                                        <th>Estado</th>
                                        <th>Campos Diferentes</th>
                                    </tr>
                                </thead>
                                <tbody id="verificationTableBody">
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Paginaci√≥n -->
                        <div class="pagination">
                            <button onclick="App.Verification.previousPage()">‚óÄ Anterior</button>
                            <span id="pageInfo">P√°gina 1 de 1</span>
                            <button onclick="App.Verification.nextPage()">Siguiente ‚ñ∂</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        const App = (function() {
            const state = {
                gapiInited: false,
                gisInited: false,
                tokenClient: null,
                spreadsheetId: '',
                clientId: '',
                data: null,
                activeMethod: 1,
                activeMode: 'original',
                generatedLabels: [],
                dataIndex: null,
                lastUpdate: null,
                isAdminLogged: false,
                selectedProvider: '',
                selectedParihuela: '',
                inventarioFinalData: null,
                comparisonResults: [],
                currentPage: 1,
                itemsPerPage: 50
            };

            const Config = {
                DISCOVERY_DOC: 'https://sheets.googleapis.com/$discovery/rest?version=v4',
                INVENTARIO_FINAL_SHEET_ID: '1d1OUPxfbyYVVmOtRvRl3b-x034Yh0fbwYIg5Rb4IzeM',
                SCOPES: 'https://www.googleapis.com/auth/spreadsheets.readonly',
                RANGE: 'Clasificaci√≥n!A:Z',
                ADMIN_USER: 'mluzquinos',
                ADMIN_PASS: 'Malc-0408'
            };


            function maybeEnableButtons() {
                if (state.gapiInited && state.gisInited) {
                    const dropdownSignInBtn = document.getElementById('dropdownSignInBtn');
                    if (dropdownSignInBtn) {
                        dropdownSignInBtn.style.pointerEvents = 'auto';
                        dropdownSignInBtn.style.opacity = '1';
                    }
                }
            }

            const Auth = {
                async initializeGapiClient() {
                    try {
                        await gapi.client.init({
                            discoveryDocs: [Config.DISCOVERY_DOC],
                        });
                        state.gapiInited = true;
                        maybeEnableButtons();
                        Auth.checkSavedConfig();
                    } catch (error) {
                        UI.showStatus('Error inicializando Google API', 'error');
                        console.error(error);
                    }
                },

                checkSavedConfig() {
                    try {
                        const savedClientId = localStorage.getItem('lukers_client_id');
                        const savedSpreadsheetId = localStorage.getItem('lukers_spreadsheet_id');
                        
                        if (savedClientId && savedSpreadsheetId) {
                            state.clientId = atob(savedClientId);
                            state.spreadsheetId = atob(savedSpreadsheetId);
                            UI.updateCompactStatus(false, 'Sistema configurado');
                        } else {
                            UI.updateCompactStatus(false, 'Sin configurar');
                        }
                    } catch (e) {
                        console.warn('Error verificando configuraci√≥n:', e);
                        UI.updateCompactStatus(false, 'Sin configurar');
                    }
                },

                showAdminLoginModal() {
                    UI.openModal('adminLoginModal');
                    UI.closeUserMenu();
                },

                adminLogin() {
                    const user = document.getElementById('adminUser').value.trim().toLowerCase();
                    const pass = document.getElementById('adminPass').value;

                    if (user === Config.ADMIN_USER && pass === Config.ADMIN_PASS) {
                        state.isAdminLogged = true;
                        
                        UI.closeModal('adminLoginModal');
                        Auth.loadConfigToFields();
                        UI.openModal('configModal');
                        
                        UI.showToast('‚úì Acceso administrativo concedido');
                    } else {
                        UI.showStatus('Usuario o contrase√±a incorrectos', 'error');
                        document.getElementById('adminPass').value = '';
                    }
                },

                loadConfigToFields() {
                    try {
                        const savedClientId = localStorage.getItem('lukers_client_id');
                        const savedSpreadsheetId = localStorage.getItem('lukers_spreadsheet_id');
                        
                        if (savedClientId && savedSpreadsheetId) {
                            document.getElementById('clientId').value = atob(savedClientId);
                            document.getElementById('spreadsheetId').value = atob(savedSpreadsheetId);
                        }
                    } catch (e) {
                        console.warn('Error cargando configuraci√≥n:', e);
                    }
                },

                saveConfig() {
                    const clientId = document.getElementById('clientId').value.trim();
                    const spreadsheetId = document.getElementById('spreadsheetId').value.trim();

                    if (!Validation.validateClientId(clientId) || !Validation.validateSpreadsheetId(spreadsheetId)) {
                        UI.showStatus('Por favor completa los campos correctamente', 'error');
                        return;
                    }

                    try {
                        localStorage.setItem('lukers_client_id', btoa(clientId));
                        localStorage.setItem('lukers_spreadsheet_id', btoa(spreadsheetId));
                        
                        state.clientId = clientId;
                        state.spreadsheetId = spreadsheetId;
                        
                        UI.showStatus('Configuraci√≥n guardada correctamente', 'success');
                        UI.showToast('‚úì Credenciales guardadas exitosamente');
                        
                        setTimeout(() => {
                            UI.closeModal('configModal');
                            UI.updateCompactStatus(false, 'Configurado - Inicie sesi√≥n');
                        }, 1500);
                        
                    } catch (e) {
                        UI.showStatus('Error guardando configuraci√≥n: ' + e.message, 'error');
                    }
                },

                signIn() {
                    const clientId = state.clientId;
                    const spreadsheetId = state.spreadsheetId;

                    if (!clientId || !spreadsheetId) {
                        UI.showStatus('Error: No hay credenciales configuradas', 'error');
                        UI.showToast('‚ö†Ô∏è Configure primero las credenciales');
                        return;
                    }

                    try {
                        state.tokenClient = google.accounts.oauth2.initTokenClient({
                            client_id: clientId,
                            scope: Config.SCOPES,
                            callback: Auth.handleAuthSuccess,
                            error_callback: Auth.handleAuthError
                        });

                        state.tokenClient.requestAccessToken({ prompt: 'consent' });
                    } catch (error) {
                        UI.showStatus('Error configurando autenticaci√≥n: ' + error.message, 'error');
                    }
                },

                signInAdmin() {
                    const clientId = document.getElementById('clientId').value.trim();
                    const spreadsheetId = document.getElementById('spreadsheetId').value.trim();

                    if (!Validation.validateClientId(clientId)) {
                        UI.showStatus('Por favor ingresa un Client ID v√°lido', 'error');
                        return;
                    }

                    if (!Validation.validateSpreadsheetId(spreadsheetId)) {
                        UI.showStatus('Por favor ingresa un ID de hoja v√°lido', 'error');
                        return;
                    }

                    state.spreadsheetId = spreadsheetId;

                    try {
                        state.tokenClient = google.accounts.oauth2.initTokenClient({
                            client_id: clientId,
                            scope: Config.SCOPES,
                            callback: Auth.handleAuthSuccessAdmin,
                            error_callback: Auth.handleAuthError
                        });

                        state.tokenClient.requestAccessToken({ prompt: 'consent' });
                    } catch (error) {
                        UI.showStatus('Error configurando autenticaci√≥n: ' + error.message, 'error');
                    }
                },

                handleAuthSuccess(resp) {
                    if (resp.error !== undefined) {
                        UI.showStatus('Error de autenticaci√≥n: ' + resp.error, 'error');
                        return;
                    }

                    UI.updateAuthStatus(true, false);
                    UI.updateCompactStatus(true, 'Autenticado');
                    UI.showStatus('Autenticaci√≥n exitosa', 'success');
                    UI.showToast('‚úì Conectado a Google Sheets');
                    UI.closeUserMenu();
                    document.getElementById('mainContent').style.display = 'block';
                    Data.loadProviders();
                },

                handleAuthSuccessAdmin(resp) {
                    if (resp.error !== undefined) {
                        UI.showStatus('Error de autenticaci√≥n: ' + resp.error, 'error');
                        return;
                    }

                    UI.updateAuthStatus(true, true);
                    UI.updateCompactStatus(true, 'Autenticado (Admin)');
                    UI.showStatus('Autenticaci√≥n exitosa (Admin)', 'success');
                    UI.showToast('‚úì Conectado a Google Sheets (Admin)');
                    document.getElementById('mainContent').style.display = 'block';
                    Data.loadProviders();
                },

                handleAuthError(error) {
                    let userMessage = 'Error de autenticaci√≥n: ';
                    
                    switch(error.type) {
                        case 'popup_closed':
                            userMessage += 'Ventana cerrada por el usuario';
                            break;
                        case 'popup_blocked':
                            userMessage += 'Popup bloqueado. Habilita popups para este sitio';
                            break;
                        case 'access_denied':
                            userMessage += 'Acceso denegado. Acepta los permisos requeridos';
                            break;
                        default:
                            userMessage += error.message || 'Error desconocido';
                    }
                    
                    UI.showStatus(userMessage, 'error');
                },

                signOut() {
                    const token = gapi.client.getToken();
                    if (token !== null) {
                        google.accounts.oauth2.revoke(token.access_token);
                        gapi.client.setToken('');
                    }
                    UI.updateAuthStatus(false, false);
                    UI.updateCompactStatus(false, 'Sesi√≥n cerrada');
                    UI.showStatus('Sesi√≥n cerrada', 'success');
                    UI.showToast('Sesi√≥n cerrada correctamente');
                    UI.closeUserMenu();
                    document.getElementById('mainContent').style.display = 'none';
                    state.data = null;
                    state.dataIndex = null;
                    UI.resetSelections();
                },

                signOutAdmin() {
                    const token = gapi.client.getToken();
                    if (token !== null) {
                        google.accounts.oauth2.revoke(token.access_token);
                        gapi.client.setToken('');
                    }
                    UI.updateAuthStatus(false, true);
                    UI.showStatus('Sesi√≥n cerrada', 'success');
                    document.getElementById('mainContent').style.display = 'none';
                    state.data = null;
                    state.dataIndex = null;
                }
            };

            const Validation = {
                validateClientId(clientId) {
                    return clientId && clientId.includes('.apps.googleusercontent.com');
                },

                validateSpreadsheetId(spreadsheetId) {
                    return spreadsheetId && spreadsheetId.length > 10;
                },

                validateRange(desde, hasta) {
                    return parseInt(desde) <= parseInt(hasta);
                }
            };

            const Data = {
                async loadProviders() {
                    try {
                        UI.showSpinner(true);
                        UI.showStatus('Cargando datos...', 'success');

                        const response = await gapi.client.sheets.spreadsheets.values.get({
                            spreadsheetId: state.spreadsheetId,
                            range: Config.RANGE
                        });

                        const values = response.result.values;
                        if (!values || values.length <= 1) {
                            UI.showStatus('No hay datos en la hoja', 'warning');
                            return;
                        }

                        const processedData = Data.processData(values);
                        state.data = processedData;
                        state.dataIndex = Data.createIndex(processedData);

                        const now = new Date();
                        state.lastUpdate = now.toISOString();
                        const timeStr = now.toLocaleString('es-ES');
                        
                        document.getElementById('updateTimestampCompact').textContent = timeStr;
                        document.getElementById('updateInfoCompact').style.display = 'block';
                        document.getElementById('dropdownTimestamp').textContent = timeStr;
                        document.getElementById('dropdownLastUpdate').style.display = 'block';

                        UI.populateProviders(processedData.providers);
                        UI.showStatus(`Datos cargados: ${processedData.providers.length} proveedores`, 'success');
                        UI.showToast('‚úì Datos cargados correctamente');

                    } catch (error) {
                        console.error('Error cargando datos:', error);
                        UI.showStatus('Error: ' + error.message, 'error');
                    } finally {
                        UI.showSpinner(false);
                    }
                },

                async refreshData() {
                    if (confirm('¬øDeseas recargar los datos desde Google Sheets? Se perder√°n las selecciones actuales.')) {
                        UI.resetSelections();
                        await Data.loadProviders();
                        UI.showToast('‚úì Datos actualizados');
                        UI.closeUserMenu();
                    }
                },

                processData(values) {
                    const headers = values[0];
                    const cols = {};
                    headers.forEach((header, index) => {
                        cols[header] = index;
                    });

                    const requiredCols = ['PARIHUELA', 'CAJA', 'ID Proveedor', 'GENERO'];
                    for (const col of requiredCols) {
                        if (cols[col] === undefined) {
                            throw new Error(`Columna requerida "${col}" no encontrada`);
                        }
                    }

                    const providers = new Set();
                    const generos = new Set();
                    const combinationsByProvider = {};

                    for (let i = 1; i < values.length; i++) {
                        const row = values[i];
                        const provider = String(row[cols['ID Proveedor']] || '').trim();
                        const parihuela = String(row[cols['PARIHUELA']] || '').trim();
                        const caja = String(row[cols['CAJA']] || '').trim();
                        const genero = String(row[cols['GENERO']] || '').trim();

                        if (provider && parihuela && caja) {
                            providers.add(provider);
                            if (genero) generos.add(genero);

                            if (!combinationsByProvider[provider]) {
                                combinationsByProvider[provider] = new Set();
                            }
                            combinationsByProvider[provider].add(`${parihuela}|${caja}`);
                        }
                    }

                    const processedCombinations = {};
                    for (const [provider, combos] of Object.entries(combinationsByProvider)) {
                        processedCombinations[provider] = Array.from(combos)
                            .map(combo => {
                                const [parihuela, caja] = combo.split('|');
                                return { parihuela, caja };
                            })
                            .sort((a, b) => {
                                // Funci√≥n auxiliar para ordenamiento natural
                                const isNumeric = (str) => !isNaN(str) && !isNaN(parseFloat(str));
                                
                                const aParNum = isNumeric(a.parihuela);
                                const bParNum = isNumeric(b.parihuela);
                                
                                // Si uno es n√∫mero y el otro no, el n√∫mero va primero
                                if (aParNum && !bParNum) return -1;
                                if (!aParNum && bParNum) return 1;
                                
                                // Si ambos son n√∫meros, comparar num√©ricamente
                                if (aParNum && bParNum) {
                                    const diffP = parseFloat(a.parihuela) - parseFloat(b.parihuela);
                                    if (diffP !== 0) return diffP;
                                } else {
                                    // Si ambos son texto, comparar alfab√©ticamente
                                    const diffP = a.parihuela.localeCompare(b.parihuela);
                                    if (diffP !== 0) return diffP;
                                }
                                
                                // Ordenar cajas de la misma forma
                                const aCajNum = isNumeric(a.caja);
                                const bCajNum = isNumeric(b.caja);
                                
                                if (aCajNum && !bCajNum) return -1;
                                if (!aCajNum && bCajNum) return 1;
                                
                                if (aCajNum && bCajNum) {
                                    return parseFloat(a.caja) - parseFloat(b.caja);
                                } else {
                                    return a.caja.localeCompare(b.caja);
                                }
                            });
                    }

                    return {
                        values,
                        cols,
                        providers: Array.from(providers).sort(),
                        generos: Array.from(generos).sort(),
                        combinationsByProvider: processedCombinations
                    };
                },

                createIndex(data) {
                    const index = {
                        byProvider: {},
                        byGenero: {},
                        byDescripcion: {}
                    };

                    for (let i = 1; i < data.values.length; i++) {
                        const row = data.values[i];
                        const provider = String(row[data.cols['ID Proveedor']] || '').trim();
                        const genero = String(row[data.cols['GENERO']] || '').trim();
                        const descripcion = String(row[data.cols['DESCRIPCI√ìN']] || '').trim();

                        if (!index.byProvider[provider]) index.byProvider[provider] = [];
                        index.byProvider[provider].push(i);

                        if (genero) {
                            if (!index.byGenero[genero]) index.byGenero[genero] = [];
                            index.byGenero[genero].push(i);
                        }

                        if (descripcion) {
                            const key = descripcion.toLowerCase();
                            if (!index.byDescripcion[key]) index.byDescripcion[key] = [];
                            index.byDescripcion[key].push(i);
                        }
                    }

                    return index;
                },

                filterData(selection) {
                    const filtered = [];
                    const rows = state.dataIndex.byProvider[selection.proveedor] || [];

                    // Normalizar la selecci√≥n
                    const selParihuela = String(selection.parihuela || '').trim();
                    const selCaja = String(selection.caja || '').trim();

                    for (const rowIndex of rows) {
                        const row = state.data.values[rowIndex];
                        
                        // Normalizar los valores del Sheet
                        const parihuela = String(row[state.data.cols['PARIHUELA']] || '').trim();
                        const caja = String(row[state.data.cols['CAJA']] || '').trim();

                        // Comparaci√≥n exacta
                        if (parihuela === selParihuela && caja === selCaja) {
                            filtered.push(row);
                        }
                    }

                    // Debug: Si no encuentra datos, mostrar informaci√≥n √∫til
                    if (filtered.length === 0) {
                        console.warn('No se encontraron datos para:', {
                            proveedor: selection.proveedor,
                            parihuela: selParihuela,
                            caja: selCaja,
                            rowsChecked: rows.length
                        });
                    }

                    return filtered;
                },

                // NUEVA FUNCI√ìN: Obtener cajas de una parihuela espec√≠fica
                getCajasForParihuela(provider, parihuela) {
                    if (!state.data || !state.data.combinationsByProvider[provider]) {
                        return [];
                    }

                    const combinations = state.data.combinationsByProvider[provider];
                    const cajas = combinations
                        .filter(c => c.parihuela === parihuela)
                        .map(c => c.caja);

                    return cajas;
                }
            };

// Continuaci√≥n del c√≥digo JavaScript...

            const LabelGenerator = {
                async generate(selections) {
                    state.generatedLabels = [];
                    const container = document.getElementById('rotulosList');
                    container.innerHTML = '';

                    let count = 0;

                    for (const selection of selections) {
                        try {
                            const label = await LabelGenerator.generateSingle(selection);
                            if (label) {
                                state.generatedLabels.push({
                                    selection,
                                    html: label.html,
                                    timestamp: new Date().toISOString()
                                });
                                container.appendChild(label.element);
                                count++;
                            }
                        } catch (error) {
                            console.error('Error generando r√≥tulo:', error);
                        }
                    }

                    History.addBatch(state.generatedLabels);
                    return count;
                },

                async generateSingle(selection) {
                    const filtered = Data.filterData(selection);
                    
                    if (filtered.length === 0) {
                        throw new Error('No hay datos para esta selecci√≥n');
                    }

                    const groups = LabelGenerator.groupData(filtered);
                    
                    if (Object.keys(groups).length === 0) {
                        throw new Error('No se pudieron agrupar los datos');
                    }

                    return LabelGenerator.buildLabelHTML(selection, groups);
                },

                groupData(rows) {
                    const groups = {};
                    const cols = state.data.cols;
                    
                    for (const row of rows) {
                        const keyParts = [
                            String(row[cols['DESCRIPCI√ìN']] || '').trim(),
                            String(row[cols['MUNDO']] || '').trim(),
                            String(row[cols['MARCA']] || '').trim(),
                            String(row[cols['GENERO']] || '').trim(),
                            String(row[cols['PARIHUELA']] || '').trim(),
                            String(row[cols['CAJA']] || '').trim()
                        ];

                        if (state.activeMode === 'concodigo') {
                            keyParts.push(
                                String(row[cols['CODIGO']] || '').trim(),
                                String(row[cols['COLOR']] || '').trim()
                            );
                        }

                        const key = keyParts.join('|');
                        
                        if (!groups[key]) {
                            groups[key] = {
                                info: {
                                    proveedor: row[cols['ID Proveedor']] || '',
                                    marca: row[cols['MARCA']] || '',
                                    genero: row[cols['GENERO']] || '',
                                    descripcion: row[cols['DESCRIPCI√ìN']] || '',
                                    mundo: row[cols['MUNDO']] || '',
                                    parihuela: row[cols['PARIHUELA']] || '',
                                    caja: row[cols['CAJA']] || '',
                                    codigo: row[cols['CODIGO']] || '',
                                    color: row[cols['COLOR']] || '',
                                    validador: row[cols['VALIDADOR']] || ''
                                },
                                tallas: []
                            };
                        }
                        
                        const talla1 = String(row[cols['TALLA 1']] || '').trim();
                        const talla2 = String(row[cols['TALLA 2']] || '').trim();
                        const cantidad = String(row[cols['CANTIDAD']] || '').trim();
                        
                        if (talla1 || talla2 || cantidad) {
                            const existing = groups[key].tallas.find(t =>
                                String(t.talla1).trim() === talla1 && 
                                String(t.talla2).trim() === talla2
                            );
                            
                            if (existing) {
                                existing.cantidad = (parseFloat(existing.cantidad) || 0) + (parseFloat(cantidad) || 0);
                            } else {
                                groups[key].tallas.push({ talla1, talla2, cantidad });
                            }
                        }
                    }
                    
                    return groups;
                },

                buildLabelHTML(selection, groups) {
                    const card = document.createElement('div');
                    card.className = 'rotulo-preview';

                    const tipoTexto = state.activeMode === 'original' ? 'Original' : 'Con C√≥digo + Color';
                    
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'rotulo-content print-area';
                    contentDiv.innerHTML = LabelGenerator.buildContent(selection, groups);

                    card.appendChild(contentDiv);

                    return {
                        element: card,
                        html: card.outerHTML
                    };
                },

                buildContent(selection, groups) {
                    const totalStock = LabelGenerator.calculateTotalStock(groups);
                    const fecha = new Date().toLocaleDateString('es-ES', { month: '2-digit', year: 'numeric' });
                    const validador = LabelGenerator.getValidator(groups);

                    let html = `
                        <div class="rotulo">
                            <div class="rotulo-titulo">üì¶ R√ìTULO DE CAJA - ALMAC√âN RD50 üì¶</div>
                            <table class="rotulo-info-table">
                                <tr>
                                    <td class="rotulo-info-header">INFORMACI√ìN DE LA CAJA</td>
                                    <td class="rotulo-ubicacion-header">UBICACI√ìN DEL PRODUCTO</td>
                                </tr>
                            </table>
                            <table class="rotulo-data-table">
                                <tr>
                                    <td>Proveedor: ${Utils.escapeHtml(selection.proveedor)}</td>
                                    <td>Parihuela: ${Utils.escapeHtml(selection.parihuela)}</td>
                                </tr>
                                <tr>
                                    <td>Validador: ${Utils.escapeHtml(validador)}</td>
                                    <td>Caja: ${Utils.escapeHtml(selection.caja)}</td>
                                </tr>
                                <tr>
                                    <td>Fecha: ${fecha}</td>
                                    <td>Total Stock: ${totalStock}</td>
                                </tr>
                            </table>
                    `;

                    const byGenero = LabelGenerator.groupByGenero(groups);

                    for (const [genero, items] of Object.entries(byGenero)) {
                        html += `<div class="rotulo-section-title">=== ${Utils.escapeHtml(genero)} ===</div>`;

                        const uniqueProducts = LabelGenerator.groupUniqueProducts(items);

                        for (const product of Object.values(uniqueProducts)) {
                            html += `<div class="rotulo-producto-title">‚ñ∏ ${Utils.escapeHtml(product.descripcion)} | ${Utils.escapeHtml(product.mundo)} | ${Utils.escapeHtml(product.marca)}</div>`;

                            if (state.activeMode === 'concodigo' && (product.codigo || product.color)) {
                                html += `
                                    <table class="rotulo-codigo-table">
                                        <tr>
                                            <td>C√ìDIGO: ${Utils.escapeHtml(product.codigo || 'N/A')}</td>
                                            <td class="rotulo-codigo-col2">COLOR: ${Utils.escapeHtml(product.color || 'N/A')}</td>
                                        </tr>
                                    </table>
                                `;
                            }

                            html += LabelGenerator.buildSizesTable(product.tallas);
                        }
                    }

                    html += '</div>';
                    return html;
                },

                buildSizesTable(tallas) {
                    let html = `
                        <table class="rotulo-tallas-table">
                            <tr>
                                <th>T-1</th>
                                <th>T-2</th>
                                <th>CANT</th>
                                <th>Sticker</th>
                                <th>T-1</th>
                                <th>T-2</th>
                                <th>CANT</th>
                                <th>Sticker</th>
                            </tr>
                    `;

                    if (tallas.length === 0) {
                        html += '<tr><td>-</td><td>-</td><td>-</td><td class="rotulo-sticker-col"> </td><td>-</td><td>-</td><td>-</td><td class="rotulo-sticker-col"> </td></tr>';
                    } else {
                        for (let i = 0; i < tallas.length; i += 2) {
                            const t1 = tallas[i];
                            const t2 = i + 1 < tallas.length ? tallas[i + 1] : null;

                            html += '<tr>';
                            html += `<td>${Utils.escapeHtml(t1.talla1 || '-')}</td>`;
                            html += `<td>${Utils.escapeHtml(t1.talla2 || '-')}</td>`;
                            html += `<td>${Utils.escapeHtml(t1.cantidad || '0')}</td>`;
                            html += '<td class="rotulo-sticker-col"> </td>';
                            
                            if (t2) {
                                html += `<td>${Utils.escapeHtml(t2.talla1 || '-')}</td>`;
                                html += `<td>${Utils.escapeHtml(t2.talla2 || '-')}</td>`;
                                html += `<td>${Utils.escapeHtml(t2.cantidad || '0')}</td>`;
                                html += '<td class="rotulo-sticker-col"> </td>';
                            } else {
                                html += '<td> </td><td> </td><td> </td><td class="rotulo-sticker-col"> </td>';
                            }
                            
                            html += '</tr>';
                        }
                    }

                    html += '</table>';
                    return html;
                },

                groupByGenero(groups) {
                    const byGenero = {};
                    
                    for (const group of Object.values(groups)) {
                        const genero = group.info.genero || 'SIN G√âNERO';
                        if (!byGenero[genero]) byGenero[genero] = [];
                        byGenero[genero].push(group);
                    }
                    
                    return byGenero;
                },

                groupUniqueProducts(items) {
                    const unique = {};
                    
                    for (const item of items) {
                        const keyParts = [
                            item.info.descripcion,
                            item.info.mundo,
                            item.info.marca
                        ];

                        if (state.activeMode === 'concodigo') {
                            keyParts.push(item.info.codigo, item.info.color);
                        }

                        const key = keyParts.join('|');
                        
                        if (!unique[key]) {
                            unique[key] = {
                                descripcion: item.info.descripcion,
                                mundo: item.info.mundo,
                                marca: item.info.marca,
                                codigo: item.info.codigo,
                                color: item.info.color,
                                tallas: []
                            };
                        }
                        
                        unique[key].tallas.push(...item.tallas);
                    }
                    
                    return unique;
                },

                calculateTotalStock(groups) {
                    let total = 0;
                    for (const group of Object.values(groups)) {
                        for (const talla of group.tallas) {
                            total += parseFloat(talla.cantidad) || 0;
                        }
                    }
                    return total;
                },

                getValidator(groups) {
                    const validators = Object.values(groups)
                        .map(g => g.info.validador)
                        .filter(v => v);
                    return validators[0] || 'N/A';
                }
            };

            const Export = {
                async exportSingleToPDF(selection) {
                    try {
                        UI.showSpinner(true);
                        const pdf = await Export.generateDirectPDF(selection);
                        pdf.save(`rotulo-${selection.parihuela}-${selection.caja}-${Date.now()}.pdf`);
                        UI.showToast('‚úì PDF exportado correctamente');
                    } catch (error) {
                        console.error('Error exportando PDF:', error);
                        UI.showStatus('Error al exportar PDF: ' + error.message, 'error');
                    } finally {
                        UI.showSpinner(false);
                    }
                },

                async exportAllToPDF() {
                    if (state.generatedLabels.length === 0) {
                        UI.showStatus('No hay r√≥tulos para exportar', 'warning');
                        return;
                    }

                    try {
                        UI.showSpinner(true);
                        const { jsPDF } = window.jspdf;
                        const pdf = new jsPDF('p', 'pt', 'a4');
                        
                        for (let i = 0; i < state.generatedLabels.length; i++) {
                            if (i > 0) pdf.addPage();
                            await Export.drawPDFContent(pdf, state.generatedLabels[i].selection);
                        }
                        
                        pdf.save(`rotulos-lukers-${Date.now()}.pdf`);
                        UI.showToast(`‚úì ${state.generatedLabels.length} r√≥tulos exportados a PDF`);
                    } catch (error) {
                        console.error('Error:', error);
                        UI.showStatus('Error exportando PDFs: ' + error.message, 'error');
                    } finally {
                        UI.showSpinner(false);
                    }
                },

                async generateDirectPDF(selection) {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'pt', 'a4');
                    await Export.drawPDFContent(pdf, selection);
                    return pdf;
                },

                async drawPDFContent(pdf, selection) {
                    const filtered = Data.filterData(selection);
                    const groups = LabelGenerator.groupData(filtered);
                    
                    const marginTop = 3;
                    const marginLeft = 12;
                    
                    let yPos = marginTop;
                    
                    pdf.setFontSize(14);
                    pdf.setFont('helvetica', 'bold');
                    pdf.text('ROTULO DE CAJA - ALMACEN RD50', 297.5, yPos + 15, { align: 'center' });
                    yPos += 20;
                    
                    pdf.setDrawColor(51, 51, 51);
                    pdf.setLineWidth(1);
                    
                    pdf.setFillColor(68, 114, 196);
                    pdf.rect(marginLeft, yPos, 285, 20, 'FD');
                    pdf.setFillColor(231, 76, 60);
                    pdf.rect(marginLeft + 285, yPos, 286, 20, 'FD');
                    
                    pdf.setFontSize(11);
                    pdf.setTextColor(255, 255, 255);
                    pdf.text('INFORMACI√ìN DE LA CAJA', marginLeft + 142.5, yPos + 13, { align: 'center' });
                    pdf.text('UBICACI√ìN DEL PRODUCTO', marginLeft + 285 + 143, yPos + 13, { align: 'center' });
                    yPos += 20;
                    
                    pdf.setTextColor(0, 0, 0);
                    pdf.setFontSize(9);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setDrawColor(102, 102, 102);
                    pdf.setLineWidth(0.5);
                    
                    const totalStock = LabelGenerator.calculateTotalStock(groups);
                    const fecha = new Date().toLocaleDateString('es-ES', { month: '2-digit', year: 'numeric' });
                    const validador = LabelGenerator.getValidator(groups);
                    
                    pdf.rect(marginLeft, yPos, 285, 18);
                    pdf.rect(marginLeft + 285, yPos, 286, 18);
                    pdf.text(`Proveedor: ${selection.proveedor}`, marginLeft + 5, yPos + 12);
                    pdf.text(`Parihuela: ${selection.parihuela}`, marginLeft + 285 + 5, yPos + 12);
                    yPos += 18;
                    
                    pdf.rect(marginLeft, yPos, 285, 18);
                    pdf.rect(marginLeft + 285, yPos, 286, 18);
                    pdf.text(`Validador: ${validador}`, marginLeft + 5, yPos + 12);
                    pdf.text(`Caja: ${selection.caja}`, marginLeft + 285 + 5, yPos + 12);
                    yPos += 18;
                    
                    pdf.rect(marginLeft, yPos, 285, 18);
                    pdf.rect(marginLeft + 285, yPos, 286, 18);
                    pdf.text(`Fecha: ${fecha}`, marginLeft + 5, yPos + 12);
                    pdf.text(`Total Stock: ${totalStock}`, marginLeft + 285 + 5, yPos + 12);
                    yPos += 25;
                    
                    const byGenero = LabelGenerator.groupByGenero(groups);
                    
                    for (const [genero, items] of Object.entries(byGenero)) {
                        yPos += 5;
                        pdf.setFontSize(11);
                        pdf.setFont('helvetica', 'bold');
                        pdf.text(`=== ${genero} ===`, 297.5, yPos, { align: 'center' });
                        yPos += 10;
                        
                        const uniqueProducts = LabelGenerator.groupUniqueProducts(items);
                        
                        for (const product of Object.values(uniqueProducts)) {
                            pdf.setFontSize(10);
                            pdf.text(`${product.descripcion} | ${product.mundo} | ${product.marca}`, 297.5, yPos, { align: 'center' });
                            yPos += 8;
                            
                            if (state.activeMode === 'concodigo' && (product.codigo || product.color)) {
                                pdf.setFontSize(9);
                                pdf.setFont('helvetica', 'normal');
                                pdf.text(`CODIGO: ${product.codigo || 'N/A'}`, marginLeft, yPos);
                                pdf.text(`COLOR: ${product.color || 'N/A'}`, marginLeft + 571, yPos, { align: 'right' });
                                yPos += 10;
                                pdf.setFont('helvetica', 'bold');
                            }
                            
                            yPos = Export.drawSizesTable(pdf, product.tallas, marginLeft, yPos);
                            yPos += 8;
                        }
                    }
                },

                drawSizesTable(pdf, tallas, x, y) {
                    pdf.setDrawColor(51, 51, 51);
                    pdf.setLineWidth(1);
                    
                    const colWidths = [45, 45, 44, 150, 45, 45, 44, 150];
                    const rowHeight = 70;
                    const headerHeight = 20;
                    
                    pdf.setFontSize(9);
                    pdf.setFont('helvetica', 'bold');
                    
                    const headers = ['T-1', 'T-2', 'CANT', 'Sticker', 'T-1', 'T-2', 'CANT', 'Sticker'];
                    let xPos = x;
                    
                    for (let i = 0; i < headers.length; i++) {
                        pdf.setFillColor(255, 255, 255);
                        pdf.rect(xPos, y, colWidths[i], headerHeight, 'FD');
                        pdf.text(headers[i], xPos + colWidths[i]/2, y + 13, { align: 'center' });
                        xPos += colWidths[i];
                    }
                    y += headerHeight;
                    
                    pdf.setFont('helvetica', 'normal');
                    pdf.setFontSize(12);
                    
                    if (tallas.length === 0) {
                        xPos = x;
                        for (let i = 0; i < 8; i++) {
                            pdf.setFillColor(255, 255, 255);
                            pdf.rect(xPos, y, colWidths[i], rowHeight, 'FD');
                            if (i !== 3 && i !== 7) {
                                pdf.text('-', xPos + colWidths[i]/2, y + rowHeight/2 + 4, { align: 'center' });
                            }
                            xPos += colWidths[i];
                        }
                        y += rowHeight;
                    } else {
                        for (let i = 0; i < tallas.length; i += 2) {
                            const t1 = tallas[i];
                            const t2 = i + 1 < tallas.length ? tallas[i + 1] : null;
                            
                            xPos = x;
                            
                            pdf.setFillColor(255, 255, 255);
                            pdf.rect(xPos, y, colWidths[0], rowHeight, 'FD');
                            pdf.text(t1.talla1 || '-', xPos + colWidths[0]/2, y + rowHeight/2 + 4, { align: 'center' });
                            xPos += colWidths[0];
                            
                            pdf.setFillColor(255, 255, 255);
                            pdf.rect(xPos, y, colWidths[1], rowHeight, 'FD');
                            pdf.text(t1.talla2 || '-', xPos + colWidths[1]/2, y + rowHeight/2 + 4, { align: 'center' });
                            xPos += colWidths[1];
                            
                            pdf.setFillColor(255, 255, 255);
                            pdf.rect(xPos, y, colWidths[2], rowHeight, 'FD');
                            pdf.text(String(t1.cantidad || '0'), xPos + colWidths[2]/2, y + rowHeight/2 + 4, { align: 'center' });
                            xPos += colWidths[2];
                            
                            pdf.setFillColor(255, 255, 255);
                            pdf.rect(xPos, y, colWidths[3], rowHeight, 'FD');
                            xPos += colWidths[3];
                            
                            if (t2) {
                                pdf.setFillColor(255, 255, 255);
                                pdf.rect(xPos, y, colWidths[4], rowHeight, 'FD');
                                pdf.text(t2.talla1 || '-', xPos + colWidths[4]/2, y + rowHeight/2 + 4, { align: 'center' });
                                xPos += colWidths[4];
                                
                                pdf.setFillColor(255, 255, 255);
                                pdf.rect(xPos, y, colWidths[5], rowHeight, 'FD');
                                pdf.text(t2.talla2 || '-', xPos + colWidths[5]/2, y + rowHeight/2 + 4, { align: 'center' });
                                xPos += colWidths[5];
                                
                                pdf.setFillColor(255, 255, 255);
                                pdf.rect(xPos, y, colWidths[6], rowHeight, 'FD');
                                pdf.text(String(t2.cantidad || '0'), xPos + colWidths[6]/2, y + rowHeight/2 + 4, { align: 'center' });
                                xPos += colWidths[6];
                                
                                pdf.setFillColor(255, 255, 255);
                                pdf.rect(xPos, y, colWidths[7], rowHeight, 'FD');
                            } else {
                                for (let j = 4; j < 8; j++) {
                                    pdf.setFillColor(255, 255, 255);
                                    pdf.rect(xPos, y, colWidths[j], rowHeight, 'FD');
                                    xPos += colWidths[j];
                                }
                            }
                            
                            y += rowHeight;
                        }
                    }
                    
                    return y;
                }
            };

            const Analysis = {
                analyze() {
                    if (!state.data) {
                        UI.showStatus('Primero carga los datos', 'warning');
                        return;
                    }

                    const values = state.data.values;
                    const cols = state.data.cols;
                    
                    const totalRecords = values.length - 1;
                    const groups = {};

                    for (let i = 1; i < values.length; i++) {
                        const row = values[i];
                        const key = [
                            row[cols['DESCRIPCI√ìN']],
                            row[cols['MUNDO']],
                            row[cols['MARCA']],
                            row[cols['GENERO']],
                            row[cols['PARIHUELA']],
                            row[cols['CAJA']]
                        ].join('|');
                        
                        groups[key] = (groups[key] || 0) + 1;
                    }

                    const totalGroups = Object.keys(groups).length;
                    const maxSizes = Math.max(...Object.values(groups));
                    const largeGroups = Object.values(groups).filter(c => c > 20).length;
                    const avgSizes = (totalRecords / totalGroups).toFixed(1);

                    const resultsDiv = document.getElementById('analysisResults');
                    resultsDiv.innerHTML = `
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px;">
                            <h4 style="color: #1e88e5; margin-bottom: 15px;">An√°lisis de Clasificaci√≥n</h4>
                            <div class="stats-grid">
                                <div class="stat-card" style="border-left-color: #28a745;">
                                    <div class="stat-value">${totalRecords.toLocaleString()}</div>
                                    <div class="stat-label">Total Registros</div>
                                </div>
                                <div class="stat-card" style="border-left-color: #1e88e5;">
                                    <div class="stat-value">${totalGroups.toLocaleString()}</div>
                                    <div class="stat-label">Grupos √önicos</div>
                                </div>
                                <div class="stat-card" style="border-left-color: #ffc107;">
                                    <div class="stat-value">${state.data.providers.length}</div>
                                    <div class="stat-label">Proveedores</div>
                                </div>
                                <div class="stat-card" style="border-left-color: #dc3545;">
                                    <div class="stat-value">${maxSizes}</div>
                                    <div class="stat-label">M√°x Tallas/Grupo</div>
                                </div>
                                <div class="stat-card" style="border-left-color: #17a2b8;">
                                    <div class="stat-value">${avgSizes}</div>
                                    <div class="stat-label">Promedio Tallas</div>
                                </div>
                                <div class="stat-card" style="border-left-color: #6f42c1;">
                                    <div class="stat-value">${state.data.generos.length}</div>
                                    <div class="stat-label">G√©neros</div>
                                </div>
                            </div>
                            ${largeGroups > 0 ? `
                                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; padding: 15px; margin-top: 15px;">
                                    <strong style="color: #856404;">‚ö†Ô∏è Atenci√≥n:</strong> 
                                    ${largeGroups} grupos tienen m√°s de 20 tallas
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    UI.showStatus('An√°lisis completado', 'success');
                },

                exportAnalysis() {
                    const results = document.getElementById('analysisResults');
                    if (!results.innerHTML) {
                        UI.showStatus('Primero ejecuta el an√°lisis', 'warning');
                        return;
                    }

                    const text = results.innerText;
                    const blob = new Blob([text], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `analisis-lukers-${Date.now()}.txt`;
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    UI.showToast('‚úì An√°lisis exportado');
                }
            };

            const History = {
                addBatch(labels) {
                    const history = History.load();
                    const batch = {
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        count: labels.length,
                        labels: labels.map(l => ({
                            proveedor: l.selection.proveedor,
                            parihuela: l.selection.parihuela,
                            caja: l.selection.caja
                        }))
                    };
                    history.unshift(batch);
                    
                    if (history.length > 50) history.length = 50;
                    
                    History.save(history);
                    History.render();
                },

                load() {
                    try {
                        const data = sessionStorage.getItem('lukers_history');
                        return data ? JSON.parse(data) : [];
                    } catch {
                        return [];
                    }
                },

                save(history) {
                    try {
                        sessionStorage.setItem('lukers_history', JSON.stringify(history));
                    } catch (e) {
                        console.warn('No se pudo guardar el historial:', e);
                    }
                },

                render() {
                    const history = History.load();
                    const container = document.getElementById('historyList');
                    
                    if (history.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No hay historial de r√≥tulos generados</p>';
                        return;
                    }

                    container.innerHTML = history.map(batch => {
                        const date = new Date(batch.timestamp);
                        const timeStr = date.toLocaleString('es-ES');
                        
                        return `
                            <div class="history-item">
                                <div class="history-info">
                                    <strong>${batch.count} r√≥tulo${batch.count !== 1 ? 's' : ''}</strong>
                                    <div class="history-timestamp">${timeStr}</div>
                                    <small>${batch.labels.map(l => `P${l.parihuela}-C${l.caja}`).join(', ')}</small>
                                </div>
                            </div>
                        `;
                    }).join('');
                },

                clear() {
                    if (confirm('¬øEst√°s seguro de que deseas limpiar todo el historial?')) {
                        History.save([]);
                        History.render();
                        UI.showToast('‚úì Historial limpiado');
                    }
                }
            };

// Continuaci√≥n - Secci√≥n UI...

            const UI = {
                toggleUserMenu() {
                    const dropdown = document.getElementById('userDropdown');
                    const btn = document.getElementById('userMenuBtn');
                    
                    dropdown.classList.toggle('active');
                    btn.classList.toggle('active');
                },

                closeUserMenu() {
                    const dropdown = document.getElementById('userDropdown');
                    const btn = document.getElementById('userMenuBtn');
                    
                    dropdown.classList.remove('active');
                    btn.classList.remove('active');
                },

                openModal(modalId) {
                    document.getElementById(modalId).classList.add('active');
                },

                closeModal(modalId) {
                    document.getElementById(modalId).classList.remove('active');
                },

                updateCompactStatus(isConnected, statusText) {
                    const dot = document.getElementById('statusDotCompact');
                    const text = document.getElementById('statusTextCompact');
                    
                    if (isConnected) {
                        dot.classList.add('connected');
                        text.textContent = statusText || 'Autenticado';
                    } else {
                        dot.classList.remove('connected');
                        text.textContent = statusText || 'Sin autenticar';
                    }

                    const dropdownStatus = document.getElementById('dropdownAuthStatus');
                    if (isConnected) {
                        dropdownStatus.textContent = 'üü¢ ' + (statusText || 'Autenticado');
                        document.getElementById('dropdownUserActions').style.display = 'block';
                        document.getElementById('dropdownGuestActions').style.display = 'none';
                    } else {
                        dropdownStatus.textContent = 'üî¥ ' + (statusText || 'No autenticado');
                        document.getElementById('dropdownUserActions').style.display = 'none';
                        document.getElementById('dropdownGuestActions').style.display = 'block';
                    }
                },

                updateAuthStatus(isSignedIn, isAdmin = false) {
                    if (isAdmin) {
                        const indicator = document.getElementById('statusIndicatorAdmin');
                        const status = document.getElementById('authStatusAdmin');
                        const signInBtn = document.getElementById('signInBtnAdmin');
                        const signOutBtn = document.getElementById('signOutBtnAdmin');

                        if (isSignedIn) {
                            indicator.className = 'status-indicator connected';
                            status.textContent = 'Autenticado (Admin)';
                            signInBtn.style.display = 'none';
                            signOutBtn.style.display = 'inline-block';
                        } else {
                            indicator.className = 'status-indicator disconnected';
                            status.textContent = 'No autenticado';
                            signInBtn.style.display = 'inline-block';
                            signOutBtn.style.display = 'none';
                        }
                    }
                },

                showStatus(message, type) {
                    const statusDiv = document.getElementById('statusMessage');
                    statusDiv.className = `status-message status-${type}`;
                    statusDiv.textContent = message;
                    statusDiv.style.display = 'block';

                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 5000);
                },

                showToast(message) {
                    const toast = document.getElementById('toast');
                    toast.textContent = message;
                    toast.classList.add('active');

                    setTimeout(() => {
                        toast.classList.remove('active');
                    }, 3000);
                },

                showSpinner(show) {
                    document.getElementById('spinnerOverlay').classList.toggle('active', show);
                },

                switchTab(event, tabName) {
                    document.querySelectorAll('.tab').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    event.target.classList.add('active');
                    document.getElementById(tabName + 'Tab').classList.add('active');

                    if (tabName === 'history') {
                        History.render();
                    }
                },

                switchMethod(methodNum) {
                    state.activeMethod = methodNum;
                    
                    document.querySelectorAll('.method-tab').forEach((tab, index) => {
                        tab.classList.toggle('active', index + 1 === methodNum);
                    });
                    
                    document.querySelectorAll('.method-content').forEach((content, index) => {
                        content.classList.toggle('active', index + 1 === methodNum);
                    });
                },

                populateProviders(providers) {
                    const select = document.getElementById('proveedorSelect');
                    select.innerHTML = '<option value="">-- Selecciona un proveedor --</option>';
                    
                    providers.forEach(provider => {
                        const option = document.createElement('option');
                        option.value = provider;
                        option.textContent = provider;
                        select.appendChild(option);
                    });
                },

                // NUEVA FUNCI√ìN: Cargar parihuelas como chips visuales
                loadParihuelas(provider) {
                    const combinations = state.data.combinationsByProvider[provider] || [];
                    const parihuelas = [...new Set(combinations.map(c => c.parihuela))];
                    
                    const grid = document.getElementById('parihulaGrid');
                    grid.innerHTML = '';
                    
                    parihuelas.forEach(parihuela => {
                        const cajasCount = combinations.filter(c => c.parihuela === parihuela).length;
                        
                        const chip = document.createElement('div');
                        chip.className = 'parihuela-chip';
                        chip.dataset.parihuela = parihuela;
                        chip.innerHTML = `
                            <div>${parihuela}</div>
                            <div class="caja-count">${cajasCount} cajas</div>
                        `;
                        
                        chip.addEventListener('click', () => UI.selectParihuela(parihuela));
                        grid.appendChild(chip);
                    });

                    document.getElementById('parihuselaSection').style.display = 'block';
                },

                // NUEVA FUNCI√ìN: Seleccionar una parihuela
                selectParihuela(parihuela) {
                    // Deseleccionar todas
                    document.querySelectorAll('.parihuela-chip').forEach(chip => {
                        chip.classList.remove('selected');
                    });
                    
                    // Seleccionar la clickeada
                    const selectedChip = document.querySelector(`[data-parihuela="${parihuela}"]`);
                    if (selectedChip) {
                        selectedChip.classList.add('selected');
                    }
                    
                    state.selectedParihuela = parihuela;
                    
                    // Cargar cajas para esta parihuela
                    UI.loadCajasForParihuela(state.selectedProvider, parihuela);
                    
                    // Mostrar secci√≥n de m√©todos
                    document.getElementById('methodSection').style.display = 'block';
                    document.getElementById('actionSection').style.display = 'block';
                },

                // NUEVA FUNCI√ìN: Cargar cajas filtradas por parihuela
                loadCajasForParihuela(provider, parihuela) {
                    const cajas = Data.getCajasForParihuela(provider, parihuela);
                    
                    // Llenar select de m√©todo directo
                    UI.populateSelectSimple('cajaDirecta', cajas, '-- Selecciona una caja --');
                    
                    // Llenar selects de m√©todo rango
                    UI.populateSelectSimple('cajaDesde', cajas, 'Inicio');
                    UI.populateSelectSimple('cajaHasta', cajas, 'Fin');
                    
                    // Llenar checkboxes de m√©todo m√∫ltiple
                    UI.loadCheckboxList(provider, parihuela, cajas);
                },

                populateSelectSimple(selectId, options, placeholder) {
                    const select = document.getElementById(selectId);
                    select.innerHTML = `<option value="">${placeholder}</option>`;
                    
                    options.forEach(option => {
                        const opt = document.createElement('option');
                        opt.value = option;
                        opt.textContent = option;
                        select.appendChild(opt);
                    });
                },

                loadCheckboxList(provider, parihuela, cajas) {
                    const lista = document.getElementById('checkboxList');
                    lista.innerHTML = '';
                    
                    cajas.forEach((caja, index) => {
                        const item = document.createElement('div');
                        item.className = 'checkbox-item-compact';
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = `caja_${index}`;
                        checkbox.value = caja;
                        checkbox.addEventListener('change', UI.updateCounter);
                        
                        const label = document.createElement('label');
                        label.htmlFor = `caja_${index}`;
                        label.textContent = `Caja ${caja}`;
                        
                        item.appendChild(checkbox);
                        item.appendChild(label);
                        lista.appendChild(item);
                    });
                    
                    UI.updateCounter();
                },

                selectAll() {
                    document.querySelectorAll('#checkboxList input[type="checkbox"]').forEach(cb => {
                        cb.checked = true;
                    });
                    UI.updateCounter();
                },

                selectNone() {
                    document.querySelectorAll('#checkboxList input[type="checkbox"]').forEach(cb => {
                        cb.checked = false;
                    });
                    UI.updateCounter();
                },

                updateCounter() {
                    const count = document.querySelectorAll('#checkboxList input[type="checkbox"]:checked').length;
                    document.getElementById('selectionCounter').textContent = 
                        `${count} seleccionada${count !== 1 ? 's' : ''}`;
                },

                showPreview(count, provider, mode) {
                    document.getElementById('previewEmpty').style.display = 'none';
                    document.getElementById('previewContent').style.display = 'block';
                    document.getElementById('previewActions').style.display = 'flex';
                    
                    document.getElementById('previewCount').textContent = count;
                    document.getElementById('previewProvider').textContent = provider;
                    document.getElementById('previewMode').textContent = mode === 'original' ? 'Original' : 'C√≥digo';
                },

                hidePreview() {
                    document.getElementById('previewEmpty').style.display = 'block';
                    document.getElementById('previewContent').style.display = 'none';
                    document.getElementById('previewActions').style.display = 'none';
                    document.getElementById('rotulosList').innerHTML = '';
                },

                resetSelections() {
                    state.selectedProvider = '';
                    state.selectedParihuela = '';
                    
                    document.getElementById('proveedorSelect').value = '';
                    document.getElementById('parihuselaSection').style.display = 'none';
                    document.getElementById('methodSection').style.display = 'none';
                    document.getElementById('actionSection').style.display = 'none';
                    
                    UI.hidePreview();
                }
            };

            const Utils = {
                escapeHtml(text) {
                    const map = {
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        '"': '&quot;',
                        "'": '&#039;'
                    };
                    return String(text).replace(/[&<>"']/g, m => map[m]);
                }
            };

            const Verification = {
                async loadAndCompare() {
                    if (!state.gapiInited || !state.gisInited) {
                        UI.showStatus('Debes iniciar sesi√≥n primero', 'error');
                        return;
                    }

                    try {
                        UI.showSpinner('Cargando datos para comparaci√≥n...');
                        
                        // Asegurar que ambos datos est√©n cargados
                        if (!state.data) {
                            await Data.loadProviders();
                        }
                        
                        // Cargar datos de Inventario Final
                        const inventarioData = await this.loadInventarioFinalData();
                        
                        // Realizar comparaci√≥n
                        this.compareData(inventarioData);
                        
                    } catch (error) {
                        console.error('Error:', error);
                        const statusDiv = document.getElementById('verificationStatus');
                        statusDiv.innerHTML = `<div class="status-message status-error">Error: ${error.message}</div>`;
                    } finally {
                        UI.hideSpinner();
                    }
                },

                async loadInventarioFinalData() {
                    try {
                        const response = await gapi.client.sheets.spreadsheets.values.get({
                            spreadsheetId: Config.INVENTARIO_FINAL_SHEET_ID,
                            range: 'Inventario Final!A2:Z',
                        });

                        const rows = response.result.values;
                        if (!rows || rows.length === 0) {
                            throw new Error('No se encontraron datos en Inventario Final');
                        }

                        state.inventarioFinalData = rows;
                        return rows;
                        
                    } catch (error) {
                        console.error('Error cargando Inventario Final:', error);
                        throw error;
                    }
                },

                compareData(inventarioData) {
                    const results = [];
                    
                    // Crear un mapa de Clasificaci√≥n para b√∫squeda r√°pida
                    const clasificacionMap = new Map();
                    if (state.data && state.data.values) {
                        state.data.values.forEach(row => {
                            const idDetalle = row[state.data.cols['ID Detalle']];
                            if (idDetalle) {
                                clasificacionMap.set(idDetalle, {
                                    idProveedor: row[state.data.cols['ID Proveedor']],
                                    paquete: row[state.data.cols['Paquete']],
                                    marca: row[state.data.cols['MARCA']],
                                    genero: row[state.data.cols['GENERO']],
                                    descripcion: row[state.data.cols['DESCRIPCI√ìN']],
                                    mundo: row[state.data.cols['MUNDO']],
                                    talla1: row[state.data.cols['TALLA 1']],
                                    talla2: row[state.data.cols['TALLA 2']],
                                    cantidad: row[state.data.cols['CANTIDAD']],
                                    parihuela: row[state.data.cols['PARIHUELA']],
                                    caja: row[state.data.cols['CAJA']],
                                    color: row[state.data.cols['COLOR']],
                                    codigo: row[state.data.cols['CODIGO']],
                                });
                            }
                        });
                    }

                    // Comparar cada registro de Inventario Final
                    inventarioData.forEach(invRow => {
                        const idDetalle = invRow[1]; // Columna B: ID Detalle
                        const clasificacionRow = clasificacionMap.get(idDetalle);

                        const result = {
                            idDetalle: idDetalle || '-',
                            idProveedor: invRow[0] || '-',
                            marca: invRow[3] || '-',
                            descripcion: invRow[5] || '-',
                            status: '',
                            fieldsDifferent: []
                        };

                        if (!clasificacionRow) {
                            result.status = 'missing';
                        } else {
                            // Comparar cada campo
                            const differences = [];
                            
                            if (invRow[0] !== clasificacionRow.idProveedor) differences.push('ID Proveedor');
                            if (invRow[2] !== clasificacionRow.paquete) differences.push('Paquete');
                            if (invRow[3] !== clasificacionRow.marca) differences.push('MARCA');
                            if (invRow[4] !== clasificacionRow.genero) differences.push('GENERO');
                            if (invRow[5] !== clasificacionRow.descripcion) differences.push('DESCRIPCI√ìN');
                            if (invRow[6] !== clasificacionRow.mundo) differences.push('MUNDO');
                            if (invRow[7] !== clasificacionRow.talla1) differences.push('TALLA 1');
                            if (invRow[8] !== clasificacionRow.talla2) differences.push('TALLA 2');
                            if (invRow[9] !== clasificacionRow.cantidad) differences.push('CANTIDAD');
                            if (invRow[10] !== clasificacionRow.parihuela) differences.push('PARIHUELA');
                            if (invRow[11] !== clasificacionRow.caja) differences.push('CAJA');
                            if (invRow[12] !== clasificacionRow.color) differences.push('COLOR');
                            if (invRow[13] !== clasificacionRow.codigo) differences.push('CODIGO');

                            if (differences.length > 0) {
                                result.status = 'diff';
                                result.fieldsDifferent = differences;
                            } else {
                                result.status = 'synced';
                            }
                        }

                        results.push(result);
                    });

                    state.comparisonResults = results;
                    this.displayResults();
                },

                displayResults() {
                    // Calcular estad√≠sticas
                    const synced = state.comparisonResults.filter(r => r.status === 'synced').length;
                    const diff = state.comparisonResults.filter(r => r.status === 'diff').length;
                    const missing = state.comparisonResults.filter(r => r.status === 'missing').length;
                    const total = state.comparisonResults.length;

                    // Actualizar estad√≠sticas
                    document.getElementById('statSynced').textContent = synced;
                    document.getElementById('statDiff').textContent = diff;
                    document.getElementById('statMissing').textContent = missing;
                    document.getElementById('statTotal').textContent = total;

                    // Poblar selectores
                    this.populateFilters();

                    // Mostrar secciones
                    document.getElementById('statsSection').style.display = 'block';
                    document.getElementById('resultsSection').style.display = 'block';

                    // Mostrar mensaje de √©xito
                    const statusDiv = document.getElementById('verificationStatus');
                    statusDiv.innerHTML = `<div class="status-message status-success">‚úì Comparaci√≥n completada: ${total} registros analizados</div>`;

                    // Renderizar tabla
                    this.renderTable();
                },

                populateFilters() {
                    // Poblar selector de Proveedor
                    const proveedores = [...new Set(state.comparisonResults.map(r => r.idProveedor).filter(p => p && p !== '-'))].sort();
                    const proveedorSelect = document.getElementById('verProveedorSelect');
                    proveedorSelect.innerHTML = '<option value="">Todos los proveedores</option>';
                    proveedores.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p;
                        option.textContent = p;
                        proveedorSelect.appendChild(option);
                    });

                    // Poblar selector de Marca
                    const marcas = [...new Set(state.comparisonResults.map(r => r.marca).filter(m => m && m !== '-'))].sort();
                    const marcaSelect = document.getElementById('verMarcaSelect');
                    marcaSelect.innerHTML = '<option value="">Todas las marcas</option>';
                    marcas.forEach(m => {
                        const option = document.createElement('option');
                        option.value = m;
                        option.textContent = m;
                        marcaSelect.appendChild(option);
                    });

                    // Poblar selector de ID Detalle
                    const idDetalles = state.comparisonResults.map(r => r.idDetalle).filter(id => id && id !== '-').sort();
                    const searchSelect = document.getElementById('verSearchInput');
                    searchSelect.innerHTML = '<option value="">Todos los ID Detalle</option>';
                    idDetalles.forEach(id => {
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = id;
                        searchSelect.appendChild(option);
                    });
                },

                filterResults() {
                    state.currentPage = 1;
                    this.renderTable();
                },

                clearFilters() {
                    document.getElementById('verProveedorSelect').value = '';
                    document.getElementById('verStatusSelect').value = 'all';
                    document.getElementById('verMarcaSelect').value = '';
                    document.getElementById('verSearchInput').value = '';
                    this.filterResults();
                    UI.showToast('Filtros limpiados');
                },

                getFilteredResults() {
                    let filtered = state.comparisonResults;

                    // Filtro por estado
                    const statusFilter = document.getElementById('verStatusSelect').value;
                    if (statusFilter !== 'all') {
                        filtered = filtered.filter(r => r.status === statusFilter);
                    }

                    // Filtro por proveedor
                    const proveedorFilter = document.getElementById('verProveedorSelect').value;
                    if (proveedorFilter) {
                        filtered = filtered.filter(r => r.idProveedor === proveedorFilter);
                    }

                    // Filtro por marca
                    const marcaFilter = document.getElementById('verMarcaSelect').value;
                    if (marcaFilter) {
                        filtered = filtered.filter(r => r.marca === marcaFilter);
                    }

                    // Filtro por ID Detalle
                    const searchFilter = document.getElementById('verSearchInput').value;
                    if (searchFilter) {
                        filtered = filtered.filter(r => r.idDetalle === searchFilter);
                    }

                    return filtered;
                },

                renderTable() {
                    const filtered = this.getFilteredResults();
                    const tbody = document.getElementById('verificationTableBody');
                    tbody.innerHTML = '';

                    // Paginaci√≥n
                    const totalPages = Math.ceil(filtered.length / state.itemsPerPage);
                    const start = (state.currentPage - 1) * state.itemsPerPage;
                    const end = start + state.itemsPerPage;
                    const pageResults = filtered.slice(start, end);

                    // Renderizar filas
                    pageResults.forEach(result => {
                        const row = document.createElement('tr');
                        
                        let statusBadge = '';
                        let statusText = '';
                        
                        if (result.status === 'synced') {
                            statusBadge = '<span class="status-badge success">‚úÖ Sincronizado</span>';
                            statusText = '-';
                        } else if (result.status === 'diff') {
                            statusBadge = '<span class="status-badge warning">‚ö†Ô∏è Diferencias</span>';
                            statusText = `<span class="fields-different">${result.fieldsDifferent.join(', ')}</span>`;
                        } else if (result.status === 'missing') {
                            statusBadge = '<span class="status-badge danger">‚ùå No Existe</span>';
                            statusText = 'No existe en Clasificaci√≥n';
                        }

                        row.innerHTML = `
                            <td>${result.idDetalle}</td>
                            <td>${result.idProveedor}</td>
                            <td>${result.marca}</td>
                            <td>${result.descripcion}</td>
                            <td>${statusBadge}</td>
                            <td>${statusText}</td>
                        `;
                        
                        tbody.appendChild(row);
                    });

                    // Actualizar info de paginaci√≥n
                    document.getElementById('pageInfo').textContent = `P√°gina ${state.currentPage} de ${totalPages || 1} (${filtered.length} registros)`;
                },

                previousPage() {
                    if (state.currentPage > 1) {
                        state.currentPage--;
                        this.renderTable();
                    }
                },

                nextPage() {
                    const filtered = this.getFilteredResults();
                    const totalPages = Math.ceil(filtered.length / state.itemsPerPage);
                    
                    if (state.currentPage < totalPages) {
                        state.currentPage++;
                        this.renderTable();
                    }
                },

                exportToCSV() {
                    if (state.comparisonResults.length === 0) {
                        UI.showToast('‚ö†Ô∏è No hay datos para exportar');
                        return;
                    }

                    const filtered = this.getFilteredResults();
                    
                    let csv = 'ID Detalle,ID Proveedor,Marca,Descripci√≥n,Estado,Campos Diferentes\n';
                    
                    filtered.forEach(result => {
                        const status = result.status === 'synced' ? 'Sincronizado' : 
                                     result.status === 'diff' ? 'Diferencias' : 
                                     'No Existe';
                        const fields = result.fieldsDifferent.join('; ');
                        
                        csv += `"${result.idDetalle}","${result.idProveedor}","${result.marca}","${result.descripcion}","${status}","${fields}"\n`;
                    });

                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    
                    link.setAttribute('href', url);
                    link.setAttribute('download', `verificacion_${new Date().toISOString().slice(0,10)}.csv`);
                    link.style.visibility = 'hidden';
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    UI.showToast('‚úì CSV exportado exitosamente');
                }
            };

            function getSelections() {
                const provider = state.selectedProvider;
                const parihuela = state.selectedParihuela;
                const selections = [];

                if (!provider || !parihuela) {
                    return selections;
                }

                if (state.activeMethod === 1) {
                    // M√©todo directo
                    const caja = document.getElementById('cajaDirecta').value;
                    if (caja) {
                        selections.push({ proveedor: provider, parihuela, caja });
                    }
                } else if (state.activeMethod === 2) {
                    // M√©todo rango
                    const desde = document.getElementById('cajaDesde').value;
                    const hasta = document.getElementById('cajaHasta').value;
                    
                    if (desde && hasta) {
                        if (!Validation.validateRange(desde, hasta)) {
                            UI.showStatus('Rango inv√°lido: "Desde" debe ser menor o igual a "Hasta"', 'error');
                            return [];
                        }

                        const cajas = Data.getCajasForParihuela(provider, parihuela);
                        const inRange = cajas.filter(c => {
                            const cajaNum = parseFloat(c);
                            const desdeNum = parseFloat(desde);
                            const hastaNum = parseFloat(hasta);
                            return cajaNum >= desdeNum && cajaNum <= hastaNum;
                        });
                        
                        inRange.forEach(caja => {
                            selections.push({ proveedor: provider, parihuela, caja });
                        });
                    }
                } else if (state.activeMethod === 3) {
                    // M√©todo m√∫ltiple
                    const checkboxes = document.querySelectorAll('#checkboxList input[type="checkbox"]:checked');
                    checkboxes.forEach(cb => {
                        selections.push({ proveedor: provider, parihuela, caja: cb.value });
                    });
                }

                return selections;
            }

            return {
                Auth,
                Data,
                LabelGenerator,
                Export,
                Analysis,
                History,
                UI,
                Utils,
                Verification,
                state,

                async generateLabels() {
                    const provider = state.selectedProvider;
                    const parihuela = state.selectedParihuela;

                    if (!provider) {
                        UI.showStatus('Selecciona un proveedor', 'error');
                        return;
                    }

                    if (!parihuela) {
                        UI.showStatus('Selecciona una parihuela', 'error');
                        return;
                    }

                    const selections = getSelections();
                    if (selections.length === 0) {
                        UI.showStatus('No hay selecciones v√°lidas', 'warning');
                        return;
                    }

                    try {
                        UI.showSpinner(true);
                        const count = await LabelGenerator.generate(selections);
                        
                        if (count > 0) {
                            const modoTexto = state.activeMode === 'concodigo' ? 'C√≥digo' : 'Original';
                            UI.showPreview(count, provider, state.activeMode);
                            UI.showStatus(`${count} r√≥tulos generados correctamente`, 'success');
                            UI.showToast(`‚úì ${count} r√≥tulos generados`);
                        } else {
                            UI.showStatus('No se pudieron generar r√≥tulos', 'error');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        UI.showStatus('Error: ' + error.message, 'error');
                    } finally {
                        UI.showSpinner(false);
                    }
                },

                clearPreview() {
                    state.generatedLabels = [];
                    UI.hidePreview();
                    UI.showToast('Vista limpiada');
                },

                printSingle(button) {
                    const card = button.closest('.rotulo-preview');
                    const printArea = card.querySelector('.rotulo');
                    
                    const printWindow = window.open('', '_blank');
                    const printStyles = `
                        @page { margin: 3pt 12pt; }
                        body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
                        .rotulo { max-width: 210mm; margin: 0 auto; background: white; border: 2pt solid #333; padding: 3pt 12pt; }
                        .rotulo-titulo { text-align: center; font-size: 14pt; font-weight: bold; padding: 0; margin: 0; }
                        .rotulo-info-table { width: 100%; margin: 0 auto; border-collapse: collapse; font-size: 9pt; }
                        .rotulo-info-table td { border: 1pt solid #333333; padding: 2pt 5pt; height: 20pt; }
                        .rotulo-info-header { background: #4472C4; color: #000000; font-weight: bold; text-align: center; font-size: 11pt; }
                        .rotulo-ubicacion-header { background: #E74C3C; color: #000000; font-weight: bold; text-align: center; font-size: 11pt; }
                        .rotulo-data-table { width: 100%; margin: 0 auto; border-collapse: collapse; font-size: 9pt; }
                        .rotulo-data-table td { border: 0.5pt solid #666666; padding: 2pt 5pt; height: 18pt; }
                        .rotulo-section-title { text-align: center; font-size: 11pt; font-weight: bold; padding: 3pt 0; margin: 3pt 0; }
                        .rotulo-producto-title { text-align: center; font-size: 10pt; font-weight: bold; padding: 2pt 0 1pt 0; }
                        .rotulo-codigo-table { width: 100%; margin: 0 auto; border-collapse: collapse; font-size: 9pt; }
                        .rotulo-codigo-table td { padding: 2pt; border: none; }
                        .rotulo-codigo-col2 { text-align: right; }
                        .rotulo-tallas-table { width: 100%; margin: 5pt auto; border-collapse: collapse; border: 1pt solid #333; font-size: 9pt; }
                        .rotulo-tallas-table th { background: #F0F0F0; border: 1pt solid #333; padding: 1pt; text-align: center; font-weight: bold; height: 20pt; }
                        .rotulo-tallas-table td { border: 1pt solid #333; padding: 1pt; text-align: center; height: 70pt; vertical-align: middle; font-size: 12pt; }
                        .rotulo-sticker-col { background: #FFFFFF; }
                    `;
                    
                    printWindow.document.write('<!DOCTYPE html>');
                    printWindow.document.write('<html><head>');
                    printWindow.document.write('<meta charset="UTF-8">');
                    printWindow.document.write('<title>Rotulo Lukers</title>');
                    printWindow.document.write('<style>' + printStyles + '</style>');
                    printWindow.document.write('</head><body>');
                    printWindow.document.write(printArea.innerHTML);
                    printWindow.document.write('<scr' + 'ipt>');
                    printWindow.document.write('window.onload = function() { setTimeout(function() { window.print(); }, 100); };');
                    printWindow.document.write('window.onafterprint = function() { window.close(); };');
                    printWindow.document.write('</scr' + 'ipt>');
                    printWindow.document.write('</body></html>');
                    printWindow.document.close();
                },

                printAll() {
                    if (state.generatedLabels.length === 0) {
                        UI.showStatus('No hay r√≥tulos para imprimir', 'warning');
                        return;
                    }

                    const printWindow = window.open('', '_blank');
                    const printStyles = `
                        @page { margin: 3pt 12pt; }
                        body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
                        .rotulo { max-width: 210mm; margin: 0 auto 20pt auto; background: white; border: 2pt solid #333; padding: 3pt 12pt; page-break-after: always; }
                        .rotulo:last-child { page-break-after: auto; }
                        .rotulo-titulo { text-align: center; font-size: 14pt; font-weight: bold; padding: 0; margin: 0; }
                        .rotulo-info-table { width: 100%; margin: 0 auto; border-collapse: collapse; font-size: 9pt; }
                        .rotulo-info-table td { border: 1pt solid #333333; padding: 2pt 5pt; height: 20pt; }
                        .rotulo-info-header { background: #4472C4; color: #000000; font-weight: bold; text-align: center; font-size: 11pt; }
                        .rotulo-ubicacion-header { background: #E74C3C; color: #000000; font-weight: bold; text-align: center; font-size: 11pt; }
                        .rotulo-data-table { width: 100%; margin: 0 auto; border-collapse: collapse; font-size: 9pt; }
                        .rotulo-data-table td { border: 0.5pt solid #666666; padding: 2pt 5pt; height: 18pt; }
                        .rotulo-section-title { text-align: center; font-size: 11pt; font-weight: bold; padding: 3pt 0; margin: 3pt 0; }
                        .rotulo-producto-title { text-align: center; font-size: 10pt; font-weight: bold; padding: 2pt 0 1pt 0; }
                        .rotulo-codigo-table { width: 100%; margin: 0 auto; border-collapse: collapse; font-size: 9pt; }
                        .rotulo-codigo-table td { padding: 2pt; border: none; }
                        .rotulo-codigo-col2 { text-align: right; }
                        .rotulo-tallas-table { width: 100%; margin: 5pt auto; border-collapse: collapse; border: 1pt solid #333; font-size: 9pt; }
                        .rotulo-tallas-table th { background: #F0F0F0; border: 1pt solid #333; padding: 1pt; text-align: center; font-weight: bold; height: 20pt; }
                        .rotulo-tallas-table td { border: 1pt solid #333; padding: 1pt; text-align: center; height: 70pt; vertical-align: middle; font-size: 12pt; }
                        .rotulo-sticker-col { background: #FFFFFF; }
                    `;
                    
                    printWindow.document.write('<!DOCTYPE html>');
                    printWindow.document.write('<html><head>');
                    printWindow.document.write('<meta charset="UTF-8">');
                    printWindow.document.write('<title>Rotulos Lukers - Impresi√≥n M√∫ltiple</title>');
                    printWindow.document.write('<style>' + printStyles + '</style>');
                    printWindow.document.write('</head><body>');
                    
                    const rotulos = document.querySelectorAll('.rotulo-preview .rotulo');
                    rotulos.forEach(rotulo => {
                        printWindow.document.write(rotulo.outerHTML);
                    });
                    
                    printWindow.document.write('<scr' + 'ipt>');
                    printWindow.document.write('window.onload = function() { setTimeout(function() { window.print(); }, 200); };');
                    printWindow.document.write('window.onafterprint = function() { window.close(); };');
                    printWindow.document.write('</scr' + 'ipt>');
                    printWindow.document.write('</body></html>');
                    printWindow.document.close();
                },
            };
        })();

        // EXPONER APP GLOBALMENTE
        window.App = App;

        // FUNCIONES GLOBALES PARA GOOGLE API
        window.gapiLoaded = function() {
            console.log('GAPI loaded');
            gapi.load('client', App.Auth.initializeGapiClient);
        };

        window.gisLoaded = function() {
            console.log('GIS loaded');
            App.state.gisInited = true;
            // Llamar funci√≥n interna si existe
            if (App.Auth && App.Auth.maybeEnableButtons) {
                App.Auth.maybeEnableButtons();
            }
        };


        // EVENT LISTENERS
        document.addEventListener('DOMContentLoaded', () => {
            // Cerrar men√∫ al hacer click fuera
            document.addEventListener('click', (e) => {
                const userMenu = document.getElementById('userMenuBtn');
                const dropdown = document.getElementById('userDropdown');
                
                if (userMenu && dropdown && 
                    !userMenu.contains(e.target) && 
                    !dropdown.contains(e.target)) {
                    window.App.UI.closeUserMenu();
                }
            });

            // Cerrar modales al hacer click fuera
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });

            // Login admin con Enter
            const adminPass = document.getElementById('adminPass');
            if (adminPass) {
                adminPass.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        window.App.Auth.adminLogin();
                    }
                });
            }
            
            // NUEVO: Selector de proveedor
            document.getElementById('proveedorSelect').addEventListener('change', (e) => {
                const provider = e.target.value;
                
                if (provider && window.App.state.data) {
                    window.App.state.selectedProvider = provider;
                    window.App.UI.loadParihuelas(provider);
                } else {
                    window.App.UI.resetSelections();
                }
            });

            // Botones de modo
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.mode-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    this.classList.add('active');
                    window.App.state.activeMode = this.dataset.mode;
                    window.App.UI.showToast('Modo: ' + this.textContent);
                });
            });
        });
    </script>
    
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
